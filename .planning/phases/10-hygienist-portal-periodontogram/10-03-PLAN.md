---
phase: 10-hygienist-portal-periodontogram
plan: 03
type: execute
wave: 2
depends_on: ["10-01", "10-02"]
files_modified:
  - apps/web/src/components/odontogram/perio/line-graph.tsx
  - apps/web/src/components/odontogram/perio/perio-classification.ts
  - apps/web/src/components/odontogram/modes/perio-mode.tsx
  - apps/web/src/app/api/patients/[id]/periodontal/route.ts
autonomous: true
requirements: [CLIN-06, CLIN-07]

must_haves:
  truths:
    - "Periodontogram displays SVG line graph overlay on tooth silhouettes with color-coded severity"
    - "Historical comparison overlays current vs previous measurements in different colors"
    - "Auto-classification shows periodontal Stage I-IV and Grade A-C"
    - "Missing teeth shown as gaps, implants shown with threaded screw icon"
    - "Separate buccal and palatal/lingual rows per jaw"
    - "Per-session free-text note can be saved"
  artifacts:
    - path: "apps/web/src/components/odontogram/perio/line-graph.tsx"
      provides: "SVG line graph overlay with color zones"
      contains: "polyline"
    - path: "apps/web/src/components/odontogram/perio/perio-classification.ts"
      provides: "Auto-classification function"
      contains: "classifyPeriodontalStage"
  key_links:
    - from: "apps/web/src/components/odontogram/perio/line-graph.tsx"
      to: "PerioToothData"
      via: "reads probing depths to generate SVG points"
      pattern: "probingDepth"
    - from: "apps/web/src/components/odontogram/modes/perio-mode.tsx"
      to: "line-graph.tsx"
      via: "renders PerioLineGraph component"
      pattern: "PerioLineGraph"
---

<objective>
SVG line graph visualization for the periodontogram with color-coded severity zones, historical comparison overlay, auto-classification per 2018 EFP/AAP, and per-session notes.

Purpose: Professional periodontal charting visualization that meets clinical standards.
Output: Line graph component, classification logic, enhanced perio mode with history and notes.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-hygienist-portal-periodontogram/10-CONTEXT.md
@.planning/phases/10-hygienist-portal-periodontogram/10-RESEARCH.md
@.planning/phases/10-hygienist-portal-periodontogram/10-01-SUMMARY.md
@.planning/phases/10-hygienist-portal-periodontogram/10-02-SUMMARY.md
@apps/web/src/components/odontogram/modes/perio-mode.tsx
@apps/web/src/components/odontogram/perio/indicator-rows.tsx
@packages/shared-types/src/odontogram.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: SVG line graph + classification + history API</name>
  <files>apps/web/src/components/odontogram/perio/line-graph.tsx, apps/web/src/components/odontogram/perio/perio-classification.ts, apps/web/src/app/api/patients/[id]/periodontal/route.ts</files>
  <action>
1. **Create `perio-classification.ts`:**
   - `classifyPeriodontalStage(maxProbingDepth: number, teethLostDueToPerio: number): string` — returns 'Stage I' through 'Stage IV' per 2018 EFP/AAP criteria (see RESEARCH.md code example)
   - `classifyPeriodontalGrade(boneLossRate: number, isSmoker: boolean, hasDiabetes: boolean): string` — returns 'Grade A' through 'Grade C'. Default to Grade B if smoking/diabetes unknown.
   - `calculateBOPPercentage(perioData: Record<string, PerioToothData>): number` — count bleeding=true sites / total sites * 100
   - `calculateAverageProbing(perioData: Record<string, PerioToothData>): number` — mean of all probing depths
   - `getPerioSummary(perioData, teethLost?, isSmoker?, hasDiabetes?)` — returns `{ stage, grade, bopPercent, avgProbing, maxProbing }`

2. **Create `line-graph.tsx` — `PerioLineGraph` component:**
   - Props: `teeth: number[]` (FDI numbers in order), `perioData: Record<string, PerioToothData>`, `side: 'buccal' | 'palatal'`, `previousData?: Record<string, PerioToothData>` (for historical overlay), `toothWidth: number` (default 42)
   - Renders an SVG overlay with:
     - Background severity zones: horizontal bands at y-levels for green (0-3mm), yellow (3-5mm), red (5+ mm) using semi-transparent fills
     - **Current data:** SVG `<polyline>` connecting all 3 site values per tooth across all teeth. Points: `x = toothIdx * toothWidth + siteIdx * (toothWidth/3) + toothWidth/6`, `y = (depth/maxScale) * graphHeight`. Stroke: solid line, 2px, color based on depth at each point (use gradient or segment coloring). Fill below line with opacity 0.15.
     - **Previous data (if provided):** Same polyline but with dashed stroke (`strokeDasharray="4 3"`), lower opacity (0.4), slightly different hue
     - Missing teeth: skip points (gap in the line), show a gray dashed vertical zone
     - Implants: show a small threaded-screw SVG icon (simple: two parallel lines with horizontal hash marks) at the tooth position instead of the standard tooth silhouette
   - Graph height: ~80px per row. Max scale: 12mm.
   - Add a small legend: solid line = current, dashed = previous, color = severity

3. **Create API `apps/web/src/app/api/patients/[id]/periodontal/route.ts`:**
   - GET: Fetch all PeriodontalChart records for patient, ordered by createdAt DESC, include author name. Return array of `{ id, chartData, sessionNote, createdAt, authorName }`.
   - This allows the perio mode to load historical charts for comparison.
  </action>
  <verify>Run `pnpm --filter @dentflow/web build` — no errors. Verify classification functions return correct stages for test inputs.</verify>
  <done>SVG line graph component renders probing depth lines with color-coded severity. Historical overlay works with dashed lines. Classification functions return correct Stage/Grade. API returns historical charts.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate line graph + history + notes into perio mode</name>
  <files>apps/web/src/components/odontogram/modes/perio-mode.tsx</files>
  <action>
Integrate the line graph, historical comparison, classification, and session notes into the existing perio mode:

1. **Layout restructure** (per CONTEXT.md — separate buccal and palatal rows per jaw):
   Upper jaw section:
   - Palatal indicator dots (existing)
   - Palatal probing numbers (existing)
   - **PerioLineGraph** for palatal side (NEW)
   - Tooth silhouettes row (existing) — for missing teeth show a gap (empty cell with light dashed border). For implants (data.implant===true), replace tooth silhouette with a simple implant icon SVG.
   - **PerioLineGraph** for buccal side (NEW)
   - Tooth numbers (existing)
   - Buccal probing numbers (existing)
   - Buccal indicator dots (existing)

   Lower jaw: same structure, mirrored.

2. **Historical comparison:**
   - Add a dropdown/select at the top: "Vergelijk met: [datum sessie]" listing previous perio sessions (fetched from new API)
   - When a previous session is selected, pass its chartData as `previousData` prop to all PerioLineGraph instances
   - Default: no comparison (only current data shown)

3. **Classification display:**
   - Add a summary bar at the top of perio mode showing: Stage badge, Grade badge, BOP%, Avg Probing Depth
   - Use glass card styling: `bg-white/[0.06] backdrop-blur-2xl border border-white/[0.12] rounded-2xl p-3`
   - Color-code: Stage I-II green, Stage III yellow, Stage IV red

4. **Session note:**
   - Add a free-text textarea at the bottom of perio mode: "Sessie notitie"
   - Glass input styling
   - Saved along with the perio chart data (uses the `sessionNote` field added to PeriodontalChart in plan 01)

5. **Print/PDF:**
   - Add a "Afdrukken" (Print) button that calls `window.print()`
   - Add `@media print` styles: hide sidebar, toolbar, scrollbars; show full periodontogram on white background
  </action>
  <verify>Run `pnpm --filter @dentflow/web build` — no errors. Open perio mode — line graphs visible above/below tooth rows. Select historical session — dashed overlay appears. Classification badges show at top. Session note textarea renders. Print button triggers print dialog.</verify>
  <done>Perio mode shows SVG line graphs with color-coded severity, historical comparison overlay, auto-classification badges, session notes, and print support.</done>
</task>

</tasks>

<verification>
- `pnpm --filter @dentflow/web build` passes
- Line graph renders across all teeth with color zones
- Historical comparison shows dashed overlay when previous session selected
- Classification badges display Stage and Grade
- Missing teeth show as gaps, implants show distinct icon
- Session note saves with chart
</verification>

<success_criteria>
Professional periodontogram visualization with SVG line graphs, severity color coding, historical comparison, auto-classification, session notes, and print support.
</success_criteria>

<output>
After completion, create `.planning/phases/10-hygienist-portal-periodontogram/10-03-SUMMARY.md`
</output>
