---
phase: 10-hygienist-portal-periodontogram
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/components/odontogram/perio/probing-panel.tsx
  - apps/web/src/components/odontogram/perio/voice-input.tsx
  - apps/web/src/components/odontogram/modes/perio-mode.tsx
autonomous: true
requirements: [CLIN-06, HYG-02]

must_haves:
  truths:
    - "User can enter probing depth, recession, BOP, plaque, mobility, furcation, suppuration, mucogingival junction, keratinized tissue width for any tooth"
    - "User can use voice input saying 'tooth 16: 3 2 4 3 2 3' to enter probing depths"
    - "CAL is auto-calculated and displayed (not editable)"
    - "All new fields have sensible defaults when reading old data (backward compatible)"
  artifacts:
    - path: "apps/web/src/components/odontogram/perio/probing-panel.tsx"
      provides: "Extended probing panel with all measurement fields"
      contains: "suppuration"
    - path: "apps/web/src/components/odontogram/perio/voice-input.tsx"
      provides: "Voice input component using Web Speech API"
      contains: "webkitSpeechRecognition"
  key_links:
    - from: "apps/web/src/components/odontogram/perio/voice-input.tsx"
      to: "probing-panel.tsx"
      via: "onResult callback updates tooth probing data"
      pattern: "parsePerioVoiceInput"
---

<objective>
Extend the perio probing panel with all required measurement fields (suppuration, mucogingival junction, keratinized tissue width, implant/missing flags) and add voice input for hands-free perio data entry.

Purpose: Complete perio data entry meets clinical requirements for full periodontal charting.
Output: Extended probing panel, voice input component, updated perio mode.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-hygienist-portal-periodontogram/10-CONTEXT.md
@.planning/phases/10-hygienist-portal-periodontogram/10-RESEARCH.md
@apps/web/src/components/odontogram/perio/probing-panel.tsx
@apps/web/src/components/odontogram/modes/perio-mode.tsx
@apps/web/src/components/odontogram/perio/indicator-rows.tsx
@packages/shared-types/src/odontogram.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend probing panel with all measurement fields</name>
  <files>apps/web/src/components/odontogram/perio/probing-panel.tsx</files>
  <action>
Extend the existing probing panel to include ALL required measurements. The panel is shown when a tooth is selected in perio mode.

Add the following sections to the side panel (below existing probing depth and gingival margin inputs):

1. **Suppuration** — 3 toggle buttons per side (buccal/palatal), same style as existing bleeding/plaque/pus toggles
2. **Mucogingival Junction** — 3 number inputs per side (mm from gingival margin), same numpad-style entry as probing depth
3. **Keratinized Tissue Width** — 3 number inputs per side (mm)
4. **CAL (Clinical Attachment Level)** — DISPLAY ONLY, auto-calculated: `probingDepth + Math.abs(gingivalMargin)` for each of 6 sites. Show as a read-only row with calculated values. Use a slightly different background to indicate it's computed.
5. **Implant** — single toggle checkbox at tooth level (not per-site)
6. **Missing** — single toggle checkbox at tooth level. When checked, disable all other inputs for this tooth.

Read new fields with fallback defaults for backward compatibility:
- `data?.suppuration ?? [false, false, false]`
- `data?.mucogingivalJunction ?? [0, 0, 0]`
- `data?.keratinizedTissueWidth ?? [0, 0, 0]`
- `data?.implant ?? false`
- `data?.missing ?? false`

Use the existing glass UI styling from the panel. Group measurements into collapsible sections to avoid overwhelming the panel: "Basic" (probing, recession, BOP, plaque — always open) and "Advanced" (suppuration, MGJ, KTW, mobility, furcation — collapsed by default, expandable).

Keep the existing save mechanism — just extend the data object being saved with the new fields.
  </action>
  <verify>Run `pnpm --filter @dentflow/web build` — no errors. Open perio mode, select a tooth, verify all new fields appear in side panel. Verify CAL auto-calculates.</verify>
  <done>Probing panel shows all measurement fields. CAL auto-calculated. Old perio data loads without errors (backward compatible).</done>
</task>

<task type="auto">
  <name>Task 2: Voice input for perio data entry</name>
  <files>apps/web/src/components/odontogram/perio/voice-input.tsx, apps/web/src/components/odontogram/modes/perio-mode.tsx</files>
  <action>
Create `voice-input.tsx` — a client component for voice-driven perio data entry:

1. **useSpeechRecognition hook:**
   - Feature-detect: `'webkitSpeechRecognition' in window || 'SpeechRecognition' in window`
   - If not supported, return `{ isSupported: false }`
   - Create recognition instance with `lang: 'nl-NL'`, `continuous: false`, `interimResults: true`
   - On final result, parse transcript with `parsePerioVoiceInput()`
   - Show interim results as live text preview

2. **parsePerioVoiceInput(transcript):**
   - Match pattern: `(?:tooth|tand)\s*(\d{2})\s*:?\s*([\d\s]+)` (case insensitive)
   - Extract tooth FDI number and exactly 6 space-separated values
   - Return `{ tooth: number, values: [number x 6] }` or null
   - Values map to buccal probing depths [mesial, mid, distal] then palatal [mesial, mid, distal]

3. **VoiceInputButton component:**
   - Mic icon button (lucide-react `Mic` / `MicOff`)
   - Glass styling: `bg-white/[0.06] backdrop-blur-2xl border border-white/[0.12] rounded-2xl`
   - Red pulsing ring when listening (`animate-pulse ring-2 ring-red-500`)
   - Show live transcript preview below button
   - Show parsed result confirmation: "Tand 16: 3 2 4 3 2 3 ✓" or "Niet herkend ✗"
   - If not supported, show tooltip: "Spraakherkenning niet beschikbaar in deze browser"

4. **Integrate into perio-mode.tsx:**
   - Add VoiceInputButton to the perio mode toolbar (top area near existing controls)
   - When voice input returns a valid result: auto-select the specified tooth, populate buccal (first 3) and palatal (last 3) probing depths
   - After populating, keep the tooth selected so user can review/adjust in the side panel
  </action>
  <verify>Run `pnpm --filter @dentflow/web build` — no errors. Open perio mode in Chrome, verify mic button appears. Click it, say "tooth 16: 3 2 4 3 2 3" — values should populate.</verify>
  <done>Voice input button visible in perio mode. Voice recognition parses "tooth NN: X X X X X X" format. Parsed values auto-populate probing depths for the specified tooth. Unsupported browsers show fallback message.</done>
</task>

</tasks>

<verification>
- `pnpm --filter @dentflow/web build` passes
- Probing panel shows all 9 measurement types + CAL display + implant/missing toggles
- Voice input button renders in perio mode toolbar
- Old perio data loads without errors
</verification>

<success_criteria>
Full periodontal data entry with all required measurements (probing depth, recession, BOP, plaque, mobility, furcation, suppuration, MGJ, KTW) plus voice input for hands-free charting. CAL auto-calculated. Backward compatible with existing data.
</success_criteria>

<output>
After completion, create `.planning/phases/10-hygienist-portal-periodontogram/10-02-SUMMARY.md`
</output>
