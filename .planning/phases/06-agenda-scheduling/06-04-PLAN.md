---
phase: 06-agenda-scheduling
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/lib/sms/service.ts
  - apps/web/src/app/api/cron/appointment-reminders/route.ts
autonomous: true
requirements: [AGND-04]
user_setup:
  - service: twilio
    why: "SMS and WhatsApp appointment reminders"
    env_vars:
      - name: TWILIO_ACCOUNT_SID
        source: "Twilio Console -> Account Info -> Account SID"
      - name: TWILIO_AUTH_TOKEN
        source: "Twilio Console -> Account Info -> Auth Token"
      - name: TWILIO_PHONE_NUMBER
        source: "Twilio Console -> Phone Numbers -> Active Numbers (buy a number with SMS capability)"
      - name: TWILIO_WHATSAPP_NUMBER
        source: "Twilio Console -> Messaging -> WhatsApp Senders (format: whatsapp:+14155238886)"
    dashboard_config:
      - task: "Register WhatsApp message template for appointment reminders"
        location: "Twilio Console -> Messaging -> Content Template Builder"

must_haves:
  truths:
    - "Cron endpoint sends SMS reminders to patients with phone numbers"
    - "Cron endpoint sends WhatsApp reminders when configured"
    - "Email reminders continue to work as before"
    - "System gracefully degrades when Twilio is not configured"
  artifacts:
    - path: "apps/web/src/lib/sms/service.ts"
      provides: "Twilio SMS and WhatsApp send functions"
      min_lines: 40
      exports: ["sendSms", "sendWhatsApp"]
    - path: "apps/web/src/app/api/cron/appointment-reminders/route.ts"
      provides: "Multi-channel reminder cron"
      contains: "sendSms"
  key_links:
    - from: "apps/web/src/app/api/cron/appointment-reminders/route.ts"
      to: "apps/web/src/lib/sms/service.ts"
      via: "import sendSms, sendWhatsApp"
      pattern: "sendSms|sendWhatsApp"
    - from: "apps/web/src/lib/sms/service.ts"
      to: "twilio"
      via: "Twilio SDK client"
      pattern: "twilio"
---

<objective>
Add SMS and WhatsApp appointment reminders alongside existing email reminders.

Purpose: Patients should receive reminders via their preferred channel. Email already works via Resend. This adds Twilio SMS and WhatsApp as additional channels.

Output: SMS/WhatsApp service module + updated cron endpoint for multi-channel reminders.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/web/src/lib/email/service.ts
@apps/web/src/lib/email/triggers.ts
@apps/web/src/app/api/cron/appointment-reminders/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Twilio SMS/WhatsApp service and update reminder cron</name>
  <files>
    apps/web/src/lib/sms/service.ts
    apps/web/src/app/api/cron/appointment-reminders/route.ts
  </files>
  <action>
    1. Create `apps/web/src/lib/sms/service.ts`:
       - Import `twilio` SDK.
       - Create client lazily: `const getClient = () => twilio(process.env.TWILIO_ACCOUNT_SID, process.env.TWILIO_AUTH_TOKEN)`.
       - `isTwilioConfigured()`: returns `true` if `TWILIO_ACCOUNT_SID` and `TWILIO_AUTH_TOKEN` are set.
       - `sendSms(to: string, body: string)`: sends SMS via `client.messages.create({ body, to, from: process.env.TWILIO_PHONE_NUMBER })`. Returns `{ success: boolean, error?: string }`. Catch errors gracefully.
       - `sendWhatsApp(to: string, body: string)`: sends WhatsApp via `client.messages.create({ body, to: 'whatsapp:' + to, from: 'whatsapp:' + process.env.TWILIO_WHATSAPP_NUMBER })`. Returns same shape. Check `TWILIO_WHATSAPP_NUMBER` is set.
       - `sendAppointmentReminderSms(patientName: string, appointmentDate: string, appointmentTime: string, practiceName: string, phone: string)`: formats a Dutch reminder message and calls `sendSms`. Message: "Beste {patientName}, u heeft morgen een afspraak bij {practiceName} om {appointmentTime}. Neem contact op als u wilt afzeggen."
       - Same for WhatsApp variant.

    2. Update `apps/web/src/app/api/cron/appointment-reminders/route.ts`:
       - Read the existing implementation to understand the current email-only flow.
       - After the existing email sending logic, add SMS and WhatsApp sending:
         - For each appointment due for reminder, check if patient has a phone number (`patient.phone` or `patient.mobilePhone`).
         - If phone exists and Twilio is configured (`isTwilioConfigured()`), call `sendAppointmentReminderSms(...)`.
         - If WhatsApp number is configured, also call the WhatsApp variant.
         - Log results. Do NOT block email sending if SMS/WhatsApp fails.
       - Keep `reminderSentAt` update as-is (it already marks that a reminder was sent regardless of channel).
       - Add SMS/WhatsApp send counts to the response summary.
       - If Twilio is not configured, skip SMS/WhatsApp silently (graceful degradation — log a note but don't error).

    Dutch reminder message format:
    ```
    Beste [naam], u heeft morgen om [tijd] een afspraak bij [praktijk]. Neem contact op als u wilt afzeggen.
    ```
  </action>
  <verify>
    Run `pnpm --filter @dentflow/web build` — must succeed.
    Without Twilio env vars: cron still sends emails, no errors.
    With Twilio env vars: cron sends SMS + WhatsApp alongside email.
  </verify>
  <done>
    SMS and WhatsApp reminder functions exist. Cron endpoint sends multi-channel reminders. Graceful degradation when Twilio is not configured. Email reminders unaffected. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @dentflow/web build` passes
2. `src/lib/sms/service.ts` exports `sendSms`, `sendWhatsApp`, `isTwilioConfigured`
3. Cron endpoint handles multi-channel sending
4. No errors when Twilio env vars missing
5. Existing email reminders continue working
</verification>

<success_criteria>
- Twilio SMS/WhatsApp service module created
- Cron endpoint sends reminders via all configured channels
- Graceful degradation without Twilio credentials
- Dutch reminder messages
</success_criteria>

<output>
After completion, create `.planning/phases/06-agenda-scheduling/06-04-SUMMARY.md`
</output>
