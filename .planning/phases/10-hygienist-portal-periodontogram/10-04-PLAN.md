---
phase: 10-hygienist-portal-periodontogram
plan: 04
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - apps/web/src/app/(dashboard)/patients/[id]/notes/page.tsx
  - apps/web/src/app/api/patients/[id]/clinical-notes/route.ts
  - apps/web/src/app/api/patients/[id]/clinical-notes/[noteId]/flags/route.ts
  - apps/web/src/components/patient/hygienist-note-form.tsx
  - apps/web/src/lib/ai/hygiene-shorthand.ts
autonomous: true
requirements: [HYG-03, HYG-05]

must_haves:
  truths:
    - "Patient page shows separate Dentist Notes and Hygienist Notes tabs"
    - "Each role can only edit their own notes (read-only cross-role)"
    - "Hygienist notes use custom format: oral hygiene score, BOP%, home care instructions, compliance, next visit"
    - "AI shorthand expands hygiene abbreviations (sc=scaling, rp=root planing, fi=fluoride)"
    - "Flag system allows fixed flags + free-text comment on any note"
    - "Flagged notes trigger in-app Notification to the other role"
    - "Perio session summaries auto-appear as cards in Hygienist Notes"
  artifacts:
    - path: "apps/web/src/app/(dashboard)/patients/[id]/notes/page.tsx"
      provides: "Tabbed clinical notes view"
      contains: "Tandarts Notities"
    - path: "apps/web/src/components/patient/hygienist-note-form.tsx"
      provides: "Custom hygienist note form"
      contains: "oralHygieneScore"
    - path: "apps/web/src/lib/ai/hygiene-shorthand.ts"
      provides: "AI shorthand expansion for hygiene vocab"
      contains: "scaling"
  key_links:
    - from: "apps/web/src/app/(dashboard)/patients/[id]/notes/page.tsx"
      to: "/api/patients/[id]/clinical-notes"
      via: "fetch with noteType filter"
      pattern: "noteType.*HYGIENE"
    - from: "apps/web/src/app/api/patients/[id]/clinical-notes/[noteId]/flags/route.ts"
      to: "prisma.notification.create"
      via: "creates notification when flag added"
      pattern: "notification.*create"
---

<objective>
Shared clinical notes with separate Dentist/Hygienist tabs, custom hygienist note format, AI shorthand expansion, flag system with notifications, and perio session auto-sync.

Purpose: Enable clinical communication between dentist and hygienist on shared patients.
Output: Tabbed notes page, hygienist note form, flag system, AI shorthand, perio summary sync.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-hygienist-portal-periodontogram/10-CONTEXT.md
@.planning/phases/10-hygienist-portal-periodontogram/10-RESEARCH.md
@.planning/phases/10-hygienist-portal-periodontogram/10-01-SUMMARY.md
@packages/database/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Clinical notes API + flag system + AI shorthand</name>
  <files>apps/web/src/app/api/patients/[id]/clinical-notes/route.ts, apps/web/src/app/api/patients/[id]/clinical-notes/[noteId]/flags/route.ts, apps/web/src/lib/ai/hygiene-shorthand.ts</files>
  <action>
1. **Update/create `clinical-notes/route.ts`:**
   - GET: Accept `?type=HYGIENE|SOAP|PROGRESS` query param. Return notes filtered by noteType. Include `author` (name, role), `flags` (with createdBy). For HYGIENE notes that have a `perioChartId` in their JSON content, mark them as perio summary cards.
   - POST: Create clinical note. If noteType=HYGIENE, validate content is JSON with fields: oralHygieneScore (1-5), bopPercentage (number), homeCareInstructions (string), complianceNotes (string), nextVisitRecommendation (string). Enforce role check: only HYGIENIST can create HYGIENE notes, only DENTIST can create SOAP/PROGRESS notes. REFERRAL/CONSENT: either role.

2. **Create `clinical-notes/[noteId]/flags/route.ts`:**
   - POST: Create NoteFlag. Body: `{ flagType: string, comment?: string }`. Validate flagType is one of: 'Needs follow-up', 'Noted', 'Urgent', 'Discuss at next visit'.
   - After creating flag, create a Notification record for the "other role" users in the same practice:
     - If flagger is DENTIST, notify all HYGIENIST users in practice
     - If flagger is HYGIENIST, notify all DENTIST users in practice
     - Notification content: `"${flagType} op notitie van ${authorName} voor ${patientName}"`
   - GET: Return all flags for a note.
   - DELETE `[flagId]`: Delete a flag (only creator or admin can delete).

3. **Create `hygiene-shorthand.ts`:**
   - Export `HYGIENE_SHORTHAND_MAP`: `{ 'sc': 'scaling', 'rp': 'root planing', 'fi': 'fluoride applicatie', 'pol': 'polijsten', 'dh': 'mondhygiëne instructie', 'irr': 'irrigatie', 'chl': 'chloorhexidine', 'mhi': 'mondhygiëne instructie', 'pf': 'pocket flushing' }`
   - Export `expandHygieneShorthand(text: string): string` — replaces shorthand tokens (word-boundary matched) with full terms
   - Export `getShorthandHints(): { short: string, full: string }[]` — returns list for UI display
  </action>
  <verify>Run `pnpm --filter @dentflow/web build` — no errors.</verify>
  <done>Clinical notes API supports type filtering and role-based creation. Flag system creates notifications cross-role. AI shorthand expander works.</done>
</task>

<task type="auto">
  <name>Task 2: Tabbed notes UI + hygienist note form + flag UI</name>
  <files>apps/web/src/app/(dashboard)/patients/[id]/notes/page.tsx, apps/web/src/components/patient/hygienist-note-form.tsx</files>
  <action>
1. **Create or update `patients/[id]/notes/page.tsx`:**
   - Two tabs: "Tandarts Notities" and "Mondhygiënist Notities"
   - Glass tab styling: `bg-white/[0.06] backdrop-blur-2xl border border-white/[0.12] rounded-2xl`
   - Each tab fetches notes by type: Tandarts = SOAP+PROGRESS, Mondhygiënist = HYGIENE
   - **Role-based edit controls:**
     - If logged-in user is HYGIENIST: Hygienist tab shows "Nieuwe notitie" button, Dentist tab is read-only (no create button)
     - If logged-in user is DENTIST: Dentist tab shows "Nieuwe notitie" button, Hygienist tab is read-only
   - **Note cards:** Each note rendered as a glass card showing: date, author name + role badge, content. For HYGIENE notes, render structured fields (score, BOP%, instructions) not raw JSON.
   - **Perio summary cards:** HYGIENE notes with perioChartId show a distinctive card: date, BOP%, avg probing depth, diagnosis, session note text, and a "Bekijk chart" link (navigates to perio mode with that chart loaded)
   - **Flag UI on each note card:**
     - Small flag icon button in card header
     - Click opens dropdown with 4 fixed flags + free-text comment field
     - Existing flags shown as colored badges on the card: Urgent=red, 'Needs follow-up'=orange, 'Discuss at next visit'=yellow, 'Noted'=blue
     - Flag creator name shown on hover

2. **Create `hygienist-note-form.tsx`:**
   - Form fields: Oral Hygiene Score (1-5 star/number selector), BOP% (number input), Home Care Instructions (textarea with AI shorthand support), Compliance Notes (textarea), Next Visit Recommendation (textarea)
   - **AI shorthand integration:** In textareas, show a small info icon that reveals shorthand hints on hover (sc=scaling, etc.). On form submit, auto-expand shorthands in text fields using `expandHygieneShorthand()`.
   - Glass form styling matching patient portal patterns
   - Submit creates HYGIENE type ClinicalNote with structured JSON content

3. **Add "Notities" to patient page navigation** if not already present. Ensure it appears in the patient detail page tabs/nav.
  </action>
  <verify>Run `pnpm --filter @dentflow/web build` — no errors. Navigate to patient page, see Notes tab. Verify two sub-tabs. Create a hygienist note as hygienist — structured form appears. Add a flag — badge appears, notification created.</verify>
  <done>Tabbed notes view with role-based editing. Hygienist note form with structured fields and AI shorthand. Flag system with visual badges and cross-role notifications. Perio summary cards auto-displayed.</done>
</task>

</tasks>

<verification>
- `pnpm --filter @dentflow/web build` passes
- Two tabs visible on patient notes page
- Hygienist can create HYGIENE notes but not SOAP notes
- Dentist can create SOAP notes but not HYGIENE notes
- Flags appear as colored badges, trigger notifications
- AI shorthand expands on submit
</verification>

<success_criteria>
Shared clinical notes with proper role separation, custom hygienist format, AI shorthand expansion, flag system with cross-role notifications, and perio session summary cards.
</success_criteria>

<output>
After completion, create `.planning/phases/10-hygienist-portal-periodontogram/10-04-SUMMARY.md`
</output>
