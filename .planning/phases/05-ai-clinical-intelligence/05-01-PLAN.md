---
phase: 05-ai-clinical-intelligence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/lib/ai/gemini-client.ts
  - apps/web/src/app/api/ai/expand-notes/route.ts
  - apps/web/src/app/api/ai/suggest-treatment/route.ts
autonomous: true
requirements: [AI-04, AI-05]

must_haves:
  truths:
    - "POST /api/ai/expand-notes accepts shorthand Dutch dental text and returns structured expanded clinical note"
    - "POST /api/ai/suggest-treatment accepts patientId and returns treatment suggestions based on odontogram data"
    - "Both endpoints run PII guard before calling Gemini"
    - "Both endpoints require auth via withAuth"
    - "AI-suggested NZa codes are validated against NzaCode DB table"
  artifacts:
    - path: "apps/web/src/lib/ai/gemini-client.ts"
      provides: "Shared Gemini call wrapper reusable across all AI endpoints"
      exports: ["callGemini"]
    - path: "apps/web/src/app/api/ai/expand-notes/route.ts"
      provides: "AI-04 shorthand note expansion endpoint"
      exports: ["POST"]
    - path: "apps/web/src/app/api/ai/suggest-treatment/route.ts"
      provides: "AI-05 treatment suggestion endpoint"
      exports: ["POST"]
  key_links:
    - from: "apps/web/src/app/api/ai/expand-notes/route.ts"
      to: "apps/web/src/lib/ai/gemini-client.ts"
      via: "import callGemini"
      pattern: "callGemini"
    - from: "apps/web/src/app/api/ai/suggest-treatment/route.ts"
      to: "apps/web/src/lib/ai/gemini-client.ts"
      via: "import callGemini"
      pattern: "callGemini"
    - from: "apps/web/src/app/api/ai/suggest-treatment/route.ts"
      to: "prisma.tooth"
      via: "database query for odontogram data"
      pattern: "prisma\\.tooth\\.findMany"
---

<objective>
Build shared Gemini client and both AI API endpoints for clinical note expansion (AI-04) and treatment suggestion (AI-05).

Purpose: Backend foundation for AI clinical intelligence features.
Output: Three files - shared Gemini client, expand-notes endpoint, suggest-treatment endpoint.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/web/src/app/api/ai/analyze-notes/route.ts
@apps/web/src/lib/ai/pii-guard.ts
@apps/web/src/app/api/clinical-notes/route.ts
@apps/web/src/app/api/treatment-plans/route.ts
@packages/database/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared Gemini client and expand-notes endpoint</name>
  <files>apps/web/src/lib/ai/gemini-client.ts, apps/web/src/app/api/ai/expand-notes/route.ts</files>
  <action>
1. Create `lib/ai/gemini-client.ts`:
   - Export `callGemini(prompt: string, options?: { maxTokens?: number }): Promise<string>` that wraps the Gemini fetch call pattern from analyze-notes (GEMINI_URL, API key check, temperature=0, topP=0.8, responseMimeType='application/json', maxOutputTokens default 4096).
   - Export `parseGeminiJson<T>(response: string): T` that safely parses JSON from Gemini response text.
   - Throw ApiError on API key missing or Gemini HTTP error.

2. Create `api/ai/expand-notes/route.ts`:
   - POST endpoint accepting `{ shorthand: string, format?: 'free' | 'soap' }`.
   - `withAuth(request)` for authentication.
   - `assertNoPII(shorthand)` before sending to Gemini.
   - Build Dutch dental prompt that:
     - Includes the abbreviation dictionary from analyze-notes (lines 43-67 — copy the same abbreviations).
     - Instructs: "Expand the shorthand into proper Dutch clinical documentation. Only expand abbreviations and improve formatting. Do NOT add findings or diagnoses not present in the original."
     - If format='soap', structure output as `{ subjective, objective, assessment, plan }`.
     - If format='free' (default), structure as `{ bevindingen, diagnose, behandeling, afspraken }`.
   - Call `callGemini(prompt)`, parse with `parseGeminiJson`.
   - Return `{ expanded: {...}, originalShorthand: shorthand, aiGenerated: true }`.
  </action>
  <verify>
`pnpm --filter @dentflow/web build` succeeds. Manual curl test:
```
curl -X POST http://localhost:3000/api/ai/expand-notes \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"shorthand": "pt kl pijn 36 perc+ vit- dx irr pulp"}'
```
Returns 200 with expanded JSON containing bevindingen, diagnose, behandeling, afspraken fields.
  </verify>
  <done>expand-notes endpoint returns structured expanded note from shorthand input; shared Gemini client is reusable</done>
</task>

<task type="auto">
  <name>Task 2: Create suggest-treatment endpoint</name>
  <files>apps/web/src/app/api/ai/suggest-treatment/route.ts</files>
  <action>
Create `api/ai/suggest-treatment/route.ts`:
- POST endpoint accepting `{ patientId: string }`.
- `withAuth(request)` for auth. Verify patient belongs to user's practice.
- Query `prisma.tooth.findMany` for the patient with `include: { surfaces: { select: { surface, condition, material, restorationType } } }`. Filter to teeth that have non-HEALTHY conditions.
- Also query recent treatments for this patient (last 6 months) via `prisma.treatment.findMany` to avoid suggesting already-done work.
- Build odontogram text summary: `Element {toothNumber} ({status}): {surface}: {condition}` per tooth.
- Include recent treatments in prompt: "Recent treatments (do not re-suggest): ..."
- `assertNoPII(odontogramSummary)` — only tooth numbers and conditions, no patient name/BSN.
- Build Dutch prompt instructing Gemini to suggest treatment plan items with NZa codes, priority (HIGH/MEDIUM/LOW), and reasoning.
- Expected JSON output: `{ title: string, treatments: [{ toothNumber: number, description: string, nzaCode: string, reasoning: string, priority: string }] }`
- After parsing, validate each suggested nzaCode against `prisma.nzaCode.findMany({ where: { isActive: true } })`. Filter out codes not in DB. Enrich valid codes with description and tariff from DB.
- Return `{ suggestion: { title, treatments }, aiGenerated: true }`.
  </action>
  <verify>
`pnpm --filter @dentflow/web build` succeeds. Manual test with a patient that has odontogram data returns treatment suggestions with valid NZa codes.
  </verify>
  <done>suggest-treatment endpoint returns AI treatment suggestions based on patient's odontogram data with validated NZa codes</done>
</task>

</tasks>

<verification>
- Both endpoints compile without errors
- Both endpoints use shared gemini-client.ts
- Both endpoints call assertNoPII before Gemini
- Both endpoints require auth
- suggest-treatment validates NZa codes against DB
</verification>

<success_criteria>
- `pnpm --filter @dentflow/web build` passes
- expand-notes returns structured expanded text from shorthand
- suggest-treatment returns treatment suggestions with valid NZa codes from odontogram data
</success_criteria>

<output>
After completion, create `.planning/phases/05-ai-clinical-intelligence/05-01-SUMMARY.md`
</output>
