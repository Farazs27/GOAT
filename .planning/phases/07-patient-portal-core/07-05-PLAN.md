---
phase: 07-patient-portal-core
plan: 05
type: execute
wave: 3
depends_on: ["07-01", "07-03"]
files_modified:
  - apps/web/src/app/(dashboard)/dashboard/berichten/page.tsx
  - apps/web/src/app/api/dashboard/conversations/route.ts
  - apps/web/src/app/api/dashboard/conversations/[id]/route.ts
  - apps/web/src/app/api/dashboard/conversations/[id]/reassign/route.ts
  - apps/web/src/app/(dashboard)/dashboard/layout.tsx
autonomous: false

must_haves:
  truths:
    - "Each practitioner sees only their own patient conversations in dashboard"
    - "Staff can reply to patient messages"
    - "Staff can close conversations (mark resolved)"
    - "Staff can reassign conversations to another practitioner"
    - "Berichten link appears in dashboard sidebar"
  artifacts:
    - path: "apps/web/src/app/(dashboard)/dashboard/berichten/page.tsx"
      provides: "Staff-side messaging interface"
    - path: "apps/web/src/app/api/dashboard/conversations/route.ts"
      provides: "Staff conversation list scoped to practitioner"
      exports: ["GET"]
    - path: "apps/web/src/app/api/dashboard/conversations/[id]/route.ts"
      provides: "Staff message view and reply"
      exports: ["GET", "POST", "PATCH"]
  key_links:
    - from: "berichten/page.tsx"
      to: "/api/dashboard/conversations"
      via: "fetch practitioner conversations"
      pattern: "fetch.*dashboard/conversations"
---

<objective>
Staff-side messaging dashboard: practitioners see and respond to patient conversations, can close/reassign threads. Plus visual verification of entire portal.

Purpose: Complete the messaging loop -- patients send, staff receives and replies. Without staff UI, messaging is one-directional.
Output: Working staff messaging page + verified end-to-end portal experience.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-patient-portal-core/07-CONTEXT.md
@.planning/phases/07-patient-portal-core/07-RESEARCH.md
@.planning/phases/07-patient-portal-core/07-03-SUMMARY.md
@apps/web/src/app/(dashboard)/dashboard/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build staff-side messaging API and dashboard page</name>
  <files>apps/web/src/app/api/dashboard/conversations/route.ts, apps/web/src/app/api/dashboard/conversations/[id]/route.ts, apps/web/src/app/api/dashboard/conversations/[id]/reassign/route.ts, apps/web/src/app/(dashboard)/dashboard/berichten/page.tsx, apps/web/src/app/(dashboard)/dashboard/layout.tsx</files>
  <action>
**IMPORTANT:** Per CLAUDE.md rules, do NOT modify existing dashboard layout/API routes. Only ADD new files. For layout.tsx, only add a "Berichten" nav item to the existing sidebar navigation array -- minimal change, just one array entry addition.

**API routes (all validate access_token via authFetch pattern):**

**dashboard/conversations/route.ts:**
- GET: Extract userId from token. Find conversations where practitionerId=userId (each practitioner sees only their own per CONTEXT). Include: patient name, subject, status, lastMessage, unreadCount (messages where senderType=PATIENT and isRead=false). Optional query param `?status=OPEN|CLOSED` for filtering. Order by updatedAt desc.

**dashboard/conversations/[id]/route.ts:**
- GET: Verify practitioner owns conversation (or is admin). Return conversation with all messages + attachments. Mark PATIENT messages as isRead=true.
- POST: Reply to conversation. Body: `{ content: string }`. Create ConversationMessage with senderType=STAFF, senderId=userId. Update conversation.updatedAt.
- PATCH: Update conversation. Body: `{ status: "CLOSED" }`. Staff can close conversations.

**dashboard/conversations/[id]/reassign/route.ts:**
- PATCH: Body: `{ practitionerId: string }`. Verify current user owns conversation or is admin. Update conversation.practitionerId. Return updated conversation.

**berichten/page.tsx (Staff messaging UI):**
Two-panel layout matching dashboard styling (NOT glass UI -- use standard dashboard card styling):
- Left panel: conversation list with patient name, subject, last message preview, unread badge, status filter tabs (Alle/Open/Gesloten)
- Right panel: selected conversation -- header with patient name + subject + status badge + "Sluiten" button + "Toewijzen" dropdown, message thread (chat bubbles, staff on right, patient on left), reply input at bottom
- Reassign: dropdown of practitioners in same practice, selecting one calls reassign API
- Close: button marks conversation CLOSED, shows in closed tab
- Unread conversations highlighted in list
- Empty state: "Geen berichten" when no conversations

**layout.tsx modification (MINIMAL):**
Add ONE nav item to the existing sidebar items array: `{ label: "Berichten", href: "/dashboard/berichten", icon: MessageSquare }`. Place it after "Agenda" in the navigation order. Add unread count badge (fetch from conversations API).
  </action>
  <verify>`pnpm --filter @dentflow/web build` passes. Dashboard sidebar shows Berichten link. Staff can view conversations, reply, close, and reassign.</verify>
  <done>Staff messaging dashboard functional: practitioner-scoped conversation list, reply, close, reassign. Sidebar nav updated.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete patient portal end-to-end</name>
  <what-built>Complete patient portal: sidebar (7 items + badges), dashboard (4 widgets), appointments (tabs/cancel/reschedule/.ics), messaging (threaded conversations both patient and staff side), treatment plans (costs), invoices (PDF download), documents (upload + categories), profile (editable).</what-built>
  <how-to-verify>
    1. Visit http://localhost:3000/patient-login, log in as a patient
    2. Verify sidebar shows exactly: Home, Afspraken, Berichten, Behandelplannen, Facturen, Documenten, Profiel
    3. Check dashboard widgets show data
    4. Go to Afspraken -- verify Upcoming/Past tabs, try cancel/reschedule if appointments exist
    5. Go to Berichten -- create new conversation, send a message
    6. Log in as staff at http://localhost:3000/login, go to Berichten -- see the patient message, reply
    7. Switch back to patient portal -- verify staff reply appears
    8. Check Behandelplannen shows treatment costs
    9. Check Facturen has PDF download
    10. Check Documenten -- try uploading a document, verify "In behandeling" badge
    11. Check Profiel -- edit phone number, save, verify it persists
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- `pnpm --filter @dentflow/web build` passes
- End-to-end messaging: patient sends -> staff sees -> staff replies -> patient sees reply
- All 7 sidebar items work
- All 6 requirements (PORT-01 through PORT-07) verified
</verification>

<success_criteria>
Complete patient portal with all 6 requirements functional. Staff messaging integration working. User has verified the full experience.
</success_criteria>

<output>
After completion, create `.planning/phases/07-patient-portal-core/07-05-SUMMARY.md`
</output>
