---
phase: 11-hygienist-portal-rebuild
plan: 03
type: execute
wave: 2
depends_on: [11-01]
files_modified:
  - apps/web/src/components/hygienist/periodontogram/perio-summary.tsx
  - apps/web/src/components/hygienist/periodontogram/perio-classification.tsx
  - apps/web/src/components/hygienist/periodontogram/perio-history.tsx
  - apps/web/src/app/api/hygienist/protocols/route.ts
autonomous: true
requirements: [CLIN-06, CLIN-07]

must_haves:
  truths:
    - "Summary stats (BOP%, Plaque%, Mean PD, Sites >=6mm) display prominently"
    - "EFP/AAP classification auto-calculated and shown"
    - "Risk score (high/medium/low) with color coding shown at top"
    - "Historical sessions can be compared overlay or side-by-side"
    - "Protocol tracking shows multi-visit steps with statuses"
    - "Implant marking, furcation, recession, keratinized tissue editable"
  artifacts:
    - path: "apps/web/src/components/hygienist/periodontogram/perio-summary.tsx"
      provides: "Summary stats bar + risk score"
      min_lines: 80
    - path: "apps/web/src/components/hygienist/periodontogram/perio-classification.tsx"
      provides: "EFP/AAP auto-classification"
      min_lines: 60
    - path: "apps/web/src/components/hygienist/periodontogram/perio-history.tsx"
      provides: "Overlay + side-by-side historical comparison"
      min_lines: 120
  key_links:
    - from: "perio-classification.tsx"
      to: "PerioSite data"
      via: "calculateClassification function"
      pattern: "probingDepth|bleeding"
---

<objective>
Add advanced periodontogram features: summary statistics, EFP/AAP auto-classification with risk scoring, historical session comparison (overlay + side-by-side), extended per-tooth data (implant, furcation, recession, keratinized tissue, tooth notes), and multi-visit protocol tracking.

Purpose: Elevate the periodontogram from basic charting to professional-grade clinical tool.
Output: Summary, classification, history comparison, and protocol components.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-hygienist-portal-rebuild/11-RESEARCH.md
@.planning/phases/11-hygienist-portal-rebuild/11-02-SUMMARY.md
@apps/web/src/components/odontogram/perio/perio-classification.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Summary stats, classification, and risk score</name>
  <files>
    apps/web/src/components/hygienist/periodontogram/perio-summary.tsx
    apps/web/src/components/hygienist/periodontogram/perio-classification.tsx
  </files>
  <action>
**perio-summary.tsx:**
Summary stats bar component showing 4 metrics in a horizontal row of cards:
- BOP%: (bleeding sites / total sites) * 100 — color coded (green <10%, yellow 10-30%, red >30%)
- Plaque% (O'Leary): (plaque sites / total sites) * 100 — same color coding
- Mean PD: average probing depth across all sites — green <3.5, yellow 3.5-5, red >5
- Sites >=6mm: count of sites with probing depth >= 6mm — green 0, yellow 1-5, red >5

Also display: total teeth charted, total sites charted, suppuration count (per tooth).

Use static Tailwind class maps for colors (per CLAUDE.md rule — NO dynamic interpolation).

**perio-classification.tsx:**
EFP/AAP periodontal classification based on 2017 World Workshop:

Stage calculation (simplified clinical proxy):
- Stage I: PD 1-4mm, no tooth loss due to perio
- Stage II: PD <=5mm, no tooth loss
- Stage III: PD >=6mm, tooth loss <=4 teeth
- Stage IV: PD >=6mm, tooth loss >=5 teeth OR need complex rehab

Grade calculation:
- Grade A: No evidence of progression (no bone loss data — default)
- Grade B: Moderate progression
- Grade C: Rapid progression (age-adjusted bone loss, smoking, diabetes)
For simplicity, default to Grade B unless risk factors are provided.

Display: Stage badge (I/II/III/IV) with severity color, Grade badge (A/B/C).

**Risk score** at top of chart: Combine BOP%, max PD, and classification stage into High/Medium/Low:
- High: Stage III/IV OR BOP >30% OR any site >=7mm — Red badge
- Medium: Stage II OR BOP 10-30% OR sites 5-6mm — Yellow badge
- Low: Stage I AND BOP <10% — Green badge

Adapt logic from existing `perio-classification.tsx` in odontogram but build as standalone component. Reference for algorithm only — do not import from odontogram.
  </action>
  <verify>Run `pnpm --filter @dentflow/web build` — no errors.</verify>
  <done>Summary stats calculate correctly from site data, EFP/AAP classification renders stage/grade, risk score shows color-coded badge</done>
</task>

<task type="auto">
  <name>Task 2: Historical comparison + protocol tracking + extended tooth data</name>
  <files>
    apps/web/src/components/hygienist/periodontogram/perio-history.tsx
    apps/web/src/app/api/hygienist/protocols/route.ts
  </files>
  <action>
**perio-history.tsx:**
Two comparison modes toggled by button:

1. **Overlay mode:** Single chart showing current session depths as filled bars + previous session as outline/ghost bars behind them. Color difference indicators: green if improved (shallower), red if worsened (deeper). Session selector dropdown to pick which previous session to compare against.

2. **Side-by-side mode:** Two perio-chart instances rendered next to each other (50/50 width). Left = selected historical session, Right = current session. Both scrollable independently. Summary delta shown: "BOP: 35% -> 22% (improved)", "Mean PD: 4.2 -> 3.8 (improved)".

Accept `sessions: PerioSession[]` prop (fetched by parent page). Each session has its sites[].

**protocols/route.ts:**
- GET: List protocols for a patient (query param `patientId`). Include linked sessions.
- POST: Create protocol `{ patientId, steps: [{name: "Initial Exam", status: "PENDING"}, {name: "Scaling Q1/Q2", status: "PENDING"}, {name: "Re-evaluation", status: "PENDING"}, {name: "Scaling Q3/Q4", status: "PENDING"}] }`. Default steps if not provided.
- PUT (via POST with id): Update protocol step statuses, link sessionIds.

Auth via access_token. Filter by practiceId.

**Extended tooth data integration:** Update the perio page (from 11-02) entry panel to also collect per-tooth: mobility (0-3 scale), furcation grade (I/II/III), isImplant toggle, toothNote text field, keratinizedWidth (mm). These show as a collapsible "Tooth Details" section when a tooth is selected in entry. Per-tooth fields are the same for all 6 sites of that tooth — enter once, apply to all sites.

Also add: suppuration toggle per tooth (not per site per decision), recession entry (gingivalMargin field — negative values = recession, hygienist enters positive recession value, stored as negative gingivalMargin).
  </action>
  <verify>Run `pnpm --filter @dentflow/web build` — no errors.</verify>
  <done>Historical overlay and side-by-side comparison work with session selection, protocol API persists multi-visit tracking, extended tooth data (mobility, furcation, implant, notes, keratinized tissue, recession) editable in entry panel</done>
</task>

</tasks>

<verification>
- `pnpm --filter @dentflow/web build` succeeds
- Summary stats render with correct color coding
- Classification shows EFP/AAP stage and grade
- History comparison toggles between overlay and side-by-side
- Protocol CRUD works via API
</verification>

<success_criteria>
Periodontogram has professional-grade summary stats, auto-classification, risk scoring, historical comparison with two view modes, multi-visit protocol tracking, and full extended per-tooth clinical data entry.
</success_criteria>

<output>
After completion, create `.planning/phases/11-hygienist-portal-rebuild/11-03-SUMMARY.md`
</output>
