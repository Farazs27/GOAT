---
phase: 11-hygienist-portal-rebuild
plan: 05
type: execute
wave: 2
depends_on: [11-01]
files_modified:
  - apps/web/src/app/(hygienist)/hygienist/berichten/page.tsx
  - apps/web/src/components/hygienist/messaging/patient-messages.tsx
  - apps/web/src/components/hygienist/messaging/message-templates.tsx
  - apps/web/src/app/api/hygienist/conversations/route.ts
  - apps/web/src/app/(hygienist)/hygienist/reports/page.tsx
  - apps/web/src/app/(hygienist)/hygienist/recalls/page.tsx
  - apps/web/src/app/api/hygienist/recalls/route.ts
autonomous: true
requirements: [HYG-05, HYG-01]

must_haves:
  truths:
    - "Hygienist can message patients directly with separate threads"
    - "Staff chat tab reuses Phase 10 team chat"
    - "Message templates available for common scenarios"
    - "Conversation handoff to dentist works"
    - "Reports page shows perio trends and compliance stats"
    - "Recall management tracks due/overdue patients"
  artifacts:
    - path: "apps/web/src/app/(hygienist)/hygienist/berichten/page.tsx"
      provides: "Dual-tab messaging page (patients + staff)"
      min_lines: 100
    - path: "apps/web/src/components/hygienist/messaging/patient-messages.tsx"
      provides: "Patient conversation threads"
      min_lines: 150
    - path: "apps/web/src/app/(hygienist)/hygienist/reports/page.tsx"
      provides: "Reports dashboard with charts"
      min_lines: 150
    - path: "apps/web/src/app/(hygienist)/hygienist/recalls/page.tsx"
      provides: "Recall management page"
      min_lines: 120
  key_links:
    - from: "patient-messages.tsx"
      to: "/api/hygienist/conversations"
      via: "fetch for conversation CRUD"
      pattern: "api/hygienist/conversations"
    - from: "recalls/page.tsx"
      to: "/api/hygienist/recalls"
      via: "fetch for recall CRUD"
      pattern: "api/hygienist/recalls"
---

<objective>
Build messaging (dual-tab patient + staff chat with templates and handoff), reports (perio trends, compliance), and recall management pages.

Purpose: Complete the communication and management capabilities of the hygienist portal.
Output: Messaging, reports, and recalls pages with supporting APIs.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-hygienist-portal-rebuild/11-RESEARCH.md
@.planning/phases/11-hygienist-portal-rebuild/11-01-SUMMARY.md
@apps/web/src/app/(dashboard)/dashboard/berichten/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dual-tab messaging with patient conversations + handoff</name>
  <files>
    apps/web/src/app/(hygienist)/hygienist/berichten/page.tsx
    apps/web/src/components/hygienist/messaging/patient-messages.tsx
    apps/web/src/components/hygienist/messaging/message-templates.tsx
    apps/web/src/app/api/hygienist/conversations/route.ts
  </files>
  <action>
**berichten/page.tsx — Replace re-export with dual-tab page:**

Two tabs:
1. "Patienten" — Patient conversation threads (patient-messages.tsx)
2. "Team" — Reuse existing staff chat component from Phase 10 (import StaffChat or re-render the existing berichten components for staff chat)

Unread badge count on "Patienten" tab.

**conversations/route.ts:**
- GET: List conversations where practitionerId = current user. Include last message, unread count, patient info. Auth via access_token.
- POST: Create new conversation with patient. `{ patientId, initialMessage }`. Creates Conversation + first ConversationMessage.

**patient-messages.tsx:**
WhatsApp-style conversation UI:
- Left sidebar: conversation list with patient name, last message preview, unread dot, timestamp
- Right panel: message thread with bubbles (sent = right/blue, received = left/gray)
- Message input at bottom with: text field, attachment button (file/image upload to Vercel Blob), template button
- Send message: POST to existing conversation messages endpoint
- Hygienist identity shown: name + photo from User model
- **Handoff button:** "Doorsturen naar tandarts" — changes `practitionerId` on Conversation to a dentist user, adds system message "Gesprek overgedragen door [hygienist name]", conversation disappears from hygienist's list
- No read receipts (per decision)

**message-templates.tsx:**
Dropdown/popover with hardcoded templates:
```
- "Nazorg na reiniging" — "Beste [patient], na uw parodontale reiniging adviseren wij..."
- "Recall herinnering" — "Beste [patient], het is tijd voor uw periodieke controle..."
- "Thuiszorg instructies" — "Beste [patient], hier zijn uw persoonlijke thuiszorginstructies..."
- "Afspraak bevestiging" — "Beste [patient], uw afspraak op [datum] is bevestigd..."
- "Verwijzing informatie" — "Beste [patient], wij verwijzen u door naar..."
```
On select: insert template text into message input with [patient] replaced by actual patient name. [datum] left as placeholder for manual fill.
  </action>
  <verify>Run `pnpm --filter @dentflow/web build` — no errors.</verify>
  <done>Dual-tab messaging works with patient conversations, templates, attachments, and handoff to dentist</done>
</task>

<task type="auto">
  <name>Task 2: Reports page + recall management</name>
  <files>
    apps/web/src/app/(hygienist)/hygienist/reports/page.tsx
    apps/web/src/app/(hygienist)/hygienist/recalls/page.tsx
    apps/web/src/app/api/hygienist/recalls/route.ts
    apps/web/src/app/api/hygienist/reports/route.ts
  </files>
  <action>
**reports/page.tsx:**
Reports dashboard with computed-on-the-fly stats (per decision — no pre-computation).

Sections:
1. **Perio Overview** — Card with: total patients with perio data, avg BOP% across patients, avg plaque index, patients at high risk count. Fetch from `/api/hygienist/reports?type=perio-overview`.
2. **Trend Charts** — Use recharts (already in project). Line chart of BOP% over time (last 6 months), bar chart of session counts per month.
3. **Treatment Stats** — Treatments completed this month, top 5 procedure codes used, revenue this month.
4. **Patient Compliance** — Table of patients with: name, last visit date, recall status (due/overdue), BOP% trend (arrow up/down), risk level.

**reports/route.ts:**
GET endpoint with `type` query param:
- `perio-overview`: Aggregate PerioSession + PerioSite data for practice
- `trends`: Monthly BOP% and session counts for last 6 months
- `treatment-stats`: Invoice/treatment data for hygienist
- `compliance`: Patient list with recall + perio status
Auth via access_token. Scope to practiceId.

**recalls/page.tsx:**
Recall management page:
- Table of patients with: name, recall interval, next due date, status (DUE/OVERDUE/COMPLETED), last completed date, actions
- Status color coding: green=completed, yellow=due within 2 weeks, red=overdue
- Filter tabs: "Alle", "Vervallen" (overdue), "Binnenkort" (due soon), "Voltooid" (completed)
- "Herinnering sturen" button per patient: sends recall reminder message (creates conversation message using recall template)
- "Recall instellen" button: set/update recall interval for patient
- "Markeer voltooid" button: mark recall as completed, auto-calculate next due date

**recalls/route.ts:**
- GET: List RecallSchedule records for practice. Include patient info. Support status filter.
- POST: Create/update recall schedule for patient. `{ patientId, intervalMonths }`. Calculate nextDueDate.
- PUT (via `[id]` if needed, or POST with id): Update status, mark completed (sets lastCompletedAt, calculates next nextDueDate).
Auth via access_token.
  </action>
  <verify>Run `pnpm --filter @dentflow/web build` — no errors.</verify>
  <done>Reports page shows perio overview, trends, treatment stats, and compliance table. Recall page manages due/overdue patients with reminder sending and interval management.</done>
</task>

</tasks>

<verification>
- `pnpm --filter @dentflow/web build` succeeds
- Messaging page has two tabs, patient conversations work
- Reports page shows charts and stats
- Recall page shows patient recall status with actions
</verification>

<success_criteria>
Hygienist can message patients directly with templates and handoff, view comprehensive reports with perio trends, and manage patient recall schedules with reminder sending.
</success_criteria>

<output>
After completion, create `.planning/phases/11-hygienist-portal-rebuild/11-05-SUMMARY.md`
</output>
