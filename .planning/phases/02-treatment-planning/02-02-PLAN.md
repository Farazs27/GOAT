---
phase: 02-treatment-planning
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/components/treatments/treatment-plan-overlay.tsx
  - apps/web/src/components/treatments/treatment-plan-builder.tsx
  - apps/web/src/app/(patient)/portal/behandelplan/page.tsx
autonomous: true
requirements: [CLIN-03, CLIN-04]

must_haves:
  truths:
    - "Saving multiple queued treatments in the overlay creates ONE treatment plan with all treatments under it"
    - "Dentist can change plan status via action buttons in the treatment plan builder UI"
    - "Patient can see and click Accept/Reject buttons on PROPOSED treatment plans in the portal"
  artifacts:
    - path: "apps/web/src/components/treatments/treatment-plan-overlay.tsx"
      provides: "Single-plan creation with multiple treatments"
      contains: "treatments.*create.*many"
    - path: "apps/web/src/components/treatments/treatment-plan-builder.tsx"
      provides: "Status action buttons for plan lifecycle"
      contains: "PROPOSED"
    - path: "apps/web/src/app/(patient)/portal/behandelplan/page.tsx"
      provides: "Patient accept/reject UI"
      contains: "accept"
  key_links:
    - from: "apps/web/src/components/treatments/treatment-plan-overlay.tsx"
      to: "/api/treatment-plans"
      via: "POST one plan then POST treatments to it"
      pattern: "treatment-plans.*treatments"
    - from: "apps/web/src/components/treatments/treatment-plan-builder.tsx"
      to: "/api/treatment-plans/[id]"
      via: "PATCH with status field"
      pattern: "PATCH.*status"
    - from: "apps/web/src/app/(patient)/portal/behandelplan/page.tsx"
      to: "/api/patient-portal/treatment-plans/[id]"
      via: "PATCH with accept/reject action"
      pattern: "patient-portal/treatment-plans"
---

<objective>
Fix treatment plan creation to group treatments into a single plan and add status management UI for both dentist and patient.

Purpose: Currently the overlay creates N separate plans for N queued treatments (violating CLIN-03). The dentist has no UI to advance plan status. The patient portal shows plans read-only with no accept/reject buttons. This plan fixes all three UI gaps.

Output: Overlay creates 1 plan with N treatments, builder has status action buttons, patient portal has accept/reject buttons.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-treatment-planning/02-RESEARCH.md

@apps/web/src/components/treatments/treatment-plan-overlay.tsx
@apps/web/src/components/treatments/treatment-plan-builder.tsx
@apps/web/src/app/(patient)/portal/behandelplan/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix overlay to create one plan with multiple treatments</name>
  <files>apps/web/src/components/treatments/treatment-plan-overlay.tsx</files>
  <action>
Modify the handleSave function in treatment-plan-overlay.tsx:

Current behavior (broken): The save loop iterates over queuedTreatments and creates a separate TreatmentPlan for each entry (one POST /api/treatment-plans per queue item, then one POST /api/treatment-plans/{id}/treatments per queue item).

New behavior:
1. Create ONE treatment plan via POST /api/treatment-plans with the plan-level data (patientId, description combining all treatment descriptions, createdById). Use a combined description like "Behandelplan: {count} behandelingen" or join the individual descriptions.
2. Then loop over all queuedTreatments and POST each as a treatment to /api/treatment-plans/{planId}/treatments with individual treatment data (toothId, nzaCodeId, description, quantity, unitPrice, surfaces, status: 'PLANNED').
3. After all treatments are added, show success toast and close overlay.
4. If the plan POST fails, show error and stop. If any treatment POST fails, show error but continue with remaining treatments (partial save is better than losing all).
5. Keep all existing UI (queue management, tooth selection, NZA code picker) unchanged — only the save logic changes.
  </action>
  <verify>
Run `pnpm --filter @dentflow/web build` to confirm no TypeScript errors. Read the modified handleSave to confirm it creates 1 plan then N treatments.
  </verify>
  <done>
Saving 3 queued treatments creates exactly 1 TreatmentPlan with 3 Treatment records under it, not 3 separate TreatmentPlans.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add status action buttons to treatment plan builder and patient portal</name>
  <files>
    apps/web/src/components/treatments/treatment-plan-builder.tsx
    apps/web/src/app/(patient)/portal/behandelplan/page.tsx
  </files>
  <action>
**Treatment Plan Builder (dentist side):**

In treatment-plan-builder.tsx, for each treatment plan card/row, add contextual action buttons based on current status:
- DRAFT: "Voorstellen" button (transitions to PROPOSED) + "Annuleren" (to CANCELLED)
- PROPOSED: "Goedkeuren" (to ACCEPTED) + "Terug naar concept" (back to DRAFT) + "Annuleren"
- ACCEPTED: "Start behandeling" (to IN_PROGRESS) + "Annuleren"
- IN_PROGRESS: "Afronden" (to COMPLETED) + "Annuleren"
- COMPLETED: No action buttons (terminal)
- CANCELLED: No action buttons (terminal)

Each button calls PATCH /api/treatment-plans/{id} with `{ status: newStatus }` via authFetch. On success, refresh the plan list. On 400 error, show the error message in a toast.

Use static Tailwind classes. Primary actions use blue/green. "Annuleren" uses red/muted style. Buttons should be small (text-xs, px-2 py-1).

**Patient Portal (patient side):**

In the behandelplan page, for plans with status PROPOSED, add:
- "Akkoord" (accept) button — green, calls PATCH /api/patient-portal/treatment-plans/{id} with `{ action: 'accept' }`
- "Afwijzen" (reject) button — red/muted, calls PATCH with `{ action: 'reject' }`

Use `patient_token` from localStorage for auth (NOT authFetch). Follow the glass UI patterns from CLAUDE.md:
- Primary button: `bg-[#e8945a] hover:bg-[#d4864a] shadow-lg shadow-[#e8945a]/25 rounded-2xl`
- Reject button: `bg-white/[0.06] border border-white/[0.12] hover:bg-white/[0.09] rounded-2xl`

On success, refresh the plan list. Show a success toast or inline confirmation.
  </action>
  <verify>
Run `pnpm --filter @dentflow/web build` to confirm no TypeScript errors. Verify both files contain the new action buttons.
  </verify>
  <done>
Dentist sees contextual status action buttons on each plan in the builder. Patient sees Accept/Reject buttons on PROPOSED plans in the portal. All buttons call the correct API endpoints.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @dentflow/web build` passes with no errors
2. Treatment plan overlay creates 1 plan with N treatments (not N plans)
3. Builder shows correct action buttons per status
4. Patient portal shows accept/reject on PROPOSED plans
5. No existing UI functionality broken
</verification>

<success_criteria>
- Multiple queued treatments save as a single plan with multiple treatments
- Dentist can advance plans through the full lifecycle via UI buttons
- Patient can accept/reject proposed plans in the portal
- All API calls use correct auth patterns (authFetch for staff, patient_token for portal)
</success_criteria>

<output>
After completion, create `.planning/phases/02-treatment-planning/02-02-SUMMARY.md`
</output>
