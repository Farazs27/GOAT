---
phase: 06-agenda-scheduling
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - apps/web/src/app/(dashboard)/agenda/page.tsx
  - apps/web/src/components/agenda/appointment-block.tsx
  - apps/web/src/components/agenda/multi-practitioner-grid.tsx
  - apps/web/src/components/agenda/time-grid.tsx
autonomous: true
requirements: [AGND-01]

must_haves:
  truths:
    - "Staff can drag an appointment block to a different time slot to reschedule it"
    - "Staff can drag an appointment to a different practitioner column in team view"
    - "Dragged appointment updates in the database via PATCH API"
    - "Visual feedback shown during drag (ghost, drop target highlight)"
  artifacts:
    - path: "apps/web/src/components/agenda/appointment-block.tsx"
      provides: "Draggable appointment block"
      contains: "useDraggable"
    - path: "apps/web/src/components/agenda/time-grid.tsx"
      provides: "Droppable time slots"
      contains: "useDroppable"
  key_links:
    - from: "apps/web/src/components/agenda/appointment-block.tsx"
      to: "apps/web/src/components/agenda/time-grid.tsx"
      via: "@dnd-kit DndContext onDragEnd"
      pattern: "onDragEnd"
    - from: "apps/web/src/app/(dashboard)/agenda/page.tsx"
      to: "/api/appointments/[id]"
      via: "PATCH request on drag end to update startTime/endTime"
      pattern: "PATCH.*appointments"
---

<objective>
Add drag-drop rescheduling to appointment blocks on the agenda calendar using @dnd-kit.

Purpose: Staff can visually reschedule appointments by dragging them to new time slots or practitioner columns instead of manually editing times.

Output: Draggable appointment blocks with droppable time slots, PATCH integration on drop.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-agenda-scheduling/06-01-SUMMARY.md
@apps/web/src/app/api/appointments/[id]/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add @dnd-kit drag-drop to appointment blocks and time slots</name>
  <files>
    apps/web/src/components/agenda/appointment-block.tsx
    apps/web/src/components/agenda/time-grid.tsx
    apps/web/src/components/agenda/multi-practitioner-grid.tsx
    apps/web/src/app/(dashboard)/agenda/page.tsx
  </files>
  <action>
    1. Update `appointment-block.tsx`:
       - Add `useDraggable` from `@dnd-kit/core`. Use `appointment.id` as draggable id.
       - Pass appointment data in `useDraggable({ data: { appointment } })`.
       - Apply `transform` style during drag (CSS transform translate).
       - Add drag handle visual affordance (grip dots icon or cursor: grab).
       - While dragging, reduce opacity of the original block.

    2. Update `time-grid.tsx`:
       - Make each 30-minute time slot a `useDroppable` zone.
       - Droppable id format: `slot-{hour}-{minute}` (e.g., `slot-09-30`).
       - Store `{ hour, minute }` in droppable data.
       - Highlight the slot when a draggable is over it (light blue/green bg).

    3. Update `multi-practitioner-grid.tsx`:
       - Droppable id format for team view: `slot-{practitionerId}-{hour}-{minute}`.
       - Store `{ hour, minute, practitionerId }` in droppable data.
       - This allows cross-practitioner drag.

    4. Update `agenda/page.tsx`:
       - Wrap the day view (both single and team) in `<DndContext>` from `@dnd-kit/core`.
       - Import `DndContext`, `DragOverlay`, `MouseSensor`, `TouchSensor`, `useSensor`, `useSensors`.
       - Use `MouseSensor` with `activationConstraint: { distance: 8 }` to prevent accidental drags on click.
       - Add `TouchSensor` for mobile support.
       - On `onDragEnd`: parse the droppable id to get new hour/minute (and optionally practitionerId). Calculate new `startTime` and `endTime` (preserve duration). Call `authFetch` PATCH `/api/appointments/${appointmentId}` with `{ startTime, endTime, practitionerId }`. On success, refresh the appointments list. On error, show a toast.
       - Add `<DragOverlay>`: render a semi-transparent copy of the dragged `<AppointmentBlock>` during drag.
       - Week view: also wrap in DndContext if feasible (droppable slots include date). If too complex, skip week view drag-drop (day view only).

    Use `date-fns` `set()` to construct new Date from selected date + dropped hour/minute. The existing PATCH endpoint already handles `startTime`/`endTime` updates.
  </action>
  <verify>
    Run `pnpm --filter @dentflow/web build` — must succeed.
    Day view: drag appointment block to new time slot → appointment moves, API called with new time.
    Team view: drag appointment to different practitioner column → appointment reassigned.
  </verify>
  <done>
    Appointments can be dragged to new time slots in day view (single and team). PATCH API updates the appointment. Visual feedback during drag (overlay, drop highlights). Build passes.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @dentflow/web build` passes
2. Drag appointment in day view → reschedules to new time
3. Drag appointment in team view → moves to different practitioner
4. Drag overlay shows during drag
5. Drop target highlights on hover
6. API PATCH called with correct new startTime/endTime
7. Appointment list refreshes after successful drag
</verification>

<success_criteria>
- Appointment blocks are draggable with @dnd-kit
- Time slots are droppable with visual feedback
- Drag-drop reschedules via PATCH API
- Works in both single and team day views
</success_criteria>

<output>
After completion, create `.planning/phases/06-agenda-scheduling/06-02-SUMMARY.md`
</output>
