---
phase: 06-agenda-scheduling
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/lib/whatsapp/twilio.ts
  - apps/web/src/app/api/cron/appointment-reminders/route.ts
autonomous: true
requirements: [AGND-04]
user_setup:
  - service: twilio
    why: "SMS and WhatsApp appointment reminders (Twilio credentials already stored in DB Credential table per practice)"
    dashboard_config:
      - task: "Ensure Twilio Credential record exists for practice with SMS-capable phone number in config.smsNumber"
        location: "Admin panel -> Credentials, or seed data"

must_haves:
  truths:
    - "Cron endpoint sends SMS reminders to patients with phone numbers"
    - "Cron endpoint sends WhatsApp reminders when configured"
    - "Email reminders continue to work as before"
    - "System gracefully degrades when Twilio is not configured"
  artifacts:
    - path: "apps/web/src/lib/whatsapp/twilio.ts"
      provides: "Twilio SMS and WhatsApp send functions (extended from existing)"
      min_lines: 60
      exports: ["sendSms", "sendWhatsAppMessage", "sendAppointmentReminderSms"]
    - path: "apps/web/src/app/api/cron/appointment-reminders/route.ts"
      provides: "Multi-channel reminder cron"
      contains: "sendSms"
  key_links:
    - from: "apps/web/src/app/api/cron/appointment-reminders/route.ts"
      to: "apps/web/src/lib/whatsapp/twilio.ts"
      via: "import sendSms, sendAppointmentReminderSms"
      pattern: "sendSms|sendAppointmentReminderSms"
    - from: "apps/web/src/lib/whatsapp/twilio.ts"
      to: "twilio"
      via: "Twilio SDK client (already exists)"
      pattern: "twilio"
---

<objective>
Add SMS and WhatsApp appointment reminders alongside existing email reminders.

Purpose: Patients should receive reminders via their preferred channel. Email already works via Resend. This adds Twilio SMS and WhatsApp as additional channels.

Output: SMS/WhatsApp service module + updated cron endpoint for multi-channel reminders.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/web/src/lib/email/service.ts
@apps/web/src/lib/email/triggers.ts
@apps/web/src/lib/whatsapp/twilio.ts
@apps/web/src/app/api/cron/appointment-reminders/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend existing Twilio service with SMS and update reminder cron</name>
  <files>
    apps/web/src/lib/whatsapp/twilio.ts
    apps/web/src/app/api/cron/appointment-reminders/route.ts
  </files>
  <action>
    1. Extend `apps/web/src/lib/whatsapp/twilio.ts` (EXISTING file — do NOT create a new file):
       - The file already has `getTwilioClient(practiceId)` which reads credentials from the DB Credential table, and `sendWhatsAppMessage(practiceId, to, body)`. Reuse this infrastructure.
       - Add `sendSms(practiceId: string, to: string, body: string)`: use existing `getTwilioClient(practiceId)` to get the client, then `client.messages.create({ body, to: normalizedTo, from: smsNumber })`. The SMS "from" number should come from `config.smsNumber` on the Credential record (extend the config type to include `smsNumber?: string`). Use existing `normalizePhoneNumber()` helper. Returns `{ success: boolean, twilioSid?: string, error?: string }`. Catch errors gracefully.
       - Add `sendAppointmentReminderSms(practiceId: string, patientName: string, appointmentTime: string, practiceName: string, phone: string)`: formats a Dutch reminder message and calls `sendSms`. Message: "Beste {patientName}, u heeft morgen om {appointmentTime} een afspraak bij {practiceName}. Neem contact op als u wilt afzeggen."
       - Add `sendAppointmentReminderWhatsApp(practiceId: string, patientName: string, appointmentTime: string, practiceName: string, phone: string)`: same message but calls existing `sendWhatsAppMessage`.
       - Add `isSmsConfigured(practiceId: string): Promise<boolean>`: checks if Credential exists and has `config.smsNumber` set.

    2. Update `apps/web/src/app/api/cron/appointment-reminders/route.ts`:
       - Read the existing implementation to understand the current email-only flow.
       - After the existing email sending logic, add SMS and WhatsApp sending:
         - For each appointment due for reminder, check if patient has a phone number (`patient.phone` or `patient.mobilePhone`).
         - If phone exists, check `isSmsConfigured(practiceId)` — if true, call `sendAppointmentReminderSms(practiceId, ...)`.
         - Check `isWhatsAppConfigured(practiceId)` — if true, call `sendAppointmentReminderWhatsApp(practiceId, ...)`.
         - Log results. Do NOT block email sending if SMS/WhatsApp fails.
       - Keep `reminderSentAt` update as-is (it already marks that a reminder was sent regardless of channel).
       - Add SMS/WhatsApp send counts to the response summary.
       - If Twilio is not configured, skip SMS/WhatsApp silently (graceful degradation — log a note but don't error).

    Dutch reminder message format:
    ```
    Beste [naam], u heeft morgen om [tijd] een afspraak bij [praktijk]. Neem contact op als u wilt afzeggen.
    ```
  </action>
  <verify>
    Run `pnpm --filter @dentflow/web build` — must succeed.
    Without Twilio env vars: cron still sends emails, no errors.
    With Twilio env vars: cron sends SMS + WhatsApp alongside email.
  </verify>
  <done>
    SMS and WhatsApp reminder functions exist. Cron endpoint sends multi-channel reminders. Graceful degradation when Twilio is not configured. Email reminders unaffected. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @dentflow/web build` passes
2. `src/lib/whatsapp/twilio.ts` exports `sendSms`, `sendAppointmentReminderSms`, `isSmsConfigured` (alongside existing exports)
3. Cron endpoint handles multi-channel sending
4. No errors when Twilio env vars missing
5. Existing email reminders continue working
</verification>

<success_criteria>
- Existing Twilio service extended with SMS functions (no duplicate module)
- Cron endpoint sends reminders via all configured channels
- Graceful degradation without Twilio credentials
- Dutch reminder messages
</success_criteria>

<output>
After completion, create `.planning/phases/06-agenda-scheduling/06-04-SUMMARY.md`
</output>
