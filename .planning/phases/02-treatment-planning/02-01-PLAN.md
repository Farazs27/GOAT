---
phase: 02-treatment-planning
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/app/api/treatment-plans/[id]/route.ts
  - apps/web/src/app/api/patient-portal/treatment-plans/[id]/route.ts
  - apps/web/src/app/api/invoices/route.ts
autonomous: true
requirements: [CLIN-04, CLIN-05]

must_haves:
  truths:
    - "Treatment plan status can only move through valid transitions (DRAFT->PROPOSED->ACCEPTED->IN_PROGRESS->COMPLETED, with CANCELLED from any non-terminal state)"
    - "Invalid status transitions return 400 error with descriptive message"
    - "Patient can accept a PROPOSED treatment plan via the patient portal"
    - "Completing a treatment plan auto-creates a DRAFT invoice with lines linked to each completed treatment"
    - "Status changes and invoice creation happen atomically (all or nothing)"
  artifacts:
    - path: "apps/web/src/app/api/treatment-plans/[id]/route.ts"
      provides: "Status transition validation and side effects in PATCH handler"
      contains: "ALLOWED_TRANSITIONS"
    - path: "apps/web/src/app/api/patient-portal/treatment-plans/[id]/route.ts"
      provides: "Patient approval PATCH endpoint"
      exports: ["PATCH"]
  key_links:
    - from: "apps/web/src/app/api/treatment-plans/[id]/route.ts"
      to: "prisma.invoice.create"
      via: "Auto-invoice on COMPLETED transition"
      pattern: "invoice\\.create"
    - from: "apps/web/src/app/api/patient-portal/treatment-plans/[id]/route.ts"
      to: "prisma.treatmentPlan.update"
      via: "Patient accepts plan (PROPOSED->ACCEPTED)"
      pattern: "status.*ACCEPTED"
---

<objective>
Add treatment plan status workflow enforcement and billing automation.

Purpose: Treatment plans currently accept any status without validation and have no side effects. This plan adds transition validation, atomic side effects (timestamp updates, treatment status cascading), patient approval via portal, and auto-generation of DRAFT invoices when plans complete.

Output: Enhanced PATCH route with transition map, patient portal PATCH endpoint, auto-invoice creation on completion.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-treatment-planning/02-RESEARCH.md

@apps/web/src/app/api/treatment-plans/[id]/route.ts
@apps/web/src/app/api/patient-portal/treatment-plans/[id]/route.ts
@apps/web/src/app/api/invoices/route.ts
@packages/database/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add status transition validation and side effects to treatment plan PATCH</name>
  <files>apps/web/src/app/api/treatment-plans/[id]/route.ts</files>
  <action>
Enhance the existing PATCH handler in treatment-plans/[id]/route.ts:

1. Add a transition map at module level:
```typescript
const ALLOWED_TRANSITIONS: Record<string, string[]> = {
  DRAFT: ['PROPOSED', 'CANCELLED'],
  PROPOSED: ['ACCEPTED', 'CANCELLED', 'DRAFT'],
  ACCEPTED: ['IN_PROGRESS', 'CANCELLED'],
  IN_PROGRESS: ['COMPLETED', 'CANCELLED'],
  COMPLETED: [],
  CANCELLED: [],
};
```

2. In the PATCH handler, when `status` is in the request body:
   - Fetch the current plan's status
   - Validate the transition using the map. If invalid, return 400 with message: `"Ongeldige statusovergang van ${current} naar ${next}"`
   - Wrap the entire update in `prisma.$transaction`

3. Add side effects inside the transaction based on newStatus:
   - PROPOSED: set `proposedAt: new Date()`
   - ACCEPTED: set `acceptedAt: new Date()`
   - IN_PROGRESS: update all PLANNED treatments under this plan to IN_PROGRESS status
   - COMPLETED:
     a. Update all non-COMPLETED, non-CANCELLED treatments to COMPLETED with `performedAt: new Date()`
     b. Fetch all completed treatments with their nzaCode and tooth relations
     c. Generate next invoice number using the same pattern as invoices/route.ts: find last invoice for the practice, increment sequence, format as `F{year}-{0001}`
     d. Create a DRAFT Invoice with nested InvoiceLine records, one per treatment. Each line: `description` from treatment, `treatmentId` linking back, `nzaCodeId`, `nzaCode` (the code string), `toothNumber` from tooth, `quantity` from treatment, `unitPrice` from treatment.unitPrice or nzaCode.maxTariff, `lineTotal` = unitPrice * quantity. Set invoice `subtotal`, `total`, `patientAmount` = sum of lineTotals. Set `dueDate` = 30 days from now.
   - CANCELLED: update all non-COMPLETED treatments to CANCELLED status

4. Keep all existing non-status PATCH functionality (updating description, notes, etc.) unchanged.

5. Maintain existing practice scoping: all queries must include `practiceId: user.practiceId` in where clauses.
  </action>
  <verify>
Run `pnpm --filter @dentflow/web build` to confirm no TypeScript errors. Manually verify the PATCH handler includes the ALLOWED_TRANSITIONS map and the $transaction block.
  </verify>
  <done>
PATCH /api/treatment-plans/[id] with status field validates transitions against the map, returns 400 for invalid transitions, and atomically applies side effects (timestamps, treatment status cascading, DRAFT invoice creation on COMPLETED).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add patient approval PATCH endpoint to patient portal</name>
  <files>apps/web/src/app/api/patient-portal/treatment-plans/[id]/route.ts</files>
  <action>
Add a PATCH export to the existing patient portal treatment-plans/[id]/route.ts file (which currently only has GET):

1. Import the same auth utilities used in the existing GET handler in this file.

2. Create PATCH handler:
   - Authenticate using the patient token pattern (same as the GET handler in this file)
   - Parse request body expecting `{ action: 'accept' | 'reject' }`
   - Fetch the treatment plan by ID, verifying `patientId` matches the authenticated patient's patientId (data scoping rule)
   - If plan not found or wrong patient: return 404
   - If action is 'accept':
     - Validate current status is PROPOSED. If not, return 400: `"Behandelplan is niet in voorgestelde status"`
     - Update plan: `status: 'ACCEPTED', acceptedAt: new Date()`
   - If action is 'reject':
     - Validate current status is PROPOSED. If not, return 400
     - Update plan: `status: 'CANCELLED', cancelledAt: new Date()`
   - Return updated plan with 200

3. IMPORTANT: Do NOT modify the existing GET handler. Only add the new PATCH export.

4. Use `patient_token` auth pattern â€” look at how the existing GET handler in this same file authenticates and follow the exact same pattern.
  </action>
  <verify>
Run `pnpm --filter @dentflow/web build` to confirm no TypeScript errors. Verify the file now exports both GET and PATCH.
  </verify>
  <done>
Patient can accept (PROPOSED->ACCEPTED) or reject (PROPOSED->CANCELLED) a treatment plan via PATCH /api/patient-portal/treatment-plans/[id] with body `{ action: 'accept' }` or `{ action: 'reject' }`. Only works on plans belonging to the authenticated patient in PROPOSED status.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @dentflow/web build` passes with no errors
2. Treatment plan PATCH rejects invalid transitions (e.g., COMPLETED->DRAFT returns 400)
3. Treatment plan PATCH to COMPLETED creates a DRAFT invoice with correct line items
4. Patient portal PATCH accepts/rejects only PROPOSED plans belonging to the authenticated patient
5. All database operations use $transaction for atomicity
</verification>

<success_criteria>
- Status transition validation prevents invalid moves and returns clear Dutch error messages
- COMPLETED transition atomically creates DRAFT invoice with treatment-linked lines
- Patient portal has working PATCH endpoint for accept/reject
- No existing functionality broken (GET handlers, non-status PATCH fields)
</success_criteria>

<output>
After completion, create `.planning/phases/02-treatment-planning/02-01-SUMMARY.md`
</output>
