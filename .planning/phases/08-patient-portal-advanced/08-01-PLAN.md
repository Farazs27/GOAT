---
phase: 08-patient-portal-advanced
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/prisma/schema.prisma
  - apps/web/src/app/api/patient-portal/consent/[id]/sign/route.ts
  - apps/web/src/app/api/patient-portal/treatment-plans/[id]/sign/route.ts
  - apps/web/src/app/api/patient-portal/consent/[id]/pdf/route.ts
autonomous: true
requirements: [PORT-06]

must_haves:
  truths:
    - "ConsentTemplate model exists in Prisma schema with Dutch/English content, merge fields, expiry days"
    - "ConsentForm model has new fields: templateId, signedUserAgent, signerRelation, appointmentId, version, signatureUrl, language"
    - "Signing consent form captures IP, user agent, stores signature PNG to Vercel Blob"
    - "Treatment plan can be signed with same flow as consent forms"
    - "Signed consent PDF can be downloaded with embedded signature"
  artifacts:
    - path: "packages/database/prisma/schema.prisma"
      provides: "ConsentTemplate model and enhanced ConsentForm fields"
      contains: "model ConsentTemplate"
    - path: "apps/web/src/app/api/patient-portal/consent/[id]/sign/route.ts"
      provides: "Enhanced consent signing with IP, UA, Blob upload, dependent signing"
      exports: ["POST"]
    - path: "apps/web/src/app/api/patient-portal/treatment-plans/[id]/sign/route.ts"
      provides: "Treatment plan signing endpoint"
      exports: ["POST"]
    - path: "apps/web/src/app/api/patient-portal/consent/[id]/pdf/route.ts"
      provides: "Signed consent PDF generation with embedded signature"
      exports: ["GET"]
  key_links:
    - from: "apps/web/src/app/api/patient-portal/consent/[id]/sign/route.ts"
      to: "@vercel/blob"
      via: "put() for signature PNG upload"
      pattern: "put.*signatures/"
    - from: "apps/web/src/app/api/patient-portal/consent/[id]/pdf/route.ts"
      to: "jspdf"
      via: "PDF generation with embedded signature image"
      pattern: "new jsPDF"
---

<objective>
Add ConsentTemplate model and enhance ConsentForm with new fields for dependent signing, version tracking, and Vercel Blob signature storage. Enhance the consent sign API to capture IP, user agent, signer relation, and upload signature PNG to Vercel Blob. Create treatment plan signing endpoint and signed PDF download endpoint.

Purpose: Foundation for digital consent signing and treatment plan approval — schema and API layer.
Output: Updated Prisma schema, enhanced sign API, new treatment plan sign API, PDF download API.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-patient-portal-advanced/08-RESEARCH.md
@packages/database/prisma/schema.prisma
@apps/web/src/app/api/patient-portal/consent/[id]/sign/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ConsentTemplate model and enhance ConsentForm schema</name>
  <files>packages/database/prisma/schema.prisma</files>
  <action>
1. Add `ConsentTemplate` model:
   - id (uuid), practiceId, title, contentNl (Text), contentEn (Text, optional), consentType (String), isActive (Boolean, default true), expiryDays (Int, optional), createdAt, updatedAt
   - Relation to Practice (add `consentTemplates ConsentTemplate[]` to Practice model)
   - Relation to ConsentForm[] (one template -> many forms)
   - @@map("consent_templates")

2. Add new fields to `ConsentForm`:
   - templateId String? @map("template_id") — FK to ConsentTemplate
   - signedUserAgent String? @map("signed_user_agent")
   - signerRelation String? @map("signer_relation") — "SELF", "PARENT", "GUARDIAN"
   - appointmentId String? @map("appointment_id") — FK to Appointment
   - version Int @default(1)
   - signatureUrl String? @map("signature_url") — Vercel Blob URL for PNG
   - language String @default("nl")
   - Add relations: template ConsentTemplate? @relation(...), appointment Appointment? @relation(...)
   - Add consentForms ConsentForm[] to Appointment model

3. Add EXPIRED to the status comment on ConsentForm (PENDING, SIGNED, REVOKED, EXPIRED)

4. Run `pnpm db:generate && pnpm db:push` to apply changes.
  </action>
  <verify>Run `pnpm db:generate` succeeds without errors. Run `pnpm --filter @dentflow/web build` to verify no type errors.</verify>
  <done>ConsentTemplate model exists. ConsentForm has templateId, signedUserAgent, signerRelation, appointmentId, version, signatureUrl, language fields. Schema compiles and pushes to DB.</done>
</task>

<task type="auto">
  <name>Task 2: Enhance consent sign API + treatment plan sign + PDF download endpoints</name>
  <files>
    apps/web/src/app/api/patient-portal/consent/[id]/sign/route.ts
    apps/web/src/app/api/patient-portal/treatment-plans/[id]/sign/route.ts
    apps/web/src/app/api/patient-portal/consent/[id]/pdf/route.ts
  </files>
  <action>
1. **Enhance existing consent sign API** (`consent/[id]/sign/route.ts`):
   - Extract client IP from `x-forwarded-for` or `x-real-ip` headers
   - Extract user agent from `user-agent` header
   - Accept additional body fields: `signerRelation` (optional, "SELF"|"PARENT"|"GUARDIAN"), `signedByName` (required)
   - Convert base64 signature data URL to PNG buffer, upload to Vercel Blob at path `signatures/{consentFormId}/{timestamp}.png`, store URL in `signatureUrl`
   - Store IP in `signedIp`, user agent in `signedUserAgent`, relation in `signerRelation`
   - For re-signing: if the consent form is already SIGNED, create a NEW ConsentForm record with version incremented by 1 (same templateId, patientId, practiceId), keeping the old one intact. Link new form to same template/appointment.
   - Create Notification record for staff: type "CONSENT_SIGNED", targetUserId = null (practice-wide), message = "Patient {name} signed consent: {title}"
   - Keep backward compatibility: still store signatureData for existing flows

2. **Create treatment plan sign API** (`treatment-plans/[id]/sign/route.ts`):
   - POST endpoint, authenticates via `patient_token`
   - Accepts: signatureData (base64), signedByName, signerRelation (optional)
   - Validates treatment plan belongs to authenticated patient and is in PROPOSED status
   - Creates a ConsentForm record with consentType "TREATMENT_APPROVAL", treatmentPlanId set, content = treatment plan description/summary
   - Uploads signature PNG to Vercel Blob
   - Updates treatment plan status to APPROVED
   - Creates Notification for staff
   - Returns success with consent form ID

3. **Create PDF download API** (`consent/[id]/pdf/route.ts`):
   - GET endpoint, authenticates via `patient_token`
   - Validates consent form belongs to authenticated patient and is SIGNED
   - Uses jsPDF to generate PDF:
     - Title at top
     - Content text (split into lines for wrapping)
     - If signatureUrl exists, fetch the PNG from Vercel Blob, embed as image at bottom
     - Add signer name, date signed, signer relation below signature
   - Return PDF as `application/pdf` response with Content-Disposition header
  </action>
  <verify>Run `pnpm --filter @dentflow/web build` to verify all routes compile. Verify the sign endpoint creates Vercel Blob entries and stores signatureUrl.</verify>
  <done>Consent sign API captures IP/UA/relation, uploads PNG to Blob, supports re-signing with versioning. Treatment plan sign API creates consent form + updates plan status. PDF download generates document with embedded signature.</done>
</task>

</tasks>

<verification>
- `pnpm --filter @dentflow/web build` passes
- ConsentTemplate model in schema with all specified fields
- ConsentForm has 7 new fields
- Sign API accepts signerRelation, captures IP/UA, uploads to Blob
- Treatment plan sign API creates consent form and updates plan status
- PDF endpoint returns valid PDF with embedded signature
</verification>

<success_criteria>
Schema extended, sign APIs enhanced with full audit data capture, treatment plan signing works, PDF download generates signed document.
</success_criteria>

<output>
After completion, create `.planning/phases/08-patient-portal-advanced/08-01-SUMMARY.md`
</output>
