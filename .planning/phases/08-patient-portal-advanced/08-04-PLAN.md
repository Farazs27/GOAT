---
phase: 08-patient-portal-advanced
plan: 04
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - apps/web/src/app/api/dashboard/consent-templates/route.ts
  - apps/web/src/app/api/dashboard/consent-templates/[id]/route.ts
  - apps/web/src/app/api/dashboard/consent/route.ts
  - apps/web/src/app/api/dashboard/consent/send/route.ts
  - apps/web/src/app/api/dashboard/consent/export/route.ts
  - apps/web/src/app/(dashboard)/dashboard/consent/page.tsx
  - apps/web/src/app/(dashboard)/dashboard/consent/templates/page.tsx
autonomous: true
requirements: [PORT-06]

must_haves:
  truths:
    - "Staff can create, edit, and deactivate consent form templates"
    - "Templates support Dutch + English content with merge fields {patient_name}, {date}, {practitioner_name}"
    - "Staff can send consent form from template to one or multiple patients (bulk send)"
    - "Staff can set expiry period on templates and individual forms"
    - "Staff sees global consent overview with filters: status, template, date range, patient"
    - "Staff can export consent report as CSV"
    - "Staff sees full audit trail (IP, user agent) on signed consent forms"
  artifacts:
    - path: "apps/web/src/app/api/dashboard/consent-templates/route.ts"
      provides: "CRUD for consent templates"
      exports: ["GET", "POST"]
    - path: "apps/web/src/app/api/dashboard/consent/route.ts"
      provides: "Global consent overview with filters"
      exports: ["GET"]
    - path: "apps/web/src/app/api/dashboard/consent/send/route.ts"
      provides: "Send consent to patient(s) from template"
      exports: ["POST"]
    - path: "apps/web/src/app/(dashboard)/dashboard/consent/page.tsx"
      provides: "Staff consent overview page with filters and export"
      min_lines: 150
    - path: "apps/web/src/app/(dashboard)/dashboard/consent/templates/page.tsx"
      provides: "Template management page"
      min_lines: 100
  key_links:
    - from: "apps/web/src/app/(dashboard)/dashboard/consent/page.tsx"
      to: "/api/dashboard/consent"
      via: "fetch GET with filter params"
      pattern: "fetch.*api/dashboard/consent"
    - from: "apps/web/src/app/api/dashboard/consent/send/route.ts"
      to: "prisma.consentForm.createMany"
      via: "bulk create consent forms from template"
      pattern: "createMany"
---

<objective>
Build staff-side consent management: template CRUD, global consent overview with filters and export, bulk send to patients, and audit trail visibility.

Purpose: Staff can manage consent form templates and monitor all patient consent status across the practice.
Output: Template management page, global consent overview, send/export APIs.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-patient-portal-advanced/08-RESEARCH.md
@.planning/phases/08-patient-portal-advanced/08-01-SUMMARY.md
@packages/database/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Consent template CRUD and send/export APIs</name>
  <files>
    apps/web/src/app/api/dashboard/consent-templates/route.ts
    apps/web/src/app/api/dashboard/consent-templates/[id]/route.ts
    apps/web/src/app/api/dashboard/consent/route.ts
    apps/web/src/app/api/dashboard/consent/send/route.ts
    apps/web/src/app/api/dashboard/consent/export/route.ts
  </files>
  <action>
1. **Template CRUD** (`consent-templates/route.ts`):
   - GET: List all templates for practice (from authFetch user's practiceId). Include count of forms created from each template. Support `?active=true` filter.
   - POST: Create template. Body: title, contentNl, contentEn (optional), consentType, expiryDays (optional). Validate merge fields syntax is correct (only allow {patient_name}, {date}, {practitioner_name}).

2. **Template single** (`consent-templates/[id]/route.ts`):
   - GET: Single template with usage stats
   - PATCH: Update template fields. Cannot change if forms exist that are SIGNED (warn in response).
   - DELETE: Soft delete (set isActive=false). Never hard delete templates with existing forms.

3. **Global consent overview** (`consent/route.ts`):
   - GET: List all consent forms for practice with filters:
     - `status` (PENDING, SIGNED, EXPIRED, REVOKED)
     - `templateId`
     - `patientId`
     - `dateFrom`, `dateTo` (createdAt range)
   - Include patient name, template title, signer info
   - For SIGNED forms: include full audit data (signedIp, signedUserAgent, signerRelation) — this is staff-only data
   - Paginate (page, limit params, default 50)

4. **Send consent** (`consent/send/route.ts`):
   - POST: Body: templateId, patientIds (array), appointmentId (optional), language ("nl"|"en")
   - Fetch template, resolve merge fields per patient ({patient_name} from patient record, {date} = today, {practitioner_name} = sending user's name)
   - Create ConsentForm for each patient using createMany
   - If template has expiryDays, set expiresAt = now + expiryDays
   - If appointmentId provided, link each form to that appointment
   - Create Notification for each patient
   - Return count of forms created

5. **Export** (`consent/export/route.ts`):
   - GET: Same filters as overview, but returns CSV
   - Columns: Patient Name, Form Title, Type, Status, Signed Date, Signed By, Signer Relation, Expires At
   - Return as `text/csv` with Content-Disposition header
  </action>
  <verify>Run `pnpm --filter @dentflow/web build` to verify all routes compile.</verify>
  <done>Template CRUD works with validation. Send creates forms for multiple patients. Overview returns filtered results with audit data. Export generates CSV.</done>
</task>

<task type="auto">
  <name>Task 2: Staff consent overview and template management pages</name>
  <files>
    apps/web/src/app/(dashboard)/dashboard/consent/page.tsx
    apps/web/src/app/(dashboard)/dashboard/consent/templates/page.tsx
  </files>
  <action>
1. **Global consent overview** (`consent/page.tsx`):
   - Page title "Toestemmingsformulieren" with tabs: "Overzicht" (active) and "Sjablonen" (link to templates page)
   - Filter bar: status dropdown (Alle/In afwachting/Ondertekend/Verlopen/Ingetrokken), template dropdown, patient search input, date range pickers
   - Table showing: Patient, Formulier, Type, Status (with colored badge), Ondertekend op, Verloopt op
   - Click row to expand: show full audit trail (IP, user agent, signer relation, signed by name)
   - "Exporteren" button in top right → calls export API, triggers CSV download
   - "Versturen" button → opens send dialog (select template, search/select patients, optional appointment link, language toggle NL/EN, send button)
   - Use existing dashboard styling (not glass UI — this is staff portal)
   - Status badges: PENDING=yellow, SIGNED=green, EXPIRED=red, REVOKED=gray

2. **Template management** (`consent/templates/page.tsx`):
   - Page title "Consent Sjablonen" with back link to overview
   - List of templates as cards: title, type, content preview (truncated), expiry days, active/inactive toggle, usage count
   - "Nieuw Sjabloon" button → opens creation form:
     - Title input
     - Consent type select (TREATMENT, GENERAL, ANESTHESIA, IMAGING, etc.)
     - Dutch content textarea (required) with merge field insert buttons: {patient_name}, {date}, {practitioner_name}
     - English content textarea (optional) with same merge field buttons
     - Expiry days input (optional, number)
     - Save button
   - Click existing template → edit form (same as creation, pre-filled)
   - Deactivate button (soft delete)
   - Merge field buttons insert the field text at cursor position in the textarea
  </action>
  <verify>Run `pnpm --filter @dentflow/web build` to verify compilation.</verify>
  <done>Staff can view all consent forms with filters, see audit trails, export CSV, send forms to patients. Staff can create/edit/deactivate consent templates with merge fields and dual-language support.</done>
</task>

</tasks>

<verification>
- `pnpm --filter @dentflow/web build` passes
- Template CRUD creates templates with merge fields
- Bulk send creates consent forms for multiple patients
- Overview shows filtered results with expandable audit trail
- CSV export downloads correctly
</verification>

<success_criteria>
Staff has complete consent management: template library, global overview with filters/export, bulk send, and full audit trail visibility.
</success_criteria>

<output>
After completion, create `.planning/phases/08-patient-portal-advanced/08-04-SUMMARY.md`
</output>
