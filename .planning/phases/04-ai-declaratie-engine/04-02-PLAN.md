---
phase: 04-ai-declaratie-engine
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - apps/web/src/components/declaratie/ai-declaratie-panel.tsx
  - apps/web/src/app/(dashboard)/billing/page.tsx
autonomous: true
requirements:
  - AI-01
  - AI-03
  - BILL-02

must_haves:
  truths:
    - "Dentist can type a natural language description and receive NZa code suggestions with confidence and warnings"
    - "Dentist reviews all AI suggestions (with reasoning, corrections, companion codes, opmerkingen warnings) before committing to invoice"
    - "Confirmed suggestions become actual invoice lines in the billing system"
  artifacts:
    - path: "apps/web/src/components/declaratie/ai-declaratie-panel.tsx"
      provides: "AI declaratie input + review panel component"
      exports: ["AIDeclaratiePanel"]
    - path: "apps/web/src/app/(dashboard)/billing/page.tsx"
      provides: "Billing page with AI declaratie integration"
      contains: "AIDeclaratiePanel"
  key_links:
    - from: "apps/web/src/components/declaratie/ai-declaratie-panel.tsx"
      to: "/api/ai/treatment-chat"
      via: "authFetch POST"
      pattern: "authFetch.*treatment-chat"
    - from: "apps/web/src/components/declaratie/ai-declaratie-panel.tsx"
      to: "apps/web/src/app/(dashboard)/billing/page.tsx"
      via: "onConfirm callback passing confirmed lines"
      pattern: "onConfirm"
---

<objective>
Build the AI declaratie review panel and integrate it into the billing page so dentists can type what they did and review AI-suggested NZa codes before creating invoice lines.

Purpose: This is the user-facing deliverable of Phase 4. The AI pipeline exists (Phase 4 Plan 01 added opmerkingen validation). Now the dentist needs a dedicated UI to (1) type natural language input, (2) see AI suggestions with confidence/warnings/reasoning, and (3) confirm selections that become real invoice lines.

Output: AIDeclaratiePanel component integrated into the billing page's invoice creation workflow.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ai-declaratie-engine/04-RESEARCH.md
@.planning/phases/04-ai-declaratie-engine/04-01-SUMMARY.md

@apps/web/src/app/(dashboard)/billing/page.tsx
@apps/web/src/components/treatments/treatment-plan-overlay.tsx
@apps/web/src/lib/auth-fetch.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build AIDeclaratiePanel component</name>
  <files>
    apps/web/src/components/declaratie/ai-declaratie-panel.tsx
  </files>
  <action>
Create `apps/web/src/components/declaratie/ai-declaratie-panel.tsx`:

**Props:**
```typescript
interface AIDeclaratiePanelProps {
  patientId: string;
  patientName: string;
  patientAge?: number;
  onConfirm: (lines: ConfirmedLine[]) => void;
  onClose: () => void;
}

interface ConfirmedLine {
  nzaCode: string;
  nzaCodeId: string;
  description: string;
  unitPrice: string;
  tooth?: string;
  quantity: number;
}
```

**Layout — two sections stacked vertically:**

1. **Input section (top):**
   - A textarea where the dentist types what they did in plain Dutch (placeholder: "Beschrijf de behandeling, bijv. 'composiet vulling 36 MOD met verdoving'")
   - A "Analyseer" primary button that sends the text to `/api/ai/treatment-chat` via authFetch
   - Loading state with spinner while waiting for AI response
   - Optional: tooth number pills/chips if the dentist mentions specific teeth

2. **Review section (bottom, shown after AI responds):**
   - A list of suggested NZa lines, each showing:
     - Checkbox (checked by default for high confidence, unchecked for medium)
     - NZa code + description
     - Tooth number (if applicable)
     - Tariff (formatted as EUR)
     - Confidence badge: green "Hoog" / yellow "Gemiddeld"
     - If `corrected: true`: info icon with tooltip showing corrections array
     - If `isCompanion: true`: small label "Automatisch toegevoegd"
     - If `warnings` array non-empty: orange/red warning badges with Dutch messages from opmerkingen validator
     - AI reasoning in a collapsible section
   - Total tariff of selected lines at the bottom
   - "Bevestigen" button that calls `onConfirm` with only the checked lines
   - "Annuleren" button that calls `onClose`

**Styling:** Use existing shadcn/ui components (Button, Checkbox from ui/). Use Tailwind classes consistent with the dashboard design (bg-white, border, rounded-lg, shadow-sm). Use lucide-react icons (Sparkles for AI, AlertTriangle for warnings, Info for corrections, Check for confirm).

**API call pattern:**
- Use `authFetch` from `@/lib/auth-fetch`
- POST to `/api/ai/treatment-chat` with body: `{ message: inputText, patientId, context: 'declaratie' }`
- Parse response: `suggestions` array with `{ nzaCode, nzaCodeId, description, unitPrice, confidence, corrected, corrections, isCompanion, warnings, reasoning, tooth }`

**State management:**
- `input: string` — textarea value
- `loading: boolean` — API call in progress
- `suggestions: Suggestion[]` — AI response
- `selected: Set<number>` — indices of checked suggestions
  </action>
  <verify>
    Run `pnpm --filter @dentflow/web build` — must succeed.
    File exists at `apps/web/src/components/declaratie/ai-declaratie-panel.tsx`.
    Exports `AIDeclaratiePanel`.
  </verify>
  <done>
    AIDeclaratiePanel renders an input area, sends to treatment-chat API, displays suggestions with confidence/warnings/corrections, and calls onConfirm with selected lines.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate AIDeclaratiePanel into billing page invoice creation</name>
  <files>
    apps/web/src/app/(dashboard)/billing/page.tsx
  </files>
  <action>
Enhance the billing page to include AI-assisted declaratie creation:

1. **Add AI tab/button to NewInvoiceModal or billing page:**
   - Look at the existing NewInvoiceModal in billing/page.tsx. It likely has a manual code selection flow (CodeBrowserPanel from Phase 3).
   - Add a tab or toggle that switches between "Handmatig" (manual CodeBrowserPanel) and "AI Assistent" (AIDeclaratiePanel).
   - Use shadcn Tabs component if available, or simple button toggle.

2. **Wire onConfirm callback:**
   - When dentist confirms AI suggestions, the confirmed lines should be added to the invoice's line items (same data structure as manually added lines).
   - Each confirmed line maps to: `{ nzaCode, nzaCodeId, description, unitPrice, quantity: 1, tooth }`.
   - After adding AI lines, the dentist can still manually add more lines or edit quantities.

3. **Wire patient context:**
   - Pass `patientId`, `patientName`, and `patientAge` (if available from the selected patient) to AIDeclaratiePanel.
   - The billing page already has patient selection — use that context.

4. **Import AIDeclaratiePanel** at the top of the billing page file.

**Important:** Do NOT modify any existing API routes. Only modify the billing page.tsx client code and import the new component.
  </action>
  <verify>
    Run `pnpm --filter @dentflow/web build` — must succeed.
    Grep for "AIDeclaratiePanel" in billing/page.tsx to confirm integration.
    Grep for "onConfirm" in billing/page.tsx to confirm wiring.
  </verify>
  <done>
    Billing page has AI tab in invoice creation. Dentist can type treatment description, review AI suggestions with warnings and confidence, and confirm to add lines to the invoice. Manual code selection still works alongside AI.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @dentflow/web build` passes
2. AIDeclaratiePanel component exists and exports correctly
3. Billing page imports and renders AIDeclaratiePanel
4. AI suggestions show confidence badges, correction info, companion labels, and opmerkingen warnings
5. Confirmed AI suggestions become invoice line items
6. Manual CodeBrowserPanel still works alongside AI
</verification>

<success_criteria>
- Dentist can type "composiet vulling 36 MOD" in the AI panel and receive suggested NZa codes
- Each suggestion shows confidence level, corrections (if any), companion code labels, and opmerkingen warnings
- Dentist can check/uncheck suggestions and confirm to add them as invoice lines
- Manual code selection (CodeBrowserPanel) remains available as an alternative
- Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-ai-declaratie-engine/04-02-SUMMARY.md`
</output>
