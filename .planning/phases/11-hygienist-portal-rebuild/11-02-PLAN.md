---
phase: 11-hygienist-portal-rebuild
plan: 02
type: execute
wave: 2
depends_on: [11-01]
files_modified:
  - apps/web/src/components/hygienist/periodontogram/perio-chart.tsx
  - apps/web/src/components/hygienist/periodontogram/perio-entry-panel.tsx
  - apps/web/src/components/hygienist/periodontogram/perio-keypad.tsx
  - apps/web/src/components/hygienist/periodontogram/tooth-svg.tsx
  - apps/web/src/app/(hygienist)/hygienist/patients/[id]/perio/page.tsx
  - apps/web/src/app/api/hygienist/perio-sessions/route.ts
  - apps/web/src/app/api/hygienist/perio-sessions/[id]/route.ts
autonomous: true
requirements: [HYG-02, CLIN-06, CLIN-07]

must_haves:
  truths:
    - "Hygienist can open periodontogram page for any patient"
    - "Hygienist can enter probing depths sequentially with auto-advance"
    - "BOP is recorded per site during probing (after depth entry)"
    - "Missing teeth are auto-skipped during sequential entry"
    - "2D SVG chart shows teeth with color-coded depth bars"
    - "Data saves to relational PerioSession/PerioSite tables"
    - "Undo/redo works during charting session"
  artifacts:
    - path: "apps/web/src/components/hygienist/periodontogram/perio-chart.tsx"
      provides: "2D SVG periodontogram visualization"
      min_lines: 150
    - path: "apps/web/src/components/hygienist/periodontogram/perio-entry-panel.tsx"
      provides: "Sequential auto-advance data entry"
      min_lines: 200
    - path: "apps/web/src/app/api/hygienist/perio-sessions/route.ts"
      provides: "GET list + POST create perio sessions"
      exports: ["GET", "POST"]
  key_links:
    - from: "perio-entry-panel.tsx"
      to: "/api/hygienist/perio-sessions"
      via: "fetch POST with auto-save debounce"
      pattern: "fetch.*api/hygienist/perio-sessions"
    - from: "perio-chart.tsx"
      to: "perio-entry-panel.tsx"
      via: "shared perio data state on page"
      pattern: "PerioSite|probingDepth"
---

<objective>
Build the core 2D periodontogram: SVG visualization with color-coded depth bars and sequential auto-advance data entry panel with on-screen keypad, BOP recording, undo/redo, and auto-save to relational PerioSession/PerioSite tables.

Purpose: This is THE centerpiece feature of Phase 11 — the periodontogram that hygienists use every day.
Output: Working periodontogram page with entry + visualization + API persistence.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-hygienist-portal-rebuild/11-RESEARCH.md
@.planning/phases/11-hygienist-portal-rebuild/11-01-SUMMARY.md
@apps/web/src/components/odontogram/modes/perio-mode.tsx
@apps/web/src/components/odontogram/perio/probing-panel.tsx
@packages/shared-types/src/odontogram.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Perio API routes + SVG tooth component + entry state machine</name>
  <files>
    apps/web/src/app/api/hygienist/perio-sessions/route.ts
    apps/web/src/app/api/hygienist/perio-sessions/[id]/route.ts
    apps/web/src/components/hygienist/periodontogram/tooth-svg.tsx
    apps/web/src/components/hygienist/periodontogram/perio-keypad.tsx
  </files>
  <action>
**API routes:**

`/api/hygienist/perio-sessions/route.ts`:
- GET: List perio sessions for a patient (query param `patientId`). Include PerioSite[] in response. Auth via `access_token` (staff auth). Filter by practiceId from JWT.
- POST: Create new PerioSession with sites array. Accept `{ patientId, appointmentId?, sessionType, sessionNote?, sites: Array<{toothNumber, surface, sitePosition, probingDepth, gingivalMargin, bleeding, plaque, suppuration, mobility?, furcationGrade?, isImplant?, toothNote?, keratinizedWidth?}> }`. Create session + bulk create sites in transaction.

`/api/hygienist/perio-sessions/[id]/route.ts`:
- GET: Single session with all sites.
- PUT: Update session — upsert sites (delete existing + recreate for simplicity). Used by auto-save.
- DELETE: Delete session + cascade sites.

**tooth-svg.tsx:** Extract tooth silhouette SVGs from existing `perio-mode.tsx` ToothSilhouette component. Create a standalone `<ToothSVG toothNumber={number} />` component that renders the correct tooth type SVG based on FDI number. Map FDI numbers to 8 tooth types (incisor, canine, premolar, molar for upper/lower). Keep it simple — outline only, ~60px wide, used in the chart.

**perio-keypad.tsx:** On-screen numeric keypad component for tablet use. Grid of buttons 0-9 plus BOP toggle (red dot), plaque toggle, and undo button. Detects touch device via `ontouchstart in window`. Shows keypad on touch devices, hides on desktop (keyboard input). Fires `onDigit(n)`, `onBOP(bool)`, `onPlaque(bool)`, `onUndo()` callbacks.
  </action>
  <verify>Run `pnpm --filter @dentflow/web build` — no errors. API routes compile.</verify>
  <done>API routes handle CRUD for perio sessions with relational sites. ToothSVG renders all tooth types. Keypad component ready for entry panel.</done>
</task>

<task type="auto">
  <name>Task 2: 2D SVG periodontogram chart + sequential entry panel + perio page</name>
  <files>
    apps/web/src/components/hygienist/periodontogram/perio-chart.tsx
    apps/web/src/components/hygienist/periodontogram/perio-entry-panel.tsx
    apps/web/src/app/(hygienist)/hygienist/patients/[id]/perio/page.tsx
  </files>
  <action>
**perio-entry-panel.tsx — Sequential auto-advance entry:**

Use `useReducer` with action history for undo/redo (per research pattern).

State machine:
- `phase`: 'buccal' | 'lingual'
- `currentToothIndex`: index into presentTeeth array
- `currentSiteIndex`: 0=mesial, 1=mid, 2=distal
- `awaitingBOP`: boolean — after depth entry, wait for BOP yes/no before advancing
- `presentTeeth`: FDI numbers of non-missing teeth (from patient tooth data)
- `undoStack` / `redoStack`: PerioAction[]

Buccal order: [18,17,16,15,14,13,12,11,21,22,23,24,25,26,27,28]. Then lingual same order.
Auto-skip teeth not in `presentTeeth`.

Flow per site: User enters digit (0-9) for probing depth -> state sets `awaitingBOP=true` -> user taps BOP yes/no -> advance to next site. After 3 sites (mesial, mid, distal) on buccal, advance to next tooth. After all buccal teeth, switch to lingual phase.

Keyboard support: digits 0-9 for depth, 'b' for BOP toggle, space for no-BOP, Ctrl+Z undo, Ctrl+Shift+Z redo.

Auto-save: Debounce 2 seconds after last input. PUT to `/api/hygienist/perio-sessions/[id]` with current sites data. Show subtle "Saving..." / "Saved" indicator.

Display: Current tooth number prominently, current surface/site, progress bar (e.g., "Tooth 5 of 28 — Buccal"), the 3 site depths for current tooth.

**perio-chart.tsx — 2D SVG visualization:**

Layout: Two rows — buccal on top, lingual on bottom. Each row shows present teeth left-to-right (18→28 for upper, 48→38 for lower... wait, this is per-arch). Actually: single patient's teeth in FDI order. Buccal row shows buccal measurements, lingual row shows lingual/palatal measurements.

Per tooth in chart:
- ToothSVG silhouette at bottom
- 3 vertical bars above tooth (mesial, mid, distal) — height proportional to probing depth
- Color coding: green <=3mm, yellow 4-5mm, orange 6mm, red 7+mm (static class map, NOT dynamic interpolation)
- Red dots for BOP sites
- Blue dots for plaque sites
- Gingival margin line connecting all teeth (recession visualization)
- Tooth number label below

Highlight currently-being-entered tooth with a subtle border/glow.

Missing teeth are NOT shown (collapsed) — only present teeth rendered.

**perio/page.tsx — Perio page:**

Full-page layout: Left 60% = perio-chart.tsx (SVG visualization), Right 40% = perio-entry-panel.tsx (entry controls + keypad).

Top bar: Patient name, session selector dropdown (existing sessions), "New Session" button, session type badge.

On mount: Fetch existing sessions for patient. If sessions exist, load most recent. If not, prompt to start new session.

Summary stats bar between chart and entry: BOP%, Plaque% (O'Leary), Mean PD, Sites >=6mm count. Calculate from current session data using the formula from research.

Import perio-keypad.tsx into the entry panel.
  </action>
  <verify>Run `pnpm --filter @dentflow/web build` — no errors. Navigate to `/hygienist/patients/[id]/perio` — page renders.</verify>
  <done>Periodontogram page shows 2D SVG chart with color-coded depths, sequential entry works with auto-advance and BOP, auto-save persists to PerioSession/PerioSite, undo/redo functional, missing teeth skipped</done>
</task>

</tasks>

<verification>
- `pnpm --filter @dentflow/web build` succeeds
- Perio page renders at `/hygienist/patients/[id]/perio`
- Sequential entry advances through teeth correctly
- Chart updates in real-time as data is entered
- Auto-save writes to database
</verification>

<success_criteria>
Hygienist can open periodontogram for a patient, enter probing depths sequentially with auto-advance, record BOP per site, see color-coded 2D SVG visualization update in real-time, and data persists to relational PerioSession/PerioSite tables with auto-save.
</success_criteria>

<output>
After completion, create `.planning/phases/11-hygienist-portal-rebuild/11-02-SUMMARY.md`
</output>
