---
phase: 07-patient-portal-core
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/app/(patient)/portal/appointments/page.tsx
  - apps/web/src/app/api/patient-portal/appointments/[id]/cancel/route.ts
  - apps/web/src/app/api/patient-portal/appointments/[id]/reschedule/route.ts
  - apps/web/src/app/api/patient-portal/appointments/[id]/ics/route.ts
autonomous: true
requirements: [PORT-01]

must_haves:
  truths:
    - "Patient sees Upcoming and Past tabs for appointments"
    - "Patient can cancel an appointment 24+ hours before with a reason"
    - "Patient can reschedule an appointment 24+ hours before by selecting from 5 available slots"
    - "Patient can download .ics calendar file for any upcoming appointment"
    - "Past appointment cards expand to show treatments performed"
    - "Reminder status badge shown on upcoming cards"
    - "Empty state shows friendly message with Book appointment CTA"
  artifacts:
    - path: "apps/web/src/app/(patient)/portal/appointments/page.tsx"
      provides: "Card-based appointment view with Upcoming/Past tabs"
    - path: "apps/web/src/app/api/patient-portal/appointments/[id]/reschedule/route.ts"
      provides: "GET available slots + POST reschedule"
      exports: ["GET", "POST"]
    - path: "apps/web/src/app/api/patient-portal/appointments/[id]/ics/route.ts"
      provides: "ICS calendar file download"
      exports: ["GET"]
  key_links:
    - from: "appointments/page.tsx"
      to: "/api/patient-portal/appointments/[id]/reschedule"
      via: "fetch for available slots"
      pattern: "fetch.*reschedule"
    - from: "appointments/page.tsx"
      to: "/api/patient-portal/appointments/[id]/ics"
      via: "download link"
      pattern: "ics"
---

<objective>
Enhanced appointment page with Upcoming/Past tabs, cancel with reason, reschedule flow, .ics export, expandable past cards, and reminder badges.

Purpose: PORT-01 -- patients need full appointment visibility and self-service management.
Output: Complete appointment experience matching all CONTEXT decisions.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-patient-portal-core/07-CONTEXT.md
@.planning/phases/07-patient-portal-core/07-RESEARCH.md
@apps/web/src/app/(patient)/portal/appointments/page.tsx
@apps/web/src/app/api/patient-portal/appointments/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build reschedule and .ics API routes</name>
  <files>apps/web/src/app/api/patient-portal/appointments/[id]/reschedule/route.ts, apps/web/src/app/api/patient-portal/appointments/[id]/ics/route.ts, apps/web/src/app/api/patient-portal/appointments/[id]/cancel/route.ts</files>
  <action>
**Install ics package:** `pnpm --filter @dentflow/web add ics`

**reschedule/route.ts:**
- GET: Verify patient owns appointment. Check 24h rule (`startTime - Date.now() >= 24*60*60*1000`). Return 403 if too late. Find next 5 available slots for the SAME practitioner: query Schedule for practitioner's working hours, query existing Appointments to find gaps, return 5 slots of same duration as current appointment. Each slot: `{ date: string, startTime: string, endTime: string }`.
- POST: Accept `{ slotStart: string }`. Verify 24h rule again. Verify slot is still available (optimistic lock). Update appointment startTime/endTime. Return updated appointment. Practice notification: create a system message or log (use existing notification pattern if any, otherwise just update the appointment).

**ics/route.ts:**
- GET: Verify patient owns appointment. Use `ics` package `createEvent()`. Include: title "Tandarts afspraak - {type}", start/duration from appointment, location from practice name, description with practitioner name. Return `text/calendar` content with `Content-Disposition: attachment; filename="afspraak.ics"`.

**cancel/route.ts (modify existing):**
- Add 24h rule check (return 403 with Dutch message if < 24h)
- Require `reason` field in request body (string, from a predefined list: "Kan niet komen", "Voel me niet lekker", "Wil andere datum", "Andere reden")
- Store reason in appointment notes or a new cancellationReason field
- Keep existing cancel logic otherwise
  </action>
  <verify>`pnpm --filter @dentflow/web build` passes. Test with curl: GET /api/patient-portal/appointments/{id}/reschedule returns slots array. GET /api/patient-portal/appointments/{id}/ics returns text/calendar content.</verify>
  <done>Three API routes handle reschedule (GET slots + POST), .ics download, and cancel with 24h rule + reason.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite appointments page with tabs, reschedule, .ics, expandable past cards</name>
  <files>apps/web/src/app/(patient)/portal/appointments/page.tsx</files>
  <action>
Rewrite the appointments page with these features:

**Tab bar:** Two tabs at top -- "Aankomend" (upcoming) and "Afgelopen" (past). Use glass-style tab buttons. Upcoming = appointments where startTime > now and status not CANCELLED. Past = startTime <= now or COMPLETED/CANCELLED.

**Upcoming appointment cards (card-based layout per CONTEXT):**
- Glass card with: date/time (formatted Dutch), practitioner name, appointment type badge, duration, location/room, notes preview (truncated)
- Reminder status badge: small pill showing "SMS verstuurd", "Email verstuurd", etc. (from appointment.reminderSentAt or similar field -- check schema)
- "Agenda toevoegen" button (CalendarPlus icon) -> calls /api/patient-portal/appointments/{id}/ics and triggers download
- "Wijzigen" button -> opens reschedule modal (only if 24h+ away, otherwise grayed out with tooltip "Kan niet meer wijzigen")
- "Annuleren" button -> opens cancel dialog with reason dropdown (only if 24h+ away)

**Reschedule modal:**
- Shows "Kies een nieuw tijdstip" heading
- Fetches GET /reschedule for 5 available slots
- List of 5 slot cards (date, time range), patient clicks one
- Confirm button POSTs to /reschedule
- Success: close modal, refresh appointments, show toast

**Cancel dialog:**
- "Weet u het zeker?" confirmation
- Reason select dropdown: "Kan niet komen", "Voel me niet lekker", "Wil andere datum", "Andere reden"
- Confirm sends PATCH to /cancel with reason
- Success: refresh appointments, show toast

**Past appointment cards:**
- Collapsed by default, show date/time/type/practitioner
- Expandable (click or chevron) to show treatments performed -- fetch from treatment plan data linked to this appointment
- Treatment summary: list of treatment names + tooth numbers (NOT clinical notes per CONTEXT)
- COMPLETED badge in green, CANCELLED in gray, NO_SHOW in red

**Empty state:** When no upcoming appointments, show friendly illustration-style message "U heeft geen komende afspraken" with orange "Afspraak maken" CTA button (links to booking -- since booking is Phase 8, make it a placeholder or link to practice phone).

Glass UI styling throughout. Use lucide-react icons.
  </action>
  <verify>`pnpm --filter @dentflow/web build` passes. Visit /portal/appointments -- tabs switch between upcoming/past. Cards show all required info. Cancel/reschedule modals work.</verify>
  <done>Appointment page has Upcoming/Past tabs, card layout, cancel with reason + 24h rule, reschedule with 5 slots, .ics download, expandable past cards, reminder badges, empty state.</done>
</task>

</tasks>

<verification>
- `pnpm --filter @dentflow/web build` passes
- Upcoming tab shows appointment cards with all details
- Cancel enforces 24h rule and requires reason
- Reschedule shows 5 slots for same practitioner
- .ics download produces valid calendar file
- Past tab shows expandable cards with treatment summary
</verification>

<success_criteria>
Complete appointment self-service: view, cancel, reschedule, calendar export, treatment history -- all matching CONTEXT decisions exactly.
</success_criteria>

<output>
After completion, create `.planning/phases/07-patient-portal-core/07-02-SUMMARY.md`
</output>
