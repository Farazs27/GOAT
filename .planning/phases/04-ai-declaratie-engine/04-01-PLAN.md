---
phase: 04-ai-declaratie-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/lib/ai/category-triggers.ts
  - apps/web/src/lib/ai/opmerkingen-validator.ts
  - apps/web/src/lib/ai/pii-guard.ts
  - apps/web/src/app/api/ai/analyze-notes/route.ts
  - apps/web/src/app/api/ai/treatment-chat/route.ts
autonomous: true
requirements:
  - AI-02
  - AI-03

must_haves:
  truths:
    - "AI suggestions are checked against NZa opmerkingen rules and return warnings for rejection risks"
    - "CATEGORY_TRIGGERS is maintained in one place, not duplicated across routes"
    - "PII patterns in prompt text are detected and blocked before reaching Gemini"
  artifacts:
    - path: "apps/web/src/lib/ai/category-triggers.ts"
      provides: "Shared CATEGORY_TRIGGERS and getRelevantCategories"
      exports: ["CATEGORY_TRIGGERS", "getRelevantCategories"]
    - path: "apps/web/src/lib/ai/opmerkingen-validator.ts"
      provides: "NZa opmerkingen validation with rejection risk flagging"
      exports: ["validateOpmerkingen", "OpmerkingenWarning"]
    - path: "apps/web/src/lib/ai/pii-guard.ts"
      provides: "PII detection guard for AI prompts"
      exports: ["assertNoPII"]
  key_links:
    - from: "apps/web/src/app/api/ai/treatment-chat/route.ts"
      to: "apps/web/src/lib/ai/opmerkingen-validator.ts"
      via: "import validateOpmerkingen"
      pattern: "validateOpmerkingen"
    - from: "apps/web/src/app/api/ai/analyze-notes/route.ts"
      to: "apps/web/src/lib/ai/category-triggers.ts"
      via: "import shared triggers"
      pattern: "from.*category-triggers"
    - from: "apps/web/src/app/api/ai/treatment-chat/route.ts"
      to: "apps/web/src/lib/ai/category-triggers.ts"
      via: "import shared triggers"
      pattern: "from.*category-triggers"
---

<objective>
Extract shared AI utilities and add NZa opmerkingen rejection risk validation to the existing AI pipeline.

Purpose: The AI detection pipeline exists but (1) CATEGORY_TRIGGERS is duplicated across two routes, (2) there is no opmerkingen-based rejection risk flagging, and (3) there is no PII guard. This plan fixes all three backend gaps before the review UI is built.

Output: Three new shared modules (category-triggers, opmerkingen-validator, pii-guard) integrated into both AI API routes.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ai-declaratie-engine/04-RESEARCH.md

@apps/web/src/app/api/ai/analyze-notes/route.ts
@apps/web/src/app/api/ai/treatment-chat/route.ts
@apps/web/src/lib/ai/treatment-validator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract shared category-triggers and add PII guard</name>
  <files>
    apps/web/src/lib/ai/category-triggers.ts
    apps/web/src/lib/ai/pii-guard.ts
    apps/web/src/app/api/ai/analyze-notes/route.ts
    apps/web/src/app/api/ai/treatment-chat/route.ts
  </files>
  <action>
1. Create `apps/web/src/lib/ai/category-triggers.ts`:
   - Move the `CATEGORY_TRIGGERS` constant and `getRelevantCategories` function from `analyze-notes/route.ts` (they are duplicated in both routes).
   - Export both. Keep the exact same logic — keyword arrays mapping category names to trigger words.
   - Also move `buildCodebookPrompt` if it exists in both routes (or keep it route-specific if different).

2. Create `apps/web/src/lib/ai/pii-guard.ts`:
   - Export `assertNoPII(text: string): void` that throws if PII patterns detected.
   - Check for: BSN patterns (9-digit numbers), email patterns, Dutch phone patterns (06-xxxxx, +31), and common PII field markers ("naam:", "geboortedatum:", "adres:").
   - This is a safety net — the routes already only receive clinical text, but this prevents future regressions.

3. Update `analyze-notes/route.ts`:
   - Replace local CATEGORY_TRIGGERS and getRelevantCategories with imports from `category-triggers.ts`.
   - Add `assertNoPII(combinedText)` call before the Gemini fetch.
   - Delete the now-duplicated local definitions.

4. Update `treatment-chat/route.ts`:
   - Same as above: import from `category-triggers.ts`, add `assertNoPII`, delete local duplicates.
  </action>
  <verify>
    Run `pnpm --filter @dentflow/web build` — must succeed with no TypeScript errors.
    Confirm both routes import from `category-triggers.ts` (grep for "from.*category-triggers" in both files).
    Confirm local CATEGORY_TRIGGERS definitions are removed from both route files.
  </verify>
  <done>
    CATEGORY_TRIGGERS lives in one shared file. Both AI routes import from it. PII guard exists and is called before every Gemini request.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build opmerkingen validator and integrate into AI pipeline</name>
  <files>
    apps/web/src/lib/ai/opmerkingen-validator.ts
    apps/web/src/app/api/ai/treatment-chat/route.ts
    apps/web/src/app/api/ai/analyze-notes/route.ts
  </files>
  <action>
1. Create `apps/web/src/lib/ai/opmerkingen-validator.ts`:
   - Export interface `OpmerkingenWarning { code: string; ruleType: 'frequency' | 'age' | 'combination' | 'indication' | 'general'; severity: 'error' | 'warning' | 'info'; message: string; }`.
   - Export `validateOpmerkingen(suggestions: Array<{ code: string; [key: string]: unknown }>, context: { patientAge?: number; recentCodes?: Array<{ code: string; date: string }> }): OpmerkingenWarning[]`.
   - Implement 10-15 critical hard-coded rules based on common NZa opmerkingen:
     - X10 (bitewing): max 2x/jaar for adults (18+), unlimited for <18
     - X21 (OPG): max 1x per 3 jaar unless indication
     - C-codes (consultatie): C11 max 2x/jaar, C13 max 1x/jaar
     - V-codes (vullingen): cannot combine V-code with R-code (kroon) on same tooth same day
     - M-codes (preventie): M01/M02 max 2x/jaar, age-dependent
     - E-codes (endo): E97 (herbehandeling) requires prior E-code on same tooth
     - T-codes (tandsteen): T21/T22 max 2x/jaar for adults
     - A15 (oppervlakte-anesthesie): cannot combine with A10 in same region (already in validator, but add as opmerkingen warning too)
   - For each rule, return a Dutch warning message (e.g., "X10: maximaal 2x per jaar voor patiënten ≥18 jaar (NZa opmerking)")
   - Also export `enrichSuggestionsWithWarnings` that takes validated suggestions and returns them with a `warnings: OpmerkingenWarning[]` field.

2. Integrate into `treatment-chat/route.ts`:
   - After the existing `validateAndCorrectSuggestions` call, run `validateOpmerkingen` on the validated suggestions.
   - Attach warnings to each suggestion in the response JSON (add `warnings` array to each suggestion object).
   - Pass patient age from the request body if available (the route already receives patient context).

3. Integrate into `analyze-notes/route.ts`:
   - After DB enrichment, run `validateOpmerkingen` on the detected lines.
   - Attach warnings to each detected line in the response.
  </action>
  <verify>
    Run `pnpm --filter @dentflow/web build` — must succeed.
    Grep for "validateOpmerkingen" in both route files to confirm integration.
    Grep for "OpmerkingenWarning" in opmerkingen-validator.ts to confirm export.
  </verify>
  <done>
    Both AI routes return suggestions/detected lines with an attached `warnings` array. Each warning has code, ruleType, severity, and Dutch message. At least 10 opmerkingen rules are implemented.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @dentflow/web build` passes
2. `grep -r "CATEGORY_TRIGGERS" apps/web/src/app/api/ai/` returns only import statements, not definitions
3. `grep -r "validateOpmerkingen" apps/web/src/app/api/ai/` shows usage in both routes
4. `grep -r "assertNoPII" apps/web/src/app/api/ai/` shows usage in both routes
5. `apps/web/src/lib/ai/opmerkingen-validator.ts` exports OpmerkingenWarning type and validateOpmerkingen function
</verification>

<success_criteria>
- CATEGORY_TRIGGERS extracted to single shared module, both routes import it
- Opmerkingen validator has 10+ hard-coded NZa rules returning Dutch warnings
- Both AI routes return warnings alongside suggestions
- PII guard prevents accidental patient data leakage to Gemini
- Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-ai-declaratie-engine/04-01-SUMMARY.md`
</output>
