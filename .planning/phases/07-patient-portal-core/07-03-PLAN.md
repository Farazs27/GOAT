---
phase: 07-patient-portal-core
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - apps/web/src/app/(patient)/portal/messages/page.tsx
  - apps/web/src/app/api/patient-portal/conversations/route.ts
  - apps/web/src/app/api/patient-portal/conversations/[id]/route.ts
  - apps/web/src/app/api/patient-portal/conversations/[id]/status/route.ts
  - apps/web/src/app/api/patient-portal/conversations/[id]/attachments/route.ts
autonomous: true
requirements: [PORT-04]

must_haves:
  truths:
    - "Patient sees a list of conversation threads with subject and last message preview"
    - "Patient can start a new conversation by selecting a practitioner and entering a subject"
    - "Patient can send and receive messages in WhatsApp-style chat bubbles"
    - "Patient can attach images and documents to messages"
    - "Conversations show open/closed status and patient can reopen closed threads"
  artifacts:
    - path: "apps/web/src/app/(patient)/portal/messages/page.tsx"
      provides: "Threaded conversation UI with chat bubbles"
    - path: "apps/web/src/app/api/patient-portal/conversations/route.ts"
      provides: "GET conversation list, POST new conversation"
      exports: ["GET", "POST"]
    - path: "apps/web/src/app/api/patient-portal/conversations/[id]/route.ts"
      provides: "GET messages, POST reply"
      exports: ["GET", "POST"]
  key_links:
    - from: "messages/page.tsx"
      to: "/api/patient-portal/conversations"
      via: "fetch conversation list"
      pattern: "fetch.*conversations"
    - from: "messages/page.tsx"
      to: "/api/patient-portal/conversations/[id]"
      via: "fetch messages and post replies"
      pattern: "fetch.*conversations/"
---

<objective>
Threaded messaging system for patients: conversation list, WhatsApp-style chat UI, new conversation creation, attachments, and open/closed status.

Purpose: PORT-04 -- patients need to communicate with their practitioners through organized conversation threads.
Output: Full patient-side messaging experience with all CONTEXT decisions implemented.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-patient-portal-core/07-CONTEXT.md
@.planning/phases/07-patient-portal-core/07-RESEARCH.md
@.planning/phases/07-patient-portal-core/07-01-SUMMARY.md
@apps/web/src/app/(patient)/portal/messages/page.tsx
@packages/database/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build conversation API routes</name>
  <files>apps/web/src/app/api/patient-portal/conversations/route.ts, apps/web/src/app/api/patient-portal/conversations/[id]/route.ts, apps/web/src/app/api/patient-portal/conversations/[id]/status/route.ts, apps/web/src/app/api/patient-portal/conversations/[id]/attachments/route.ts</files>
  <action>
All routes: validate patient_token from Bearer header, extract patientId, scope all queries to that patient.

**conversations/route.ts:**
- GET: List patient's conversations ordered by updatedAt desc. Include: id, subject, status, practitioner name, lastMessage (content + createdAt + senderType), unreadCount (ConversationMessage where isRead=false and senderType=STAFF). Also include a `practitioners` array: query all Users in the patient's practice with role DENTIST or HYGIENIST (for the new conversation practitioner selector). Return `{ conversations: [...], practitioners: [...] }`.
- POST: Create new conversation. Body: `{ practitionerId: string, subject: string, message: string }`. Validate practitionerId belongs to patient's practice. Create Conversation + first ConversationMessage (senderType=PATIENT). Return conversation with messages.

**conversations/[id]/route.ts:**
- GET: Verify patient owns conversation. Return conversation with all messages (ordered by createdAt asc) including attachments. Mark all STAFF messages as isRead=true (patient is viewing them).
- POST: Send reply. Body: `{ content: string }`. Verify patient owns conversation. Verify conversation is OPEN (return 400 if CLOSED with message "Dit gesprek is gesloten. Heropen het gesprek om te reageren."). Create ConversationMessage with senderType=PATIENT. Update conversation.updatedAt. Return new message.

**conversations/[id]/status/route.ts:**
- PATCH: Body: `{ status: "OPEN" }`. Patient can only reopen (CLOSED -> OPEN). Staff can close (handled in staff-side API later). Verify patient owns conversation.

**conversations/[id]/attachments/route.ts:**
- POST: Accept multipart form data (file + messageId). Verify patient owns conversation. Upload file to Vercel Blob (`put(fileName, file, { access: 'public' })`). Create MessageAttachment record. Max file size: 10MB. Allowed types: image/*, application/pdf, .doc, .docx. Return attachment record.
  </action>
  <verify>`pnpm --filter @dentflow/web build` passes. Test: POST to /conversations creates a conversation, GET returns it with messages.</verify>
  <done>Four API routes handle conversation CRUD, messaging, status changes, and file attachments.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite messages page with threaded WhatsApp-style UI</name>
  <files>apps/web/src/app/(patient)/portal/messages/page.tsx</files>
  <action>
Complete rewrite of messages page as a two-panel layout (conversation list on left, chat on right):

**Left panel (conversation list):**
- "Berichten" heading with "Nieuw gesprek" button (Plus icon, orange)
- List of conversation cards: practitioner avatar/initials, subject line (bold if unread), last message preview (truncated), timestamp, unread count badge (orange pill), open/closed status indicator (green dot = open, gray = closed)
- Click selects conversation and loads right panel
- Sort by updatedAt desc

**Right panel (chat view):**
- Header: practitioner name, subject, status badge (open/closed), reopen button if closed
- Message area: scrollable, auto-scroll to bottom on new messages
- Chat bubbles: patient messages on right (orange-tinted bg), staff messages on left (glass bg). Each bubble: content, timestamp below, sender name for staff messages
- Attachment display: inline image previews (clickable to full size), document links with file icon + name + size
- Input area at bottom: text input (glass styled), attachment button (paperclip icon -> file picker), send button (orange). Disable if conversation is CLOSED (show "Heropen gesprek" button instead)
- File upload: show upload progress, preview before send for images

**New conversation modal:**
- "Nieuw gesprek" dialog
- Practitioner selector: dropdown of practitioners from patient's practice (fetch from /api/patient-portal/conversations/practitioners or inline in conversations GET)
- Subject input (free text, required)
- First message textarea (required)
- Send button creates conversation and opens it

**Responsive:** On mobile, show only conversation list. Clicking a conversation pushes to chat view with back button. On desktop, side-by-side panels.

**Polling:** Poll for new messages every 10 seconds when a conversation is open (simple setInterval, not WebSocket).

Glass UI throughout. Use lucide-react icons (MessageSquare, Send, Paperclip, ArrowLeft, Plus, CheckCircle).
  </action>
  <verify>`pnpm --filter @dentflow/web build` passes. Visit /portal/messages -- conversation list renders, new conversation modal works, chat bubbles display correctly.</verify>
  <done>Messages page shows threaded conversations with WhatsApp-style bubbles, attachments, new conversation flow, open/closed status, and responsive layout.</done>
</task>

</tasks>

<verification>
- `pnpm --filter @dentflow/web build` passes
- Patient can create new conversation with a practitioner
- Messages display as chat bubbles (patient right, staff left)
- Attachments upload and display inline
- Conversation open/closed status works with reopen
</verification>

<success_criteria>
Full patient messaging experience: threaded conversations per practitioner, WhatsApp-style UI, attachments, status management -- all CONTEXT decisions implemented.
</success_criteria>

<output>
After completion, create `.planning/phases/07-patient-portal-core/07-03-SUMMARY.md`
</output>
