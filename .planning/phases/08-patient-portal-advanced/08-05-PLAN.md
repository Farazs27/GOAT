---
phase: 08-patient-portal-advanced
plan: 05
type: execute
wave: 3
depends_on: ["08-02", "08-03", "08-04"]
files_modified:
  - apps/web/src/app/api/dashboard/appointments/approve/route.ts
  - apps/web/src/app/(dashboard)/dashboard/agenda/page.tsx
  - apps/web/src/app/(patient)/portal/layout.tsx
  - apps/web/src/app/(dashboard)/layout.tsx
autonomous: false
requirements: [PORT-06, AGND-05]

must_haves:
  truths:
    - "Staff can approve or reject pending appointment bookings"
    - "Patient sees booking status change to confirmed or rejected"
    - "Staff sees badge/notification for new consent signatures and pending bookings"
    - "Patient portal sidebar shows badge count for unsigned consent forms"
    - "Linked consent forms block check-in if unsigned — staff sees warning"
    - "Confirmation notification created after booking approval"
  artifacts:
    - path: "apps/web/src/app/api/dashboard/appointments/approve/route.ts"
      provides: "Approve/reject pending booking endpoint"
      exports: ["POST"]
    - path: "apps/web/src/app/(patient)/portal/layout.tsx"
      provides: "Patient sidebar with consent badge count"
  key_links:
    - from: "apps/web/src/app/api/dashboard/appointments/approve/route.ts"
      to: "prisma.appointment.update"
      via: "status change from PENDING_APPROVAL to CONFIRMED or REJECTED"
      pattern: "PENDING_APPROVAL"
---

<objective>
Wire together staff booking approval, notification badges for both portals, consent-linked appointment check-in warnings, and final end-to-end verification of all phase 8 features.

Purpose: Complete the staff-side approval loop for bookings and add notification/badge integration across both portals.
Output: Booking approval API, badge integration, check-in consent warnings, verified end-to-end flows.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-patient-portal-advanced/08-RESEARCH.md
@.planning/phases/08-patient-portal-advanced/08-01-SUMMARY.md
@.planning/phases/08-patient-portal-advanced/08-02-SUMMARY.md
@.planning/phases/08-patient-portal-advanced/08-03-SUMMARY.md
@.planning/phases/08-patient-portal-advanced/08-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Booking approval API and badge/notification integration</name>
  <files>
    apps/web/src/app/api/dashboard/appointments/approve/route.ts
    apps/web/src/app/(patient)/portal/layout.tsx
  </files>
  <action>
1. **Booking approval API** (`appointments/approve/route.ts`):
   - POST endpoint, authenticated via `access_token` (staff auth)
   - Body: `appointmentId`, `action` ("approve" | "reject"), `reason` (optional, for rejection)
   - Validate appointment exists, belongs to staff's practice, has status PENDING_APPROVAL
   - On approve: update status to CONFIRMED, create Notification for patient: "Uw afspraak op {date} om {time} is bevestigd"
   - On reject: update status to CANCELLED, create Notification for patient: "Uw afspraak op {date} is helaas afgewezen. {reason}"
   - Return updated appointment

2. **Patient portal sidebar badge** (modify `layout.tsx`):
   - Fetch unsigned consent form count from `/api/patient-portal/consent?status=PENDING&countOnly=true` (add countOnly param to existing consent API or use dashboard API)
   - Show badge count next to "Toestemming" or "Documenten" menu item for unsigned forms
   - If no existing consent menu item, add one: "Toestemming" with FileSignature icon

3. **Staff sidebar notification indicators**:
   - In dashboard layout or sidebar, query for: pending bookings count (PENDING_APPROVAL appointments), recent unsigned consent notifications
   - Show orange dot or count badge next to Agenda (for pending bookings) and next to Consent (for new signatures)
   - Do NOT modify the dashboard layout file structure — only add badge data fetching to existing sidebar patterns

4. **Consent-appointment link check-in warning**:
   - In the agenda/appointment detail view, when viewing an appointment that has linked ConsentForms:
     - Query consent forms with appointmentId = this appointment's ID
     - If any are PENDING (unsigned): show warning badge/banner "Toestemmingsformulier niet ondertekend" with link to consent overview
     - Staff can override (continue with check-in) but the warning is logged
   - This is informational only — implement as a visual warning in the appointment detail, not a blocking mechanism
  </action>
  <verify>Run `pnpm --filter @dentflow/web build` to verify compilation.</verify>
  <done>Booking approval creates CONFIRMED/CANCELLED status with patient notification. Patient sidebar shows consent badge. Staff sees pending booking and consent notification indicators. Appointment detail warns about unsigned linked consent.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: End-to-end verification of phase 8 features</name>
  <action>Human verification of all phase 8 features end-to-end.</action>
  <what-built>
    Complete digital signature and online booking system:
    - Consent form signing with scroll-to-bottom, dependent signing, PDF download
    - Treatment plan approval with signature
    - Online booking with practitioner-first flow, configurable window, max pending
    - Staff consent template management with bulk send and export
    - Staff booking approval workflow
    - Badge/notification integration across both portals
  </what-built>
  <how-to-verify>
    1. Log in as patient. Go to Consent/Toestemming section.
    2. If consent forms exist, verify scroll-to-bottom enables signature pad.
    3. Draw signature, select signer relation, submit. Verify toast appears.
    4. Download signed PDF. Verify signature is embedded in document.
    5. Go to Behandelplan. If PROPOSED plan exists, verify sign button appears. Sign it.
    6. Go to Appointments → Book. Verify 4-step flow: type → practitioner → date/time → confirm.
    7. Complete a booking. Verify "Wacht op bevestiging" status shown.
    8. Try booking again until max pending reached. Verify error shown.
    9. Log in as staff. Go to Consent overview. Verify signed forms show with audit trail.
    10. Create a consent template. Send it to a patient.
    11. Go to Agenda. Verify pending booking badge/indicator visible.
    12. Approve the pending booking. Verify status changes.
    13. Check consent export (CSV download).
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- `pnpm --filter @dentflow/web build` passes
- All 4 success criteria from phase goal are met
- End-to-end flows work for both patient and staff
</verification>

<success_criteria>
Staff can approve/reject bookings, both portals show appropriate badges, consent-appointment linking works with warnings, all phase 8 features verified end-to-end.
</success_criteria>

<output>
After completion, create `.planning/phases/08-patient-portal-advanced/08-05-SUMMARY.md`
</output>
