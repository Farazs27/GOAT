---
phase: 03-billing-declaratie
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/lib/invoice-number.ts
  - apps/web/src/app/api/invoices/route.ts
  - apps/web/src/app/api/invoices/[id]/route.ts
  - apps/web/src/app/api/invoices/payments/route.ts
autonomous: true
requirements:
  - BILL-01
  - BILL-04

must_haves:
  truths:
    - "Invoice lines store nzaCodeId FK linking to NzaCode table"
    - "Invoice number generation is atomic (no race condition)"
    - "Invoice status changes are validated against allowed transitions"
    - "Payment completion checks against patientAmount, not total"
  artifacts:
    - path: "apps/web/src/lib/invoice-number.ts"
      provides: "Shared invoice number generation utility"
      exports: ["generateInvoiceNumber"]
    - path: "apps/web/src/app/api/invoices/route.ts"
      provides: "Invoice creation with nzaCodeId and atomic number generation"
      contains: "nzaCodeId"
    - path: "apps/web/src/app/api/invoices/[id]/route.ts"
      provides: "Status transition validation"
      contains: "ALLOWED_TRANSITIONS"
  key_links:
    - from: "apps/web/src/app/api/invoices/route.ts"
      to: "apps/web/src/lib/invoice-number.ts"
      via: "import generateInvoiceNumber"
      pattern: "generateInvoiceNumber"
    - from: "apps/web/src/app/api/invoices/[id]/route.ts"
      to: "ALLOWED_TRANSITIONS"
      via: "status validation map"
      pattern: "ALLOWED_TRANSITIONS\\[.*currentStatus"
---

<objective>
Fix billing backend: atomic invoice numbers, nzaCodeId on lines, status transition validation, correct payment completion check.

Purpose: Backend must be correct before frontend enhancements in Plan 02.
Output: Reliable invoice API with proper data integrity and status management.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-billing-declaratie/03-RESEARCH.md

@apps/web/src/app/api/invoices/route.ts
@apps/web/src/app/api/invoices/[id]/route.ts
@apps/web/src/app/api/invoices/payments/route.ts
@apps/web/src/app/api/treatment-plans/[id]/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract shared invoice number utility and fix invoice creation</name>
  <files>
    apps/web/src/lib/invoice-number.ts
    apps/web/src/app/api/invoices/route.ts
    apps/web/src/app/api/treatment-plans/[id]/route.ts
  </files>
  <action>
1. Create `apps/web/src/lib/invoice-number.ts` with a `generateInvoiceNumber(prisma, practiceId)` function that:
   - Takes a Prisma transaction client (or regular client) and practiceId
   - Generates F{year}-{seq} pattern (find last invoice for that practice+year, increment)
   - Returns the invoice number string
   - This is currently duplicated in invoices/route.ts POST and treatment-plans/[id]/route.ts COMPLETED handler

2. Update `apps/web/src/app/api/invoices/route.ts` POST handler:
   - Wrap the entire invoice creation in `prisma.$transaction` (currently NOT in a transaction — race condition on number generation)
   - Use the new `generateInvoiceNumber` utility inside the transaction
   - When creating InvoiceLine records, pass `nzaCodeId` from the request body line items (add it alongside existing `nzaCode` string field). The request body line items should include `nzaCodeId` (optional, nullable) — if present, set it on the line.
   - Keep all existing functionality intact

3. Update `apps/web/src/app/api/treatment-plans/[id]/route.ts` COMPLETED handler:
   - Replace inline invoice number generation with `generateInvoiceNumber` utility
   - It already uses `prisma.$transaction`, so pass the transaction client `tx` to the utility
  </action>
  <verify>
Build passes: `pnpm --filter @dentflow/web build`
Grep for duplicated invoice number pattern — should only exist in invoice-number.ts now.
  </verify>
  <done>
Invoice number generation extracted to shared utility. Invoice creation is atomic (transaction). nzaCodeId accepted and stored on invoice lines. No duplicate invoice number logic.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add invoice status transition validation and fix payment completion</name>
  <files>
    apps/web/src/app/api/invoices/[id]/route.ts
    apps/web/src/app/api/invoices/payments/route.ts
  </files>
  <action>
1. Update `apps/web/src/app/api/invoices/[id]/route.ts` PATCH handler:
   - Add ALLOWED_TRANSITIONS map (same pattern as treatment-plans/[id]/route.ts):
     ```
     DRAFT -> [SENT, CANCELLED]
     SENT -> [PAID, PARTIALLY_PAID, OVERDUE, CANCELLED, CREDITED]
     PARTIALLY_PAID -> [PAID, OVERDUE, CANCELLED, CREDITED]
     PAID -> [CREDITED]
     OVERDUE -> [PAID, PARTIALLY_PAID, CANCELLED, CREDITED]
     CANCELLED -> []
     CREDITED -> []
     ```
   - When request body includes `status`, validate the transition. If invalid, return 400 with message: `Cannot transition from {current} to {requested}`.
   - When transitioning to SENT, set `sentAt: new Date()` on the invoice (add this field update).
   - Keep all other PATCH functionality (updating other fields) intact.

2. Update `apps/web/src/app/api/invoices/payments/route.ts`:
   - Fix payment completion check: compare totalPaid against `invoice.patientAmount` (not `invoice.total`). The `patientAmount` field represents what the patient actually owes after insurance. If patientAmount is 0 or null, fall back to `invoice.total`.
   - Keep all other payment logic intact.
  </action>
  <verify>
Build passes: `pnpm --filter @dentflow/web build`
Grep for ALLOWED_TRANSITIONS in invoices/[id]/route.ts — should be present.
Grep for patientAmount in payments/route.ts — should be used in completion check.
  </verify>
  <done>
Invoice PATCH validates status transitions (returns 400 on invalid). SENT transition records sentAt timestamp. Payment completion correctly checks against patientAmount.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @dentflow/web build` passes
2. `generateInvoiceNumber` exists in `apps/web/src/lib/invoice-number.ts` and is imported by both invoice routes
3. ALLOWED_TRANSITIONS map exists in invoices/[id]/route.ts
4. Invoice POST wraps creation in $transaction
5. Payment route compares against patientAmount
</verification>

<success_criteria>
- Invoice creation is atomic with no race condition on number generation
- Invoice lines can store nzaCodeId FK
- Status transitions are validated (invalid transitions return 400)
- Payment completion correctly uses patientAmount
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-billing-declaratie/03-01-SUMMARY.md`
</output>
