---
phase: 07-patient-portal-core
plan: 04
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - apps/web/src/app/(patient)/portal/behandelplan/page.tsx
  - apps/web/src/app/(patient)/portal/invoices/page.tsx
  - apps/web/src/app/(patient)/portal/profile/page.tsx
  - apps/web/src/app/(patient)/portal/documents/page.tsx
  - apps/web/src/app/api/patient-portal/documents/upload/route.ts
  - apps/web/src/app/api/patient-portal/treatment-plans/route.ts
  - apps/web/src/app/api/patient-portal/profile/route.ts
autonomous: true
requirements: [PORT-02, PORT-03, PORT-05, PORT-07]

must_haves:
  truths:
    - "Patient can view treatment plans with individual treatment costs and total estimate"
    - "Patient can view invoices and download PDF for each"
    - "Patient can view and update their personal information (name, email, phone, address)"
    - "Patient can view documents organized by category and upload new documents"
    - "Patient uploads show pending status until practice approves"
    - "X-rays open in existing full-screen viewer with zoom/pan"
  artifacts:
    - path: "apps/web/src/app/(patient)/portal/behandelplan/page.tsx"
      provides: "Treatment plan list with cost breakdowns"
    - path: "apps/web/src/app/(patient)/portal/invoices/page.tsx"
      provides: "Invoice list with PDF download"
    - path: "apps/web/src/app/(patient)/portal/profile/page.tsx"
      provides: "Editable patient profile form"
    - path: "apps/web/src/app/(patient)/portal/documents/page.tsx"
      provides: "Document viewer with upload capability"
    - path: "apps/web/src/app/api/patient-portal/documents/upload/route.ts"
      provides: "Patient document upload endpoint"
      exports: ["POST"]
  key_links:
    - from: "behandelplan/page.tsx"
      to: "/api/patient-portal/treatment-plans"
      via: "fetch treatment plans"
      pattern: "fetch.*treatment-plans"
    - from: "documents/page.tsx"
      to: "/api/patient-portal/documents/upload"
      via: "file upload"
      pattern: "fetch.*documents/upload"
---

<objective>
Enhance treatment plans, invoices, profile, and documents pages to match CONTEXT decisions. Add document upload with approval workflow.

Purpose: PORT-02, PORT-03, PORT-05, PORT-07 -- patients need to view their clinical and financial data and manage documents.
Output: Four fully functional portal pages covering treatment plans, invoices, profile editing, and document management.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-patient-portal-core/07-CONTEXT.md
@.planning/phases/07-patient-portal-core/07-RESEARCH.md
@.planning/phases/07-patient-portal-core/07-01-SUMMARY.md
@apps/web/src/app/(patient)/portal/behandelplan/page.tsx
@apps/web/src/app/(patient)/portal/invoices/page.tsx
@apps/web/src/app/(patient)/portal/profile/page.tsx
@apps/web/src/app/(patient)/portal/documents/page.tsx
@apps/web/src/app/api/patient-portal/treatment-plans/route.ts
@apps/web/src/app/api/patient-portal/invoices/route.ts
@apps/web/src/app/api/patient-portal/profile/route.ts
@apps/web/src/app/api/patient-portal/documents/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance treatment plans and invoices pages</name>
  <files>apps/web/src/app/(patient)/portal/behandelplan/page.tsx, apps/web/src/app/(patient)/portal/invoices/page.tsx, apps/web/src/app/api/patient-portal/treatment-plans/route.ts</files>
  <action>
**behandelplan/page.tsx (Treatment Plans):**
Enhance to show treatment plans as expandable glass cards:
- Each plan card: plan name/description, status badge (DRAFT/APPROVED/IN_PROGRESS/COMPLETED), created date, total estimated cost (sum of treatment costs)
- Expand to show individual treatments: tooth number(s), treatment description, NZa code if available, estimated cost per treatment
- Total cost summary at bottom of expanded card: "Geschatte kosten: EUR {total}"
- Status colors: DRAFT=gray, APPROVED=blue, IN_PROGRESS=amber, COMPLETED=green
- If no treatment plans: "Geen behandelplannen gevonden" empty state

Update /api/patient-portal/treatment-plans/route.ts if needed to include treatment costs and NZa code descriptions in response. Ensure it fetches TreatmentPlan with nested Treatment records including cost data.

**invoices/page.tsx (Invoices):**
Enhance to show invoices as glass cards:
- Each card: invoice number (F{year}-{seq}), date, total amount, status badge (DRAFT/SENT/PAID/OVERDUE)
- Status colors: DRAFT=gray, SENT=blue, PAID=green, OVERDUE=red
- "Download PDF" button on each invoice -> calls existing `/api/patient-portal/invoices/{id}/pdf` endpoint, triggers browser download
- Online payment link if applicable (or "Neem contact op" for payment instructions)
- Summary at top: total outstanding amount
- If no invoices: "Geen facturen gevonden" empty state

Glass UI styling on both pages.
  </action>
  <verify>`pnpm --filter @dentflow/web build` passes. Treatment plans page shows plans with costs. Invoices page shows invoices with PDF download button.</verify>
  <done>Treatment plans show cost breakdowns per treatment. Invoices show status and PDF download.</done>
</task>

<task type="auto">
  <name>Task 2: Enhance profile page and documents page with upload</name>
  <files>apps/web/src/app/(patient)/portal/profile/page.tsx, apps/web/src/app/(patient)/portal/documents/page.tsx, apps/web/src/app/api/patient-portal/documents/upload/route.ts, apps/web/src/app/api/patient-portal/profile/route.ts</files>
  <action>
**profile/page.tsx (Personal Info - PORT-05):**
Enhance to be an editable form with glass-styled inputs:
- Display fields: first name, last name, email, phone, date of birth (read-only), address (street, city, postal code)
- Editable fields: phone, email, address fields. First/last name editable. DOB read-only.
- "Opslaan" button (orange primary) saves via PATCH to /api/patient-portal/profile
- Success toast on save. Validation: email format, phone format (Dutch +31 or 06), postal code format
- Glass input styling per CLAUDE.md: `bg-white/[0.05] border border-white/[0.12] backdrop-blur-xl rounded-2xl focus:border-[#e8945a]/50 focus:ring-2 focus:ring-[#e8945a]/20`

Update /api/patient-portal/profile/route.ts if needed to support PATCH with field updates.

**documents/page.tsx (Documents & X-rays - PORT-07):**
Enhance with:
- Category tabs or filter: "Alle", "Rontgenfoto's", "Brieven", "Verzekering", "Overige" (auto-detect from mimeType: image/* = Rontgenfoto's unless context says otherwise, pdf = Brieven/Verzekering based on name pattern, else Overige)
- Document cards: thumbnail preview (for images), file icon (for PDFs), file name, date, category badge, download button
- X-ray images: click opens existing XRayLightbox component with zoom/pan (reuse, do NOT rebuild per CONTEXT)
- "Document uploaden" button (orange): opens file picker, accepts images + PDFs + .doc/.docx, max 10MB
- Upload flow: select file -> show preview -> optional category selection -> upload to /api/patient-portal/documents/upload
- Uploaded documents show "In behandeling" (PENDING_REVIEW) badge until practice approves
- If no documents: "Geen documenten gevonden" empty state

**documents/upload/route.ts (NEW):**
- POST: Accept multipart form data. Validate patient_token. Accept file + optional category.
- Upload to Vercel Blob (`put(fileName, file, { access: 'public' })`).
- Create record in DB with approvalStatus=PENDING_REVIEW and uploadedByPatientId set.
- Max 10MB check. Allowed: image/*, application/pdf, application/msword, application/vnd.openxmlformats-officedocument.wordprocessingml.document.
- Return created document record.

Glass UI throughout.
  </action>
  <verify>`pnpm --filter @dentflow/web build` passes. Profile page editable and saves. Documents page shows categories, upload works, pending badge shown.</verify>
  <done>Profile is editable with validation. Documents organized by category with patient upload and pending approval status. X-rays open in existing viewer.</done>
</task>

</tasks>

<verification>
- `pnpm --filter @dentflow/web build` passes
- Treatment plans show cost estimates per treatment
- Invoices have PDF download
- Profile is editable and saves
- Documents show by category, upload creates pending record
</verification>

<success_criteria>
All four pages (behandelplan, invoices, profile, documents) fully functional with CONTEXT decisions implemented. Document upload with approval workflow working.
</success_criteria>

<output>
After completion, create `.planning/phases/07-patient-portal-core/07-04-SUMMARY.md`
</output>
