---
phase: 03-billing-declaratie
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - apps/web/src/app/(dashboard)/billing/page.tsx
  - apps/web/src/lib/pdf/invoice-pdf.ts
autonomous: true
requirements:
  - BILL-01
  - BILL-03
  - BILL-04

must_haves:
  truths:
    - "NewInvoiceModal uses CodeBrowserPanel for NZa code selection with category tree"
    - "Selected NZa codes pass both code string and nzaCodeId to invoice lines"
    - "PDF invoice shows real IBAN and BTW-nummer from practice billingConfig"
    - "Billing page detects and marks overdue invoices on load"
  artifacts:
    - path: "apps/web/src/app/(dashboard)/billing/page.tsx"
      provides: "Enhanced invoice modal with CodeBrowserPanel and overdue detection"
      contains: "CodeBrowserPanel"
    - path: "apps/web/src/lib/pdf/invoice-pdf.ts"
      provides: "PDF with practice billingConfig (IBAN, BTW)"
      contains: "billingConfig"
  key_links:
    - from: "apps/web/src/app/(dashboard)/billing/page.tsx"
      to: "apps/web/src/components/declaratie/code-browser-panel.tsx"
      via: "import CodeBrowserPanel"
      pattern: "CodeBrowserPanel"
    - from: "apps/web/src/lib/pdf/invoice-pdf.ts"
      to: "practice.billingConfig"
      via: "JSON field on Practice model"
      pattern: "billingConfig"
---

<objective>
Enhance frontend billing: integrate CodeBrowserPanel into invoice modal, use practice billingConfig in PDF, add overdue detection on page load.

Purpose: Complete the user-facing billing experience with proper NZa code browsing and correct Dutch invoices.
Output: Professional declaratie workflow and accurate PDF invoices.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-billing-declaratie/03-RESEARCH.md
@.planning/phases/03-billing-declaratie/03-01-SUMMARY.md

@apps/web/src/app/(dashboard)/billing/page.tsx
@apps/web/src/lib/pdf/invoice-pdf.ts
@apps/web/src/components/declaratie/code-browser-panel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate CodeBrowserPanel into NewInvoiceModal and add overdue detection</name>
  <files>
    apps/web/src/app/(dashboard)/billing/page.tsx
  </files>
  <action>
1. Enhance the `NewInvoiceModal` component in the billing page:
   - Import `CodeBrowserPanel` from `@/components/declaratie/code-browser-panel.tsx`
   - Replace the current inline NZa code search input with the full `CodeBrowserPanel` component. Make the modal wider (e.g., `max-w-4xl` or `max-w-5xl`) to accommodate the code browser alongside line items.
   - Layout: Left side shows CodeBrowserPanel (category tree + search), right side shows the current line items list. When user clicks a code in the browser, it adds a new line item with: `nzaCode` (string), `nzaCodeId` (FK), `description`, `tariff` (pre-filled from NzaCode record), `quantity: 1`.
   - Pass `nzaCodeId` in each line item when submitting to the POST /api/invoices endpoint (Plan 01 added backend support for this).
   - Keep all existing modal functionality (patient selection, insurance %, notes, etc.)

2. Add overdue detection on billing page load:
   - In the billing page's `fetchData` function (or equivalent data loading), after fetching invoices, check for any invoice where: status is SENT or PARTIALLY_PAID AND dueDate < now.
   - For each such invoice, call PATCH `/api/invoices/{id}` with `{ status: 'OVERDUE' }` to update it.
   - This is a simple on-load check, no cron needed. The transition validation from Plan 01 will ensure only valid transitions happen.
   - After marking overdue invoices, re-fetch or update local state to reflect the changes.
  </action>
  <verify>
Build passes: `pnpm --filter @dentflow/web build`
Grep for "CodeBrowserPanel" in billing/page.tsx — should be imported and used.
Grep for "OVERDUE" in billing/page.tsx — should have overdue detection logic.
  </verify>
  <done>
NewInvoiceModal shows CodeBrowserPanel with full category tree for NZa code selection. Line items include nzaCodeId. Billing page auto-detects and marks overdue invoices on load.
  </done>
</task>

<task type="auto">
  <name>Task 2: Use practice billingConfig in PDF generation</name>
  <files>
    apps/web/src/lib/pdf/invoice-pdf.ts
  </files>
  <action>
1. Update `generateInvoicePdf` function:
   - The function already receives practice data. Parse `practice.billingConfig` (it's a JSON field, type `any` or `JsonValue`). Cast/parse it to extract: `iban`, `btwNumber`, `bankName`, `paymentTermDays`, `defaultFooterText`.
   - Replace the hardcoded IBAN placeholder (`NL00 XXXX 0000 0000 00`) with the actual `billingConfig.iban`. If not set, show "IBAN niet geconfigureerd" as fallback.
   - Add BTW-nummer to the practice details section in the header (near KvK/AGB). Use `billingConfig.btwNumber`. If not set, omit the line (dental care is typically BTW-exempt).
   - If `billingConfig.bankName` is set, show it alongside IBAN in the footer (e.g., "ABN AMRO - NL91ABNA0417164300").
   - If `billingConfig.defaultFooterText` is set, use it instead of the current hardcoded footer text.
   - Keep all other PDF layout, formatting, and functionality exactly the same.
  </action>
  <verify>
Build passes: `pnpm --filter @dentflow/web build`
Grep for "billingConfig" in invoice-pdf.ts — should be used for IBAN, BTW.
Grep for "NL00 XXXX" in invoice-pdf.ts — hardcoded IBAN should be gone.
  </verify>
  <done>
PDF invoices use real IBAN from practice billingConfig. BTW-nummer shown in header when configured. Hardcoded IBAN placeholder removed. Fallback text shown when billingConfig not set.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @dentflow/web build` passes
2. CodeBrowserPanel is imported and rendered in the invoice modal
3. nzaCodeId is passed in line items from the modal
4. PDF uses billingConfig for IBAN (no hardcoded placeholder)
5. Billing page marks overdue invoices on load
</verification>

<success_criteria>
- Staff can browse NZa codes via full category tree when creating invoices
- PDF invoices show correct practice IBAN and BTW-nummer from billingConfig
- Overdue invoices are automatically detected and marked on page load
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-billing-declaratie/03-02-SUMMARY.md`
</output>
