---
phase: 11-hygienist-portal-rebuild
plan: 04
type: execute
wave: 2
depends_on: [11-01]
files_modified:
  - apps/web/src/app/(hygienist)/hygienist/agenda/page.tsx
  - apps/web/src/app/(hygienist)/hygienist/patients/[id]/page.tsx
  - apps/web/src/app/(hygienist)/hygienist/patients/[id]/notes/page.tsx
  - apps/web/src/app/(hygienist)/hygienist/billing/page.tsx
autonomous: true
requirements: [HYG-01, HYG-03, HYG-04]

must_haves:
  truths:
    - "Agenda shows hygienist's own schedule with toggle for dentist schedule"
    - "Patient detail page is hygienist-focused with prominent perio tab"
    - "Clinical notes visible from both hygienist and dentist (shared)"
    - "No odontogram restoration editing in hygienist patient detail"
    - "Billing page supports full declaratie workflow for P-codes"
  artifacts:
    - path: "apps/web/src/app/(hygienist)/hygienist/agenda/page.tsx"
      provides: "Hygienist agenda with schedule toggle"
      min_lines: 150
    - path: "apps/web/src/app/(hygienist)/hygienist/patients/[id]/page.tsx"
      provides: "Hygienist-focused patient detail"
      min_lines: 200
    - path: "apps/web/src/app/(hygienist)/hygienist/billing/page.tsx"
      provides: "Hygienist declaratie page"
      min_lines: 150
  key_links:
    - from: "patients/[id]/page.tsx"
      to: "/hygienist/patients/[id]/perio"
      via: "Link to periodontogram"
      pattern: "href.*perio"
    - from: "patients/[id]/notes/page.tsx"
      to: "/api/patients/[id]/clinical-notes"
      via: "Shared clinical notes API"
      pattern: "clinical-notes"
---

<objective>
Build core hygienist portal pages: agenda with schedule toggle, hygienist-focused patient detail (perio tab prominent, no restoration editing), shared clinical notes, and full billing/declaratie for P-codes.

Purpose: Replace the 4 re-exported dentist pages with dedicated hygienist implementations.
Output: Agenda, patient detail, clinical notes, and billing pages — all hygienist-specific.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-hygienist-portal-rebuild/11-RESEARCH.md
@.planning/phases/11-hygienist-portal-rebuild/11-01-SUMMARY.md
@apps/web/src/app/(dashboard)/dashboard/agenda/page.tsx
@apps/web/src/app/(dashboard)/dashboard/patients/[id]/page.tsx
@apps/web/src/app/(dashboard)/dashboard/declaratie/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Agenda page + patient detail page</name>
  <files>
    apps/web/src/app/(hygienist)/hygienist/agenda/page.tsx
    apps/web/src/app/(hygienist)/hygienist/patients/[id]/page.tsx
  </files>
  <action>
**agenda/page.tsx — Replace the re-export with dedicated hygienist agenda:**

Build a full agenda page (do NOT import from dashboard). Study the dentist agenda page for patterns but build fresh.

Features:
- Day/week view toggle (default: day view)
- Shows hygienist's own appointments by default (filter by current user's ID from JWT)
- Toggle button "Tandarts agenda" to overlay/show dentist schedule for coordination (fetch via `/api/schedules?listPractitioners=true` then filter)
- Appointment cards: patient name, time, type badge, status badge
- Click appointment -> expand with details (patient link, notes, perio link if HYGIENE type)
- "Nieuwe afspraak" button to create appointments (POST to `/api/appointments`)
- Use authFetch for all API calls (staff auth pattern)
- Same Tailwind styling as dentist agenda (identical visual design per decision)

**patients/[id]/page.tsx — Replace re-export with hygienist-focused detail:**

Build fresh patient detail page. Do NOT import dentist patient detail.

Tab layout:
1. **Perio** (first/prominent tab) — Link to `/hygienist/patients/[id]/perio` with mini summary: last session date, BOP%, risk score badge. "Open Periodontogram" button.
2. **Klinische Notities** — Link to notes subpage, show last 3 notes preview
3. **Behandelplan** — Simplified read-focused view of treatment plans (fetch from `/api/patient-portal/treatment-plans` or `/api/patients/[id]` includes). No edit/create for restorations. Can view treatment plan status.
4. **Anamnese** — View/edit anamnesis forms
5. **Afbeeldingen** — View/upload patient images
6. **Documenten** — View/upload documents

Top section: Patient header with name, DOB, last visit, risk score badge, recall status.

NO odontogram restoration editing tab. NO smile design. Per locked decision.
  </action>
  <verify>Run `pnpm --filter @dentflow/web build` — no errors.</verify>
  <done>Agenda shows own schedule with dentist toggle, patient detail has perio-first tabs without restoration editing</done>
</task>

<task type="auto">
  <name>Task 2: Clinical notes page + billing/declaratie page</name>
  <files>
    apps/web/src/app/(hygienist)/hygienist/patients/[id]/notes/page.tsx
    apps/web/src/app/(hygienist)/hygienist/billing/page.tsx
  </files>
  <action>
**notes/page.tsx — Rebuild clinical notes (currently exists, enhance for shared notes):**

The notes page should show ALL clinical notes for the patient — from both hygienist and dentist. This is the HYG-03 requirement: shared clinical notes.

Features:
- Fetch notes from `/api/patients/[id]/clinical-notes` (existing endpoint returns all notes for patient)
- Display each note with: author name + role badge (DENTIST/HYGIENIST), date, SOAP format sections, flags
- Filter tabs: "Alle" (all), "Mijn notities" (my notes), "Tandarts" (dentist notes)
- Create new note: SOAP form (Subjective, Objective, Assessment, Plan) with noteType=HYGIENE
- Flag system: can flag notes for attention (uses existing NoteFlag model from Phase 10)
- AI shorthand expansion toggle (reuse existing expand-notes endpoint)
- Use authFetch for all API calls

**billing/page.tsx — Replace re-export with hygienist declaratie:**

Build dedicated billing page for hygienist. Study dentist declaratie page for patterns but build fresh.

Features:
- Invoice list: fetch from `/api/invoices` filtered by current user as practitioner
- Create new invoice: patient selector, add declaratie lines with NZa code browser
- Filter NZa codes to show P-codes (parodontologie/preventie) prominently — add a "Hygiene codes" quick filter that filters by relevant categories
- Full declaratie line editing: code, description, quantity, tariff
- Invoice status workflow: DRAFT -> SENT -> PAID / OVERDUE
- Same invoice PDF generation as dentist (reuse existing endpoint)
- Same Tailwind styling as dentist billing page
  </action>
  <verify>Run `pnpm --filter @dentflow/web build` — no errors.</verify>
  <done>Clinical notes page shows shared notes from both roles with filter tabs, billing page supports full P-code declaratie workflow</done>
</task>

</tasks>

<verification>
- `pnpm --filter @dentflow/web build` succeeds
- Agenda renders with schedule toggle
- Patient detail has perio-first tabs, no restoration editing
- Clinical notes show both hygienist and dentist notes
- Billing supports P-code declaratie
</verification>

<success_criteria>
Four core portal pages replaced: agenda with own schedule + dentist toggle, hygienist-focused patient detail with perio prominence, shared clinical notes with role filtering, and full billing/declaratie for P-codes.
</success_criteria>

<output>
After completion, create `.planning/phases/11-hygienist-portal-rebuild/11-04-SUMMARY.md`
</output>
