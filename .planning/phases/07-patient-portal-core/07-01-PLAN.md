---
phase: 07-patient-portal-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/prisma/schema.prisma
  - apps/web/src/app/(patient)/portal/layout.tsx
  - apps/web/src/app/(patient)/portal/page.tsx
  - apps/web/src/app/api/patient-portal/dashboard/route.ts
autonomous: true
requirements: [PORT-04, PORT-05]

must_haves:
  truths:
    - "Portal sidebar shows exactly 7 items: Home, Afspraken, Berichten, Behandelplannen, Facturen, Documenten, Profiel"
    - "Sidebar shows unread message count badge and unpaid invoice count badge"
    - "Dashboard shows 4 summary widgets: next appointment, unread messages, recent documents, outstanding invoices"
    - "Conversation, ConversationMessage, MessageAttachment tables exist in database"
  artifacts:
    - path: "packages/database/prisma/schema.prisma"
      provides: "Conversation, ConversationMessage, MessageAttachment models + enums"
      contains: "model Conversation"
    - path: "apps/web/src/app/(patient)/portal/layout.tsx"
      provides: "Trimmed 7-item sidebar with badges"
    - path: "apps/web/src/app/(patient)/portal/page.tsx"
      provides: "Dashboard with 4 summary widgets"
  key_links:
    - from: "apps/web/src/app/(patient)/portal/layout.tsx"
      to: "/api/patient-portal/dashboard"
      via: "fetch for badge counts"
      pattern: "fetch.*patient-portal/dashboard"
---

<objective>
Schema migration for threaded messaging, sidebar navigation cleanup to 7 items with badges, and dashboard widget restructuring.

Purpose: Foundation for all portal features -- schema enables messaging, sidebar is the portal shell, dashboard is the landing page.
Output: Working portal shell with correct nav, badges, dashboard widgets, and Conversation schema in DB.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-patient-portal-core/07-CONTEXT.md
@.planning/phases/07-patient-portal-core/07-RESEARCH.md
@apps/web/src/app/(patient)/portal/layout.tsx
@apps/web/src/app/(patient)/portal/page.tsx
@apps/web/src/app/api/patient-portal/dashboard/route.ts
@packages/database/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Conversation schema models and migrate database</name>
  <files>packages/database/prisma/schema.prisma</files>
  <action>
Add these new models and enums to schema.prisma (keep existing Message model untouched):

1. Add enums: `ConversationStatus { OPEN CLOSED }`, `SenderType { PATIENT STAFF }`

2. Add model `Conversation` with fields:
   - id (String @id @default(uuid()))
   - practiceId (String @map("practice_id"))
   - patientId (String @map("patient_id"))
   - practitionerId (String @map("practitioner_id"))
   - subject (String)
   - status (ConversationStatus @default(OPEN))
   - createdAt, updatedAt
   - Relations: practice->Practice, patient->Patient, practitioner->User, messages->ConversationMessage[]
   - Indexes: [patientId, updatedAt], [practitionerId, status]
   - @@map("conversations")

3. Add model `ConversationMessage` with fields:
   - id, conversationId, senderType (SenderType), senderId (String?), content, isRead (Boolean @default(false)), createdAt
   - Relations: conversation->Conversation, sender->User?, attachments->MessageAttachment[]
   - Index: [conversationId, createdAt]
   - @@map("conversation_messages")

4. Add model `MessageAttachment` with fields:
   - id, messageId, fileName, fileUrl, fileSize (Int), mimeType, createdAt
   - Relation: message->ConversationMessage
   - @@map("message_attachments")

5. Add inverse relations on Patient model (`conversations Conversation[]`), User model (`conversations Conversation[]`, `conversationMessages ConversationMessage[]`), Practice model (`conversations Conversation[]`).

6. Also add to Patient model: a `DocumentUpload` model or add `uploadedByPatientId` nullable field + `approvalStatus` enum (PENDING_REVIEW, APPROVED, REJECTED) to existing PatientImage/Document model. Check which model stores documents and add the field there.

After schema changes run: `pnpm db:generate && pnpm db:push`
  </action>
  <verify>Run `pnpm db:generate` succeeds. Run `pnpm db:push` succeeds. Run `pnpm --filter @dentflow/web build` to confirm no type errors.</verify>
  <done>Conversation, ConversationMessage, MessageAttachment tables exist in database. Prisma client generated with new types.</done>
</task>

<task type="auto">
  <name>Task 2: Restructure sidebar navigation and dashboard widgets</name>
  <files>apps/web/src/app/(patient)/portal/layout.tsx, apps/web/src/app/(patient)/portal/page.tsx, apps/web/src/app/api/patient-portal/dashboard/route.ts</files>
  <action>
**layout.tsx - Sidebar nav restructuring:**
Replace the current 14-item navItems array with exactly 7 items using lucide-react icons (replace inline SVGs):
1. Home (icon: Home) -> /portal
2. Afspraken (icon: Calendar) -> /portal/appointments
3. Berichten (icon: MessageSquare) -> /portal/messages
4. Behandelplannen (icon: ClipboardList) -> /portal/behandelplan
5. Facturen (icon: Receipt) -> /portal/invoices
6. Documenten (icon: FileText) -> /portal/documents
7. Profiel (icon: UserCircle) -> /portal/profile

Add badge support: fetch `/api/patient-portal/dashboard` on mount to get `{ unreadMessages: number, unpaidInvoices: number }`. Show orange badge pill next to Berichten (unreadMessages count) and Facturen (unpaidInvoices count) when > 0. Badge style: `bg-[#e8945a] text-white text-xs font-bold rounded-full min-w-[20px] h-5 flex items-center justify-center px-1.5`.

Keep all existing glass UI styling, mobile nav, user section, logout. Just replace navItems and add badge fetch.

**page.tsx - Dashboard widgets:**
Rewrite dashboard to show 4 summary widget cards in a 2x2 grid (responsive: 1 col on mobile, 2 on md+):
1. Volgende Afspraak -- shows next upcoming appointment (date, time, practitioner, type) or "Geen afspraken" with CTA
2. Ongelezen Berichten -- count with icon, click navigates to /portal/messages
3. Recente Documenten -- count of docs from last 30 days, click navigates to /portal/documents
4. Openstaande Facturen -- count + total amount, click navigates to /portal/invoices

Each widget: glass card styling (`bg-white/[0.06] backdrop-blur-2xl border border-white/[0.12] rounded-2xl`), hover effect, lucide icon, accent color for highlights.

Fetch data from `/api/patient-portal/dashboard` endpoint.

**dashboard/route.ts - Enhance API:**
Update the dashboard API to return: `{ nextAppointment: {...} | null, unreadMessages: number, recentDocuments: number, unpaidInvoices: { count: number, totalAmount: number } }`. Query Conversation model for unread count (ConversationMessage where isRead=false and senderType=STAFF for this patient). Query invoices where status not PAID. Query next appointment where startTime > now.
  </action>
  <verify>Run `pnpm --filter @dentflow/web build`. Visit /portal in browser -- sidebar shows exactly 7 items with correct Dutch labels. Dashboard shows 4 widget cards.</verify>
  <done>Sidebar has 7 nav items with badges. Dashboard shows 4 summary widgets. Glass UI styling maintained.</done>
</task>

</tasks>

<verification>
- `pnpm --filter @dentflow/web build` passes
- Sidebar renders 7 items: Home, Afspraken, Berichten, Behandelplannen, Facturen, Documenten, Profiel
- Dashboard shows 4 widgets with data from API
- Database has conversations, conversation_messages, message_attachments tables
</verification>

<success_criteria>
Portal shell is production-ready with correct navigation, badge counts, and dashboard widgets. Schema supports threaded messaging for subsequent plans.
</success_criteria>

<output>
After completion, create `.planning/phases/07-patient-portal-core/07-01-SUMMARY.md`
</output>
