---
phase: 08-patient-portal-advanced
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - apps/web/src/app/(patient)/portal/consent/page.tsx
  - apps/web/src/app/(patient)/portal/behandelplan/page.tsx
autonomous: true
requirements: [PORT-06]

must_haves:
  truths:
    - "Patient must scroll consent content to bottom before signature pad enables"
    - "Signature pad is one-shot canvas draw â€” submit or cancel, no clear/redo"
    - "Patient can indicate signer relationship (self/parent/guardian)"
    - "Patient can sign treatment plans with same signature flow as consent forms"
    - "Patient sees confirmation toast after signing"
    - "Badge count shows unsigned consent forms in portal sidebar"
    - "Patient can download signed consent as PDF"
  artifacts:
    - path: "apps/web/src/app/(patient)/portal/consent/page.tsx"
      provides: "Enhanced consent page with scroll-to-bottom gating, dependent signing, PDF download"
      min_lines: 100
    - path: "apps/web/src/app/(patient)/portal/behandelplan/page.tsx"
      provides: "Treatment plan page with signing flow for PROPOSED plans"
      min_lines: 80
  key_links:
    - from: "apps/web/src/app/(patient)/portal/consent/page.tsx"
      to: "/api/patient-portal/consent/[id]/sign"
      via: "fetch POST with signature data, signer relation"
      pattern: "fetch.*consent.*sign"
    - from: "apps/web/src/app/(patient)/portal/behandelplan/page.tsx"
      to: "/api/patient-portal/treatment-plans/[id]/sign"
      via: "fetch POST with signature data"
      pattern: "fetch.*treatment-plans.*sign"
---

<objective>
Build the patient-facing consent signing UI with scroll-to-bottom gating, one-shot signature canvas, dependent signing support, and PDF download. Add treatment plan signing flow to the behandelplan page.

Purpose: Patient can digitally sign consent forms and approve treatment plans within the portal.
Output: Enhanced consent page with full signing flow, treatment plan page with approval signing.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-patient-portal-advanced/08-RESEARCH.md
@.planning/phases/08-patient-portal-advanced/08-01-SUMMARY.md
@apps/web/src/app/(patient)/portal/consent/page.tsx
@apps/web/src/app/(patient)/portal/behandelplan/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhanced consent page with scroll-to-bottom gating and signing flow</name>
  <files>apps/web/src/app/(patient)/portal/consent/page.tsx</files>
  <action>
Rebuild the consent page with the following flow:

1. **Consent list view**: Show all consent forms for the patient (PENDING, SIGNED, EXPIRED). Use glass card styling per portal conventions. Badge count for unsigned (PENDING) forms. SIGNED forms show "Signed on [date]" with download PDF button. EXPIRED forms show "Verlopen" label.

2. **Consent detail/signing view** (when patient clicks a PENDING form):
   - Display consent title and full content text in a scrollable container (`max-h-[60vh] overflow-y-auto`) with ref for scroll tracking
   - **Scroll-to-bottom detection**: Track scroll position with `onScroll` handler. Set `hasScrolledToBottom = true` when `scrollHeight - scrollTop - clientHeight < 20`. Also check on mount: if content fits without scrolling (`scrollHeight <= clientHeight`), auto-enable immediately.
   - Show message "Scroll naar beneden om te ondertekenen" when not yet scrolled to bottom
   - **Signer relationship selector** (below content, above signature): Radio buttons for "Ik onderteken als:" with options: "Mijzelf" (SELF), "Ouder/Voogd" (PARENT), "Wettelijk Vertegenwoordiger" (GUARDIAN). Default to SELF.
   - **Name field**: Text input for signer's name (pre-filled with patient name if SELF)
   - **Signature canvas**: Only visible/enabled after scroll-to-bottom. Use HTML Canvas with touch-none CSS. One-shot drawing: patient draws signature, then sees two buttons: "Annuleren" (cancel, clears and hides canvas) and "Ondertekenen" (submit). NO clear/redo button per locked decision.
   - Canvas implementation: mousedown/touchstart starts drawing, mousemove/touchmove draws line, mouseup/touchend stops. Use `e.preventDefault()` on touch events. Line width 2, black stroke. Canvas size responsive (full width, ~150px height).
   - On submit: POST to `/api/patient-portal/consent/{id}/sign` with signatureData (canvas.toDataURL()), signedByName, signerRelation. Show loading state. On success: show toast "Toestemmingsformulier ondertekend", return to list view, refresh data.

3. **PDF download**: For SIGNED forms, add "Download PDF" button that fetches `/api/patient-portal/consent/{id}/pdf` and triggers browser download.

4. Use glass UI styling throughout: `bg-white/[0.06] backdrop-blur-2xl border border-white/[0.12] rounded-2xl`. Primary button: `bg-[#e8945a]` styling. Accent color `#e8945a` throughout.
  </action>
  <verify>Run `pnpm --filter @dentflow/web build` to verify compilation.</verify>
  <done>Consent page shows list of forms, scroll-to-bottom enables signature pad, one-shot canvas signing works, dependent signing (relation selector) works, PDF download works for signed forms, toast on success.</done>
</task>

<task type="auto">
  <name>Task 2: Treatment plan signing flow on behandelplan page</name>
  <files>apps/web/src/app/(patient)/portal/behandelplan/page.tsx</files>
  <action>
Enhance the behandelplan page to support digital signing of PROPOSED treatment plans:

1. For treatment plans with status PROPOSED, add an "Akkoord & Ondertekenen" button (primary orange button).

2. Clicking opens a signing flow (can be inline expansion or modal):
   - Show treatment plan summary: title, treatments list with costs, total cost
   - Scroll-to-bottom container with treatment details (reuse same scroll detection pattern as consent page)
   - Signer relationship selector (same as consent page: SELF/PARENT/GUARDIAN radio buttons)
   - Name input field
   - Signature canvas (same one-shot pattern as consent page)
   - Submit button "Akkoord & Ondertekenen"

3. On submit: POST to `/api/patient-portal/treatment-plans/{id}/sign` with signatureData, signedByName, signerRelation. On success: toast "Behandelplan goedgekeurd", refresh data (plan should now show APPROVED status).

4. For APPROVED plans, show "Goedgekeurd op [date]" label instead of sign button.

5. Extract shared signature canvas logic into a reusable component or shared function to avoid duplication between consent and behandelplan pages. Place in the consent page file or a shared location within `(patient)/portal/`. The component should accept: onSign callback, disabled prop, signerName default.

6. Use same glass UI styling as consent page.
  </action>
  <verify>Run `pnpm --filter @dentflow/web build` to verify compilation.</verify>
  <done>PROPOSED treatment plans show sign button, signing flow with scroll-to-bottom + canvas works, plan status updates to APPROVED after signing, shared signature component avoids code duplication.</done>
</task>

</tasks>

<verification>
- `pnpm --filter @dentflow/web build` passes
- Consent page: scroll detection works, signature canvas renders, signing submits correctly
- Behandelplan page: PROPOSED plans show sign flow, signing updates status
- Both pages use same signature component pattern
</verification>

<success_criteria>
Patient can sign consent forms and treatment plans with scroll-to-bottom gating, one-shot canvas, dependent signing, and confirmation toast.
</success_criteria>

<output>
After completion, create `.planning/phases/08-patient-portal-advanced/08-02-SUMMARY.md`
</output>
