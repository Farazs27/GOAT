---
phase: 10-hygienist-portal-periodontogram
plan: 05
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - apps/web/src/app/api/staff-chat/route.ts
  - apps/web/src/app/api/staff-chat/[id]/messages/route.ts
  - apps/web/src/app/(dashboard)/dashboard/team-chat/page.tsx
  - apps/web/src/app/(dashboard)/layout.tsx
autonomous: true
requirements: [HYG-05]

must_haves:
  truths:
    - "Staff can see Team Chat in sidebar navigation"
    - "Staff can create 1-on-1 and group chats with other staff members"
    - "Messages appear in real-time-ish via polling (5s intervals)"
    - "Unread message count shown as badge in sidebar"
  artifacts:
    - path: "apps/web/src/app/api/staff-chat/route.ts"
      provides: "Staff chat list and creation API"
      contains: "staffChat"
    - path: "apps/web/src/app/api/staff-chat/[id]/messages/route.ts"
      provides: "Message send and fetch API"
      contains: "staffChatMessage"
    - path: "apps/web/src/app/(dashboard)/dashboard/team-chat/page.tsx"
      provides: "Team chat UI"
      contains: "Team Chat"
  key_links:
    - from: "apps/web/src/app/(dashboard)/dashboard/team-chat/page.tsx"
      to: "/api/staff-chat"
      via: "fetch with polling"
      pattern: "staff-chat"
---

<objective>
Staff-to-staff team chat with 1-on-1 and group conversations, polling-based message updates, and sidebar integration.

Purpose: Enable internal communication between dentist and hygienist (and other staff).
Output: Team chat API, chat UI page, sidebar nav entry with unread badge.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-hygienist-portal-periodontogram/10-CONTEXT.md
@.planning/phases/10-hygienist-portal-periodontogram/10-RESEARCH.md
@.planning/phases/10-hygienist-portal-periodontogram/10-01-SUMMARY.md
@packages/database/prisma/schema.prisma
@apps/web/src/app/(dashboard)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Staff chat API endpoints</name>
  <files>apps/web/src/app/api/staff-chat/route.ts, apps/web/src/app/api/staff-chat/[id]/messages/route.ts, apps/web/src/app/api/staff-chat/[id]/read/route.ts</files>
  <action>
1. **`/api/staff-chat/route.ts`:**
   - GET: List all chats where current user is a member. Include: chat name (for groups) or other member's name (for 1-on-1), last message preview, unread count (messages where isRead=false and senderId != current user), member list.
   - POST: Create a new chat. Body: `{ memberIds: string[], name?: string, isGroup?: boolean }`. For 1-on-1 (2 members, no name), check if chat already exists between these two users — return existing if found. Auto-add creator as member.

2. **`/api/staff-chat/[id]/messages/route.ts`:**
   - GET: Fetch messages for chat, ordered by createdAt ASC. Paginate with `?before=ISO_DATE&limit=50`. Include sender name and role.
   - POST: Send message. Body: `{ content: string }`. Verify sender is member of chat. Create StaffChatMessage.

3. **`/api/staff-chat/[id]/read/route.ts`:**
   - POST: Mark all messages in this chat as read for current user. Update `isRead=true` on all messages where senderId != current user.

All endpoints authenticate via `access_token` JWT. Scope to user's practiceId.
  </action>
  <verify>Run `pnpm --filter @dentflow/web build` — no errors.</verify>
  <done>Staff chat CRUD API working: list chats, create chat, send/fetch messages, mark read.</done>
</task>

<task type="auto">
  <name>Task 2: Team Chat UI page + sidebar entry</name>
  <files>apps/web/src/app/(dashboard)/dashboard/team-chat/page.tsx, apps/web/src/app/(dashboard)/layout.tsx</files>
  <action>
1. **Create `team-chat/page.tsx`:**
   - WhatsApp-style split layout: chat list (left panel, 300px) + conversation view (right panel)
   - **Left panel:** List of chats with avatar (first letter), name, last message preview, timestamp, unread badge. "Nieuw gesprek" button at top.
   - **New chat dialog:** List practice staff members (fetch from `/api/users?practiceOnly=true` or similar). Select one for 1-on-1, or multiple + name for group. Predefined group templates: "Volledig Team", "Mondhygiënisten".
   - **Right panel:** Message list (scrollable, auto-scroll to bottom), message input at bottom with send button. Messages: sender name, timestamp, content. Own messages right-aligned (blue/accent), others left-aligned (glass).
   - **Polling:** Fetch messages every 5 seconds using `setInterval` + fetch. On new messages, auto-scroll if already at bottom.
   - **Mark as read:** When opening a chat, POST to `/api/staff-chat/[id]/read`.
   - Glass UI throughout: `bg-white/[0.06] backdrop-blur-2xl border border-white/[0.12] rounded-2xl`

2. **Update sidebar nav (RoleNav client component):**
   - The navItems array now lives inside the RoleNav client component created in plan 01. Add the Team Chat entry there, NOT in the server layout directly.
   - Add "Team Chat" nav item: `{ icon: MessageSquare, label: "Team Chat", href: "/dashboard/team-chat" }` — insert after "Berichten" in the navItems array inside RoleNav.
   - Use a different icon to distinguish from Berichten — use `Users` icon (already imported) or `MessagesSquare` from lucide-react.
   - The SidebarBadges component should show unread team chat count. Add a fetch to `/api/staff-chat` to get total unread count and display badge on Team Chat nav item (similar to existing Berichten badge pattern).
  </action>
  <verify>Run `pnpm --filter @dentflow/web build` — no errors. Navigate to Team Chat — see chat list. Create a new 1-on-1 chat. Send a message. Open in another session — message appears within 5s.</verify>
  <done>Team Chat page with split layout, real-time-ish messaging via polling, new chat creation, unread badges in sidebar.</done>
</task>

</tasks>

<verification>
- `pnpm --filter @dentflow/web build` passes
- Team Chat appears in sidebar for all staff roles
- Can create 1-on-1 and group chats
- Messages poll every 5 seconds
- Unread badge shows in sidebar
</verification>

<success_criteria>
Working staff-to-staff team chat with 1-on-1 and group conversations, polling-based updates, WhatsApp-style UI, and sidebar integration with unread badges.
</success_criteria>

<output>
After completion, create `.planning/phases/10-hygienist-portal-periodontogram/10-05-SUMMARY.md`
</output>
