---
phase: 08-patient-portal-advanced
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/app/api/patient-portal/appointments/book/route.ts
  - apps/web/src/app/(patient)/portal/appointments/book/page.tsx
  - apps/web/src/app/api/patient-portal/appointments/availability/route.ts
autonomous: true
requirements: [AGND-05]

must_haves:
  truths:
    - "Patient selects appointment type first (checkup, cleaning, emergency), which determines duration"
    - "Patient picks practitioner before seeing available slots"
    - "Available slots respect booking window and minimum notice period from practice settings"
    - "Patient cannot have more than 2 pending (unconfirmed) bookings"
    - "Booking creates appointment with PENDING_APPROVAL status, not immediately confirmed"
    - "Patient can add optional free-text note when booking"
    - "Patient sees 'Wacht op bevestiging' status for pending bookings"
  artifacts:
    - path: "apps/web/src/app/(patient)/portal/appointments/book/page.tsx"
      provides: "Booking flow: type -> practitioner -> date/time -> details -> confirm"
      min_lines: 150
    - path: "apps/web/src/app/api/patient-portal/appointments/book/route.ts"
      provides: "Booking API with max pending check, booking window validation"
      exports: ["POST"]
    - path: "apps/web/src/app/api/patient-portal/appointments/availability/route.ts"
      provides: "Availability API with practitioner + date + duration filtering"
      exports: ["GET"]
  key_links:
    - from: "apps/web/src/app/(patient)/portal/appointments/book/page.tsx"
      to: "/api/patient-portal/appointments/availability"
      via: "fetch GET with practitionerId, date, duration params"
      pattern: "fetch.*availability"
    - from: "apps/web/src/app/api/patient-portal/appointments/book/route.ts"
      to: "prisma.appointment"
      via: "count pending + create with PENDING_APPROVAL"
      pattern: "PENDING_APPROVAL"
---

<objective>
Build the online booking flow where patients select appointment type, then practitioner, then browse available slots and book with staff approval required. Enforce configurable booking window, minimum notice, and max 2 pending bookings.

Purpose: Patient can book appointments online through the portal.
Output: Enhanced booking page with practitioner-first flow, availability API, booking API with business rules.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-patient-portal-advanced/08-RESEARCH.md
@apps/web/src/app/(patient)/portal/appointments/book/page.tsx
@apps/web/src/app/api/patient-portal/appointments/book/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Availability API and enhanced booking API with business rules</name>
  <files>
    apps/web/src/app/api/patient-portal/appointments/availability/route.ts
    apps/web/src/app/api/patient-portal/appointments/book/route.ts
  </files>
  <action>
1. **Create availability API** (`appointments/availability/route.ts`):
   - GET endpoint, authenticates via `patient_token`
   - Query params: `practitionerId` (required), `date` (required, YYYY-MM-DD), `durationMinutes` (required, number)
   - Read practice settings from patient's practice: `settings.booking.bookingWindowDays` (default 90), `settings.booking.minNoticeDays` (default 1)
   - Validate date is within booking window: not before today + minNoticeDays, not after today + bookingWindowDays
   - Query PractitionerSchedule for the practitioner on that day of week
   - Query existing appointments for the practitioner on that date
   - Calculate available time slots: for each schedule slot, find gaps >= durationMinutes that don't overlap existing appointments
   - Return array of `{ startTime: "HH:MM", endTime: "HH:MM" }` slots
   - Use 15-minute granularity for slot starts

2. **Enhance booking API** (`appointments/book/route.ts`):
   - Modify existing POST endpoint to add:
   - Read practice settings for booking config
   - **Max pending check**: Count patient's appointments with status "PENDING_APPROVAL". If >= `settings.booking.maxPendingBookings` (default 2), return 400 with Dutch error message "U heeft al 2 afspraken in afwachting van goedkeuring."
   - **Booking window validation**: Reject if date is outside min notice / max window
   - Accept body fields: `practitionerId`, `date`, `startTime`, `appointmentType` (CHECKUP/CLEANING/EMERGENCY), `notes` (optional free text)
   - Map appointment types to durations: CHECKUP=30, CLEANING=45, EMERGENCY=15 (hardcoded defaults)
   - **Double-check slot availability** before creating (re-query for conflicts)
   - Create appointment with status "PENDING_APPROVAL" (add this status if not in enum — check existing Appointment model statuses)
   - Create Notification record: type "BOOKING_REQUEST", message "Patient {name} wil een afspraak op {date} om {time}"
   - Return created appointment
  </action>
  <verify>Run `pnpm --filter @dentflow/web build` to verify compilation.</verify>
  <done>Availability API returns slots respecting schedule + existing appointments + booking window. Booking API enforces max 2 pending, validates booking window, creates PENDING_APPROVAL appointment.</done>
</task>

<task type="auto">
  <name>Task 2: Booking page UI with practitioner-first flow</name>
  <files>apps/web/src/app/(patient)/portal/appointments/book/page.tsx</files>
  <action>
Rebuild the booking page with this step flow (use numbered steps with progress indicator):

**Step 1 — Appointment Type**:
- Three glass cards: "Controle" (CHECKUP, 30 min), "Reiniging" (CLEANING, 45 min), "Spoed" (EMERGENCY, 15 min)
- Each card shows icon (lucide), name, and duration
- Selecting advances to step 2

**Step 2 — Practitioner**:
- Fetch practitioners via `/api/patient-portal/appointments/availability?listPractitioners=true` or use existing `/api/schedules?listPractitioners=true` (check what's available)
- Show practitioner cards with name and role
- Selecting advances to step 3

**Step 3 — Date & Time**:
- Calendar month grid for date selection (keep existing calendar implementation if it works, or build a simple month grid)
- Dates outside booking window are disabled (greyed out)
- After selecting a date, fetch available slots from `/api/patient-portal/appointments/availability?practitionerId=X&date=Y&durationMinutes=Z`
- Show slots as a grid of time buttons (e.g., "09:00", "09:15", etc.)
- If no slots: show "Geen beschikbare tijden op deze datum"
- Selecting a slot advances to step 4

**Step 4 — Details & Confirm**:
- Summary card showing: type, practitioner, date, time, duration
- Optional textarea for notes/reason ("Eventuele opmerkingen")
- "Afspraak Aanvragen" primary button
- On submit: POST to `/api/patient-portal/appointments/book`
- On success: toast "Afspraak aangevraagd — wacht op bevestiging", redirect to appointments page
- On error (max pending): show error message inline

**Navigation**: Back button on each step to go to previous step. Step indicator at top (1/4, 2/4, etc.).

**Pending bookings warning**: Before step 1, if patient has 1 pending booking, show info message. If 2, show warning that they can't book until one is confirmed/rejected.

Use glass UI styling throughout. Primary buttons use `bg-[#e8945a]`.
  </action>
  <verify>Run `pnpm --filter @dentflow/web build` to verify compilation.</verify>
  <done>Booking page has 4-step flow: type -> practitioner -> date/time -> confirm. Practitioner selection before date. Booking window enforced visually. Max pending check shown before flow starts. Submitting creates PENDING_APPROVAL appointment.</done>
</task>

</tasks>

<verification>
- `pnpm --filter @dentflow/web build` passes
- Availability API returns correct slots
- Booking API rejects when max pending reached
- Booking page flows through all 4 steps correctly
- PENDING_APPROVAL status shown on appointments page
</verification>

<success_criteria>
Patient can complete the full booking flow: select type, pick practitioner, choose available slot, confirm — creating a pending appointment awaiting staff approval.
</success_criteria>

<output>
After completion, create `.planning/phases/08-patient-portal-advanced/08-03-SUMMARY.md`
</output>
