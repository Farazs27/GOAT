// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// TENANT & IDENTITY
// ============================================================

model Practice {
  id            String   @id @default(uuid())
  name          String
  slug          String   @unique
  agbCode       String?  @map("agb_code") // AGB-code for VECOZO
  kvkNumber     String?  @map("kvk_number") // KvK registration
  avgCode       String?  @map("avg_code") // AVG (privacy) registration code
  addressStreet String?  @map("address_street")
  addressCity   String?  @map("address_city")
  addressPostal String?  @map("address_postal")
  phone         String?
  email         String?
  vecozoCertRef String?  @map("vecozo_cert_ref")
  billingConfig Json?    @default("{}") @map("billing_config")
  settings      Json?    @default("{}")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  users                 User[]
  patients              Patient[]
  teeth                 Tooth[]
  toothSurfaces         ToothSurface[]
  treatmentPlans        TreatmentPlan[]
  treatments            Treatment[]
  clinicalNotes         ClinicalNote[]
  appointments          Appointment[]
  practitionerSchedules PractitionerSchedule[]
  scheduleExceptions    ScheduleException[]
  invoices              Invoice[]
  invoiceLines          InvoiceLine[]
  payments              Payment[]
  insuranceClaims       InsuranceClaim[]
  consentForms          ConsentForm[]
  documents             Document[]
  auditLogs             AuditLog[]
  notifications         Notification[]
  credentials           Credential[]
  periodontalCharts     PeriodontalChart[]
  patientImages         PatientImage[]
  anamneses             Anamnesis[]
  messages              Message[]
  prescriptions         Prescription[]
  referrals             Referral[]
  complaints            Complaint[]
  emailThreads          EmailThread[]
  emailMessages         EmailMessage[]
  whatsappConversations WhatsAppConversation[]
  whatsappMessages      WhatsAppMessage[]
  customCodeCategories  CustomCodeCategory[]
  dsdDesigns            DsdDesign[]
  dentistTasks          DentistTask[]
  conversations         Conversation[]
  consentTemplates      ConsentTemplate[]
  aiChatSessions        AiChatSession[]
  patientNudges         PatientNudge[]
  staffChats            StaffChat[]
  perioSessions         PerioSession[]
  perioProtocols        PerioProtocol[]
  recallSchedules       RecallSchedule[]

  @@map("practices")
}

model User {
  id             String    @id @default(uuid())
  keycloakId     String?   @unique @map("keycloak_id")
  practiceId     String    @map("practice_id")
  email          String    @unique
  passwordHash   String    @map("password_hash")
  firstName      String?   @map("first_name")
  lastName       String?   @map("last_name")
  role           UserRole
  bigNumber      String?   @map("big_number") // BIG registration
  agbCode        String?   @map("agb_code") // Personal AGB code
  specialization String?
  phone          String?
  isActive       Boolean   @default(true) @map("is_active")
  lastLoginAt    DateTime? @map("last_login_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  dashboardLayout Json?    @map("dashboard_layout")

  // Relations
  practice                   Practice               @relation(fields: [practiceId], references: [id])
  patients                   Patient[]
  toothSurfacesRecorded      ToothSurface[]         @relation("RecordedBy")
  treatmentPlansCreated      TreatmentPlan[]        @relation("CreatedBy")
  treatmentsPerformed        Treatment[]            @relation("PerformedBy")
  clinicalNotes              ClinicalNote[]         @relation("Author")
  appointmentsAsPractitioner Appointment[]          @relation("Practitioner")
  practitionerSchedules      PractitionerSchedule[]
  scheduleExceptions         ScheduleException[]
  documentsUploaded          Document[]             @relation("UploadedBy")
  auditLogs                  AuditLog[]
  notifications              Notification[]
  periodontalChartsAuthored  PeriodontalChart[]     @relation("PeriodontalChartAuthor")
  patientImagesUploaded      PatientImage[]         @relation("PatientImageUploader")
  prescriptionsWritten       Prescription[]         @relation("Prescriber")
  messagesSent               Message[]              @relation("MessageSender")
  referralsCreated           Referral[]             @relation("ReferralCreator")
  whatsappMessagesSent       WhatsAppMessage[]      @relation("WhatsAppSender")
  dsdDesignsCreated          DsdDesign[]            @relation("DsdDesignCreator")
  assignedTasks              DentistTask[]          @relation("AssignedTasks")
  conversations              Conversation[]         @relation("ConversationPractitioner")
  conversationMessages       ConversationMessage[]  @relation("ConversationMessageSender")
  noteFlags                  NoteFlag[]             @relation("NoteFlagCreator")
  staffChatMembers           StaffChatMember[]
  staffChatMessages          StaffChatMessage[]
  perioSessionsAuthored      PerioSession[]     @relation("PerioSessionAuthor")

  @@map("users")
}

enum UserRole {
  SUPER_ADMIN
  PRACTICE_ADMIN
  DENTIST
  HYGIENIST
  RECEPTIONIST
  PATIENT
}

// ============================================================
// PATIENT RECORDS (BSN â€” encrypt in production)
// ============================================================

model Patient {
  id            String  @id @default(uuid())
  practiceId    String  @map("practice_id")
  userId        String? @map("user_id")
  patientNumber String  @map("patient_number")

  // BSN handling (MVP: plain text, Prod: encrypted)
  bsn           String?
  bsnEncrypted  Bytes?  @map("bsn_encrypted")
  bsnHash       Bytes?  @map("bsn_hash")
  bsnKeyVersion Int     @default(1) @map("bsn_key_version")

  firstName     String   @map("first_name")
  lastName      String   @map("last_name")
  dateOfBirth   DateTime @map("date_of_birth")
  gender        String?
  email         String?
  phone         String?
  addressStreet String?  @map("address_street")
  addressCity   String?  @map("address_city")
  addressPostal String?  @map("address_postal")

  // Insurance
  insuranceCompany    String?   @map("insurance_company")
  insuranceNumber     String?   @map("insurance_number")
  insuranceType       String?   @map("insurance_type")
  insuranceVerifiedAt DateTime? @map("insurance_verified_at")

  // Clinical
  medicalAlerts  String[] @map("medical_alerts")
  medications    String[]
  bloodType      String?  @map("blood_type")
  referralSource String?  @map("referral_source")

  // Compliance
  gdprConsentAt      DateTime? @map("gdpr_consent_at")
  dataRetentionUntil DateTime? @map("data_retention_until")
  isActive           Boolean   @default(true) @map("is_active")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  // Email Preferences
  emailPreferences  Json?    @default("{}") @map("email_preferences")

  // Relations
  practice          Practice           @relation(fields: [practiceId], references: [id])
  user              User?              @relation(fields: [userId], references: [id])
  teeth             Tooth[]
  treatmentPlans    TreatmentPlan[]
  treatments        Treatment[]
  clinicalNotes     ClinicalNote[]
  appointments      Appointment[]
  invoices          Invoice[]
  insuranceClaims   InsuranceClaim[]
  consentForms      ConsentForm[]
  documents         Document[]
  notifications     Notification[]
  periodontalCharts PeriodontalChart[]
  patientImages     PatientImage[]
  anamneses         Anamnesis[]
  prescriptions     Prescription[]
  messages          Message[]
  referrals         Referral[]
  complaints        Complaint[]
  emailThreads      EmailThread[]
  whatsappConversations WhatsAppConversation[]
  patientCategories     PatientCategory[]
  dsdDesigns            DsdDesign[]
  dentistTasks          DentistTask[]
  conversations         Conversation[]
  uploadedDocuments     Document[]     @relation("PatientDocumentUploader")
  aiChatSessions        AiChatSession[]
  patientNudges         PatientNudge[]
  perioSessions         PerioSession[]
  perioProtocols        PerioProtocol[]
  recallSchedules       RecallSchedule[]

  @@unique([practiceId, patientNumber])
  @@map("patients")
}

// ============================================================
// ODONTOGRAM (FDI NOTATION)
// ============================================================

model Tooth {
  id          String      @id @default(uuid())
  practiceId  String      @map("practice_id")
  patientId   String      @map("patient_id")
  toothNumber Int         @map("tooth_number") // FDI: 11-48 (permanent), 51-85 (primary)
  status      ToothStatus @default(PRESENT)
  isPrimary   Boolean     @default(false) @map("is_primary")
  notes       String?
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Relations
  practice   Practice       @relation(fields: [practiceId], references: [id])
  patient    Patient        @relation(fields: [patientId], references: [id])
  surfaces   ToothSurface[]
  treatments Treatment[]

  @@unique([patientId, toothNumber])
  @@map("teeth")
}

enum ToothStatus {
  PRESENT
  MISSING
  IMPLANT
  CROWN
  BRIDGE_ABUTMENT
  PONTIC
  ROOT_REMNANT
  ENDO
}

model ToothSurface {
  id          String           @id @default(uuid())
  practiceId  String           @map("practice_id")
  toothId     String           @map("tooth_id")
  surface     String // M, D, O, B/V, L/P
  condition   SurfaceCondition
  material        Material? // COMPOSITE, AMALGAM, CERAMIC, GOLD
  restorationType RestorationType?  @map("restoration_type")
  treatmentId     String?          @map("treatment_id")
  recordedAt  DateTime         @default(now()) @map("recorded_at")
  recordedBy  String           @map("recorded_by")

  // Relations
  practice  Practice   @relation(fields: [practiceId], references: [id])
  tooth     Tooth      @relation(fields: [toothId], references: [id])
  treatment Treatment? @relation(fields: [treatmentId], references: [id])
  recorder  User       @relation("RecordedBy", fields: [recordedBy], references: [id])

  @@map("tooth_surfaces")
}

enum SurfaceCondition {
  HEALTHY
  CARIES
  FILLING
  FRACTURE
  DECAY
  VENEER
  INLAY
  ONLAY
  PARTIAL_CROWN
}

enum RestorationType {
  FILLING
  INLAY
  ONLAY
  VENEER
  PARTIAL_CROWN
  CROWN_RESTORATION
}

enum Material {
  COMPOSITE
  CERAMIC
  AMALGAM
  GOLD
  NON_PRECIOUS_METAL
  TEMPORARY
}

// ============================================================
// TREATMENTS & CLINICAL NOTES
// ============================================================

model TreatmentPlan {
  id                String              @id @default(uuid())
  practiceId        String              @map("practice_id")
  patientId         String              @map("patient_id")
  createdBy         String              @map("created_by")
  title             String
  description       String?
  status            TreatmentPlanStatus @default(DRAFT)
  proposedAt        DateTime?           @map("proposed_at")
  acceptedAt        DateTime?           @map("accepted_at")
  totalEstimate     Decimal?            @map("total_estimate") @db.Decimal(10, 2)
  insuranceEstimate Decimal?            @map("insurance_estimate") @db.Decimal(10, 2)
  patientEstimate   Decimal?            @map("patient_estimate") @db.Decimal(10, 2)
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")

  // Relations
  practice     Practice      @relation(fields: [practiceId], references: [id])
  patient      Patient       @relation(fields: [patientId], references: [id])
  creator      User          @relation("CreatedBy", fields: [createdBy], references: [id])
  treatments   Treatment[]
  consentForms ConsentForm[]

  @@map("treatment_plans")
}

enum TreatmentPlanStatus {
  DRAFT
  PROPOSED
  ACCEPTED
  APPROVED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model Treatment {
  id              String  @id @default(uuid())
  practiceId      String  @map("practice_id")
  patientId       String  @map("patient_id")
  treatmentPlanId String? @map("treatment_plan_id")
  appointmentId   String? @map("appointment_id")
  performedBy     String  @map("performed_by")
  toothId         String? @map("tooth_id")
  nzaCodeId       String? @map("nza_code_id")

  description     String
  status          TreatmentStatus @default(PLANNED)
  performedAt     DateTime?       @map("performed_at")
  durationMinutes Int?            @map("duration_minutes")
  quantity        Int             @default(1)
  unitPrice       Decimal?        @map("unit_price") @db.Decimal(10, 2)
  totalPrice      Decimal?        @map("total_price") @db.Decimal(10, 2)
  notes           String?
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  // Relations
  practice      Practice       @relation(fields: [practiceId], references: [id])
  patient       Patient        @relation(fields: [patientId], references: [id])
  treatmentPlan TreatmentPlan? @relation(fields: [treatmentPlanId], references: [id])
  appointment   Appointment?   @relation(fields: [appointmentId], references: [id])
  performer     User           @relation("PerformedBy", fields: [performedBy], references: [id])
  tooth         Tooth?         @relation(fields: [toothId], references: [id])
  nzaCode       NzaCode?       @relation(fields: [nzaCodeId], references: [id])
  toothSurfaces ToothSurface[]
  invoiceLines  InvoiceLine[]

  @@map("treatments")
}

enum TreatmentStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model ClinicalNote {
  id             String   @id @default(uuid())
  practiceId     String   @map("practice_id")
  patientId      String   @map("patient_id")
  appointmentId  String?  @map("appointment_id")
  authorId       String   @map("author_id")
  noteType       NoteType @default(PROGRESS) @map("note_type")
  content        String
  isConfidential Boolean  @default(false) @map("is_confidential")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  practice    Practice     @relation(fields: [practiceId], references: [id])
  patient     Patient      @relation(fields: [patientId], references: [id])
  appointment Appointment? @relation(fields: [appointmentId], references: [id])
  author      User         @relation("Author", fields: [authorId], references: [id])
  flags       NoteFlag[]

  @@map("clinical_notes")
}

model NoteFlag {
  id          String       @id @default(uuid())
  noteId      String       @map("note_id")
  flagType    String       @map("flag_type") // 'Needs follow-up', 'Noted', 'Urgent', 'Discuss at next visit'
  comment     String?
  createdById String       @map("created_by_id")
  createdAt   DateTime     @default(now()) @map("created_at")

  note      ClinicalNote @relation(fields: [noteId], references: [id])
  createdBy User         @relation("NoteFlagCreator", fields: [createdById], references: [id])

  @@map("note_flags")
}

enum NoteType {
  PROGRESS
  SOAP
  REFERRAL
  CONSENT
  HYGIENE
}

// ============================================================
// APPOINTMENTS & SCHEDULING
// ============================================================

model Appointment {
  id             String @id @default(uuid())
  practiceId     String @map("practice_id")
  patientId      String @map("patient_id")
  practitionerId String @map("practitioner_id")

  startTime       DateTime @map("start_time")
  endTime         DateTime @map("end_time")
  durationMinutes Int      @map("duration_minutes")

  appointmentType AppointmentType   @map("appointment_type")
  status          AppointmentStatus @default(SCHEDULED)
  room            String?
  notes           String?
  patientNotes    String?           @map("patient_notes")

  reminderSentAt     DateTime? @map("reminder_sent_at")
  confirmationSentAt DateTime? @map("confirmation_sent_at")
  cancelledAt        DateTime? @map("cancelled_at")
  cancelReason       String?   @map("cancel_reason")

  recurringRule Json?   @map("recurring_rule")
  parentId      String? @map("parent_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  practice      Practice       @relation(fields: [practiceId], references: [id])
  patient       Patient        @relation(fields: [patientId], references: [id])
  practitioner  User           @relation("Practitioner", fields: [practitionerId], references: [id])
  treatments    Treatment[]
  clinicalNotes ClinicalNote[]
  parent        Appointment?   @relation("RecurringAppointments", fields: [parentId], references: [id])
  children      Appointment[]  @relation("RecurringAppointments")
  prescriptions Prescription[]
  consentForms  ConsentForm[]
  perioSessions PerioSession[]

  @@map("appointments")
}

enum AppointmentType {
  CHECKUP
  TREATMENT
  EMERGENCY
  CONSULTATION
  HYGIENE
}

enum AppointmentStatus {
  PENDING_APPROVAL
  SCHEDULED
  CONFIRMED
  CHECKED_IN
  IN_PROGRESS
  COMPLETED
  NO_SHOW
  CANCELLED
}

model PractitionerSchedule {
  id             String    @id @default(uuid())
  practiceId     String    @map("practice_id")
  practitionerId String    @map("practitioner_id")
  dayOfWeek      Int       @map("day_of_week") // 0=Monday, 6=Sunday
  startTime      String    @map("start_time") // HH:mm format
  endTime        String    @map("end_time") // HH:mm format
  slotDuration   Int       @default(15) @map("slot_duration")
  isActive       Boolean   @default(true) @map("is_active")
  validFrom      DateTime  @default(now()) @map("valid_from")
  validUntil     DateTime? @map("valid_until")
  createdAt      DateTime  @default(now()) @map("created_at")

  // Relations
  practice     Practice @relation(fields: [practiceId], references: [id])
  practitioner User     @relation(fields: [practitionerId], references: [id])

  @@map("practitioner_schedules")
}

model ScheduleException {
  id             String        @id @default(uuid())
  practiceId     String        @map("practice_id")
  practitionerId String        @map("practitioner_id")
  exceptionDate  DateTime      @map("exception_date")
  exceptionType  ExceptionType @map("exception_type")
  startTime      String?       @map("start_time")
  endTime        String?       @map("end_time")
  reason         String?
  createdAt      DateTime      @default(now()) @map("created_at")

  // Relations
  practice     Practice @relation(fields: [practiceId], references: [id])
  practitioner User     @relation(fields: [practitionerId], references: [id])

  @@map("schedule_exceptions")
}

enum ExceptionType {
  HOLIDAY
  SICK
  TRAINING
  CUSTOM
}

// ============================================================
// BILLING & PAYMENTS
// ============================================================

model NzaCode {
  id              String   @id @default(uuid())
  code            String
  category        String
  descriptionNl   String   @map("description_nl")
  descriptionEn   String?  @map("description_en")
  maxTariff       Decimal  @map("max_tariff") @db.Decimal(10, 2)
  unit            String   @default("per_treatment")
  requiresTooth   Boolean  @default(false) @map("requires_tooth")
  requiresSurface Boolean  @default(false) @map("requires_surface")
  validFrom       DateTime @map("valid_from")
  validUntil      DateTime @map("valid_until")
  subcategory     String?  @map("subcategory")
  toelichting     String?  @map("toelichting") @db.Text
  points          Decimal? @map("points") @db.Decimal(10, 2)
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  treatments          Treatment[]
  invoiceLines        InvoiceLine[]
  customCategoryCodes CustomCodeCategoryCode[]

  @@unique([code, validFrom])
  @@map("nza_codes")
}

model Invoice {
  id              String        @id @default(uuid())
  practiceId      String        @map("practice_id")
  patientId       String        @map("patient_id")
  invoiceNumber   String        @map("invoice_number")
  invoiceDate     DateTime      @default(now()) @map("invoice_date")
  dueDate         DateTime      @map("due_date")
  subtotal        Decimal       @db.Decimal(10, 2)
  taxAmount       Decimal       @default(0) @map("tax_amount") @db.Decimal(10, 2)
  total           Decimal       @db.Decimal(10, 2)
  insuranceAmount Decimal       @default(0) @map("insurance_amount") @db.Decimal(10, 2)
  patientAmount   Decimal       @map("patient_amount") @db.Decimal(10, 2)
  status          InvoiceStatus @default(DRAFT)
  paidAmount      Decimal       @default(0) @map("paid_amount") @db.Decimal(10, 2)
  paymentMethod   String?       @map("payment_method")
  claimStatus     String?       @map("claim_status")
  claimReference  String?       @map("claim_reference")
  notes           String?
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  practice        Practice         @relation(fields: [practiceId], references: [id])
  patient         Patient          @relation(fields: [patientId], references: [id])
  lines           InvoiceLine[]
  payments        Payment[]
  insuranceClaims InsuranceClaim[]

  @@unique([practiceId, invoiceNumber])
  @@map("invoices")
}

enum InvoiceStatus {
  DRAFT
  SENT
  PARTIALLY_PAID
  PAID
  OVERDUE
  CANCELLED
  CREDITED
}

model InvoiceLine {
  id          String   @id @default(uuid())
  practiceId  String   @map("practice_id")
  invoiceId   String   @map("invoice_id")
  treatmentId String?  @map("treatment_id")
  nzaCodeId   String?  @map("nza_code_id")
  description String
  nzaCode     String?  @map("nza_code")
  toothNumber Int?     @map("tooth_number")
  surface     String?
  quantity    Int      @default(1)
  unitPrice   Decimal  @map("unit_price") @db.Decimal(10, 2)
  lineTotal   Decimal  @map("line_total") @db.Decimal(10, 2)
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  practice   Practice   @relation(fields: [practiceId], references: [id])
  invoice    Invoice    @relation(fields: [invoiceId], references: [id])
  treatment  Treatment? @relation(fields: [treatmentId], references: [id])
  nzaCodeRef NzaCode?   @relation(fields: [nzaCodeId], references: [id])

  @@map("invoice_lines")
}

model Payment {
  id                String        @id @default(uuid())
  practiceId        String        @map("practice_id")
  invoiceId         String        @map("invoice_id")
  amount            Decimal       @db.Decimal(10, 2)
  method            PaymentMethod
  status            PaymentStatus @default(PENDING)
  molliePaymentId   String?       @map("mollie_payment_id")
  mollieStatus      String?       @map("mollie_status")
  mollieCheckoutUrl String?       @map("mollie_checkout_url")
  paidAt            DateTime?     @map("paid_at")
  refundedAt        DateTime?     @map("refunded_at")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  practice Practice @relation(fields: [practiceId], references: [id])
  invoice  Invoice  @relation(fields: [invoiceId], references: [id])

  @@map("payments")
}

enum PaymentMethod {
  IDEAL
  SEPA_DIRECT_DEBIT
  BANK_TRANSFER
  CASH
  PIN
  CREDIT_CARD
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// ============================================================
// INSURANCE CLAIMS (VECOZO)
// ============================================================

model InsuranceClaim {
  id              String      @id @default(uuid())
  practiceId      String      @map("practice_id")
  patientId       String      @map("patient_id")
  invoiceId       String      @map("invoice_id")
  uzoviCode       String      @map("uzovi_code")
  claimNumber     String?     @map("claim_number")
  claimData       Json        @map("claim_data")
  status          ClaimStatus @default(DRAFT)
  submittedAt     DateTime?   @map("submitted_at")
  responseAt      DateTime?   @map("response_at")
  responseData    Json?       @map("response_data")
  rejectionReason String?     @map("rejection_reason")
  amountClaimed   Decimal?    @map("amount_claimed") @db.Decimal(10, 2)
  amountApproved  Decimal?    @map("amount_approved") @db.Decimal(10, 2)
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  practice Practice @relation(fields: [practiceId], references: [id])
  patient  Patient  @relation(fields: [patientId], references: [id])
  invoice  Invoice  @relation(fields: [invoiceId], references: [id])

  @@map("insurance_claims")
}

enum ClaimStatus {
  DRAFT
  SUBMITTED
  ACKNOWLEDGED
  ACCEPTED
  REJECTED
  PARTIAL
  APPEALED
}

// ============================================================
// CONSENT & DOCUMENTS
// ============================================================

model ConsentTemplate {
  id          String   @id @default(uuid())
  practiceId  String   @map("practice_id")
  title       String
  contentNl   String   @map("content_nl") @db.Text
  contentEn   String?  @map("content_en") @db.Text
  consentType String   @map("consent_type")
  isActive    Boolean  @default(true) @map("is_active")
  expiryDays  Int?     @map("expiry_days")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  practice     Practice      @relation(fields: [practiceId], references: [id])
  consentForms ConsentForm[]

  @@map("consent_templates")
}

model ConsentForm {
  id              String    @id @default(uuid())
  practiceId      String    @map("practice_id")
  patientId       String    @map("patient_id")
  consentType     String    @map("consent_type")
  treatmentType   String    @default("GENERAL") @map("treatment_type")
  title           String    @default("")
  content         String    @default("") @db.Text
  treatmentPlanId String?   @map("treatment_plan_id")
  templateId      String?   @map("template_id")
  description     String
  signedAt        DateTime? @map("signed_at")
  signatureData   String?   @map("signature_data") @db.Text
  signedByName    String?   @map("signed_by_name")
  signedIp        String?   @map("signed_ip")
  signedUserAgent String?   @map("signed_user_agent")
  signerRelation  String?   @map("signer_relation") // SELF, PARENT, GUARDIAN
  signatureUrl    String?   @map("signature_url") // Vercel Blob URL for PNG
  documentUrl     String?   @map("document_url")
  emailSentAt     DateTime? @map("email_sent_at")
  emailAddress    String?   @map("email_address")
  appointmentId   String?   @map("appointment_id")
  version         Int       @default(1)
  language        String    @default("nl")
  status          String    @default("PENDING") // PENDING, SIGNED, REVOKED, EXPIRED
  expiresAt       DateTime? @map("expires_at")
  revokedAt       DateTime? @map("revoked_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  practice      Practice        @relation(fields: [practiceId], references: [id])
  patient       Patient         @relation(fields: [patientId], references: [id])
  treatmentPlan TreatmentPlan?  @relation(fields: [treatmentPlanId], references: [id])
  template      ConsentTemplate? @relation(fields: [templateId], references: [id])
  appointment   Appointment?    @relation(fields: [appointmentId], references: [id])

  @@map("consent_forms")
}

model Document {
  id           String   @id @default(uuid())
  practiceId   String   @map("practice_id")
  patientId    String?  @map("patient_id")
  uploadedBy   String?  @map("uploaded_by")
  documentType String   @map("document_type")
  title        String
  description  String?
  s3Bucket     String?  @map("s3_bucket")
  s3Key        String?  @map("s3_key")
  fileSize     BigInt?  @map("file_size")
  mimeType     String?  @map("mime_type")
  toothNumber  Int?     @map("tooth_number")
  imageType    String?  @map("image_type")
  isArchived          Boolean          @default(false) @map("is_archived")
  uploadedByPatientId String?          @map("uploaded_by_patient_id")
  approvalStatus      DocumentApprovalStatus? @map("approval_status")
  createdAt           DateTime         @default(now()) @map("created_at")

  // Relations
  practice        Practice @relation(fields: [practiceId], references: [id])
  patient         Patient? @relation(fields: [patientId], references: [id])
  uploader        User?    @relation("UploadedBy", fields: [uploadedBy], references: [id])
  uploadedByPatient Patient? @relation("PatientDocumentUploader", fields: [uploadedByPatientId], references: [id])

  @@map("documents")
}

// ============================================================
// AUDIT LOG (APPEND-ONLY)
// ============================================================

model AuditLog {
  id              String   @id @default(uuid())
  practiceId      String?  @map("practice_id")
  userId          String?  @map("user_id")
  action          String
  resourceType    String   @map("resource_type")
  resourceId      String?  @map("resource_id")
  oldValues       Json?    @map("old_values")
  newValues       Json?    @map("new_values")
  ipAddress       String?  @map("ip_address")
  userAgent       String?  @map("user_agent")
  sessionId       String?  @map("session_id")
  bsnAccessed     Boolean  @default(false) @map("bsn_accessed")
  bsnAccessReason String?  @map("bsn_access_reason")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  practice Practice? @relation(fields: [practiceId], references: [id])
  user     User?     @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

// ============================================================
// NOTIFICATIONS
// ============================================================

model Notification {
  id           String              @id @default(uuid())
  practiceId   String              @map("practice_id")
  userId       String?             @map("user_id")
  patientId    String?             @map("patient_id")
  channel      NotificationChannel
  template     String
  subject      String?
  content      String?
  status       NotificationStatus  @default(PENDING)
  sentAt       DateTime?           @map("sent_at")
  readAt       DateTime?           @map("read_at")
  externalId   String?             @map("external_id")
  errorMessage String?             @map("error_message")
  metadata     Json?               @default("{}")
  createdAt    DateTime            @default(now()) @map("created_at")

  // Relations
  practice Practice @relation(fields: [practiceId], references: [id])
  user     User?    @relation(fields: [userId], references: [id])
  patient  Patient? @relation(fields: [patientId], references: [id])

  @@map("notifications")
}

enum NotificationChannel {
  EMAIL
  SMS
  PUSH
  IN_APP
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  READ
}

// ============================================================
// CREDENTIALS & API KEYS
// ============================================================

model Credential {
  id          String         @id @default(uuid())
  practiceId  String         @map("practice_id")
  name        String // Display name (e.g., "Mollie Production")
  type        CredentialType // MOLLIE, TWILIO, AWS, VECOZO, etc.
  environment String         @default("production") // production, test, sandbox

  // Encrypted values (in production, use proper encryption)
  apiKey       String? @map("api_key")
  apiSecret    String? @map("api_secret")
  accessToken  String? @map("access_token")
  refreshToken String? @map("refresh_token")

  // Configuration
  config Json? // Additional config (region, endpoints, etc.)

  // Metadata
  isActive   Boolean   @default(true) @map("is_active")
  isTestMode Boolean   @default(false) @map("is_test_mode")
  lastUsedAt DateTime? @map("last_used_at")
  expiresAt  DateTime? @map("expires_at")

  // Audit
  createdBy String?  @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  practice Practice @relation(fields: [practiceId], references: [id])

  @@index([practiceId, type])
  @@index([practiceId, environment])
  @@map("credentials")
}

enum CredentialType {
  MOLLIE
  TWILIO
  AWS
  VECOZO
  SENDGRID
  MAILGUN
  RESEND
  CUSTOM
  GMAIL
}

// ============================================================
// PRESCRIPTIONS
// ============================================================

model Prescription {
  id            String  @id @default(uuid())
  practiceId    String  @map("practice_id")
  patientId     String  @map("patient_id")
  appointmentId String? @map("appointment_id")
  prescribedBy  String  @map("prescribed_by")

  medicationName String  @map("medication_name")
  genericName    String? @map("generic_name")
  dosage         String // e.g., "500mg"
  frequency      String // e.g., "3x per dag"
  duration       String? // e.g., "7 dagen"
  quantity       Int? // e.g., 21 tablets
  route          String  @default("oraal") // oraal, topicaal, spoeling
  instructions   String? // e.g., "Innemen na de maaltijd"

  status         PrescriptionStatus @default(ACTIVE)
  prescribedAt   DateTime           @default(now()) @map("prescribed_at")
  discontinuedAt DateTime?          @map("discontinued_at")
  createdAt      DateTime           @default(now()) @map("created_at")
  updatedAt      DateTime           @updatedAt @map("updated_at")

  // Relations
  practice    Practice     @relation(fields: [practiceId], references: [id])
  patient     Patient      @relation(fields: [patientId], references: [id])
  appointment Appointment? @relation(fields: [appointmentId], references: [id])
  prescriber  User         @relation("Prescriber", fields: [prescribedBy], references: [id])

  @@map("prescriptions")
}

enum PrescriptionStatus {
  ACTIVE
  COMPLETED
  DISCONTINUED
  CANCELLED
}

// ============================================================
// PERIODONTAL CHARTS
// ============================================================

model PeriodontalChart {
  id            String   @id @default(uuid())
  practiceId    String   @map("practice_id")
  patientId     String   @map("patient_id")
  appointmentId String?  @map("appointment_id")
  authorId      String   @map("author_id")
  chartData     Json     @map("chart_data")
  sessionNote   String?  @map("session_note")
  createdAt     DateTime @default(now()) @map("created_at")

  practice Practice @relation(fields: [practiceId], references: [id])
  patient  Patient  @relation(fields: [patientId], references: [id])
  author   User     @relation("PeriodontalChartAuthor", fields: [authorId], references: [id])

  @@map("periodontal_charts")
}

// ============================================================
// PATIENT IMAGES (X-RAY / RONTGEN)
// ============================================================

model PatientImage {
  id         String   @id @default(uuid())
  practiceId String   @map("practice_id")
  patientId  String   @map("patient_id")
  uploadedBy String   @map("uploaded_by")
  fileName   String   @map("file_name")
  filePath   String   @map("file_path")
  fileSize   Int      @map("file_size")
  mimeType   String   @map("mime_type")
  imageType  String   @default("XRAY") @map("image_type") // XRAY, CEPHALOMETRIC, INTRAORAL_SCAN, INTRAORAL_PHOTO, FACIAL, EXTRAORAL, OTHER
  notes      String?
  createdAt  DateTime @default(now()) @map("created_at")

  practice   Practice    @relation(fields: [practiceId], references: [id])
  patient    Patient     @relation(fields: [patientId], references: [id])
  uploader   User        @relation("PatientImageUploader", fields: [uploadedBy], references: [id])
  dsdDesigns DsdDesign[]

  @@map("patient_images")
}

// ============================================================
// ANAMNESIS (Medical History Questionnaire)
// ============================================================

model Anamnesis {
  id          String    @id @default(uuid())
  practiceId  String    @map("practice_id")
  patientId   String    @map("patient_id")
  version     Int       @default(1)
  data        Json // All questionnaire answers
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  practice Practice @relation(fields: [practiceId], references: [id])
  patient  Patient  @relation(fields: [patientId], references: [id])

  @@map("anamneses")
}

// ============================================================
// MESSAGES (Patient-Practice Communication)
// ============================================================

model Message {
  id         String     @id @default(uuid())
  practiceId String     @map("practice_id")
  patientId  String     @map("patient_id")
  senderId   String?    @map("sender_id") // User ID if sent by staff, null if from patient
  senderType SenderType @map("sender_type") // PATIENT or STAFF
  content    String
  isRead     Boolean    @default(false) @map("is_read")
  readAt     DateTime?  @map("read_at")
  createdAt  DateTime   @default(now()) @map("created_at")

  // Relations
  practice Practice @relation(fields: [practiceId], references: [id])
  patient  Patient  @relation(fields: [patientId], references: [id])
  sender   User?    @relation("MessageSender", fields: [senderId], references: [id])

  @@index([patientId, createdAt])
  @@index([practiceId, patientId])
  @@index([isRead])
  @@map("messages")
}

enum SenderType {
  PATIENT
  STAFF
}

// ============================================================
// REFERRALS
// ============================================================

model Referral {
  id                 String          @id @default(uuid())
  practiceId         String          @map("practice_id")
  patientId          String          @map("patient_id")
  createdBy          String          @map("created_by")

  specialistType     String          @map("specialist_type")
  specialistName     String?         @map("specialist_name")
  specialistPractice String?         @map("specialist_practice")
  specialistPhone    String?         @map("specialist_phone")
  specialistEmail    String?         @map("specialist_email")

  reason             String
  clinicalInfo       String?         @map("clinical_info") @db.Text
  urgency            ReferralUrgency @default(ROUTINE)
  status             ReferralStatus  @default(SENT)

  referralDate       DateTime        @default(now()) @map("referral_date")
  appointmentMadeAt  DateTime?       @map("appointment_made_at")
  completedAt        DateTime?       @map("completed_at")

  pdfUrl             String?         @map("pdf_url")

  createdAt          DateTime        @default(now()) @map("created_at")
  updatedAt          DateTime        @updatedAt @map("updated_at")

  practice  Practice @relation(fields: [practiceId], references: [id])
  patient   Patient  @relation(fields: [patientId], references: [id])
  creator   User     @relation("ReferralCreator", fields: [createdBy], references: [id])

  @@map("referrals")
}

enum ReferralUrgency {
  ROUTINE
  URGENT
  EMERGENCY
}

enum ReferralStatus {
  SENT
  APPOINTMENT_MADE
  COMPLETED
  CANCELLED
}

// ============================================================
// COMPLAINTS (Wkkgz compliant)
// ============================================================

model Complaint {
  id               String           @id @default(uuid())
  practiceId       String           @map("practice_id")
  patientId        String?          @map("patient_id")

  type             ComplaintType
  subject          ComplaintSubject
  description      String           @db.Text
  attachmentUrl    String?          @map("attachment_url")

  anonymous        Boolean          @default(false)
  referenceNumber  String           @unique @map("reference_number")

  status           ComplaintStatus  @default(ONTVANGEN)
  response         String?          @db.Text
  resolvedAt       DateTime?        @map("resolved_at")

  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  practice Practice  @relation(fields: [practiceId], references: [id])
  patient  Patient?  @relation(fields: [patientId], references: [id])

  @@map("complaints")
}

enum ComplaintType {
  KLACHT
  SUGGESTIE
  COMPLIMENT
}

enum ComplaintSubject {
  BEHANDELING
  COMMUNICATIE
  WACHTTIJD
  HYGIENE
  BEREIKBAARHEID
  FACTURERING
  PERSONEEL
  OVERIG
}

enum ComplaintStatus {
  ONTVANGEN
  IN_BEHANDELING
  AFGEHANDELD
}

// ============================================================
// EMAIL & WHATSAPP INTEGRATION
// ============================================================

model EmailThread {
  id              String   @id @default(uuid())
  practiceId      String   @map("practice_id")
  gmailThreadId   String   @map("gmail_thread_id")
  gmailMessageIds String[] @map("gmail_message_ids")

  subject         String
  participants    String[]
  lastMessageAt   DateTime @map("last_message_at")

  patientId       String?  @map("patient_id")

  isUnread        Boolean  @default(false) @map("is_unread")
  isStarred       Boolean  @default(false) @map("is_starred")
  labels          String[]

  snippet         String?

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  practice Practice @relation(fields: [practiceId], references: [id])
  patient  Patient? @relation(fields: [patientId], references: [id])
  messages EmailMessage[]

  @@unique([practiceId, gmailThreadId])
  @@index([practiceId, lastMessageAt])
  @@index([patientId])
  @@map("email_threads")
}

model EmailMessage {
  id             String   @id @default(uuid())
  practiceId     String   @map("practice_id")
  threadId       String   @map("thread_id")
  gmailMessageId String   @map("gmail_message_id")

  from           String
  to             String[]
  cc             String[]
  bcc            String[]

  subject        String
  bodyHtml       String?  @map("body_html") @db.Text
  bodyText       String?  @map("body_text") @db.Text
  snippet        String?

  attachments    Json?    @default("[]")

  isUnread       Boolean  @default(false) @map("is_unread")
  isStarred      Boolean  @default(false) @map("is_starred")
  labels         String[]

  internalDate   DateTime @map("internal_date")
  createdAt      DateTime @default(now()) @map("created_at")

  practice Practice     @relation(fields: [practiceId], references: [id])
  thread   EmailThread  @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@unique([practiceId, gmailMessageId])
  @@index([threadId])
  @@map("email_messages")
}

model WhatsAppConversation {
  id            String   @id @default(uuid())
  practiceId    String   @map("practice_id")
  patientId     String   @map("patient_id")

  phoneNumber   String   @map("phone_number")
  lastMessageAt DateTime @map("last_message_at")
  isActive      Boolean  @default(true) @map("is_active")

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  practice Practice            @relation(fields: [practiceId], references: [id])
  patient  Patient             @relation(fields: [patientId], references: [id])
  messages WhatsAppMessage[]

  @@unique([practiceId, patientId])
  @@index([practiceId, lastMessageAt])
  @@map("whatsapp_conversations")
}

model WhatsAppMessage {
  id             String   @id @default(uuid())
  practiceId     String   @map("practice_id")
  conversationId String   @map("conversation_id")

  twilioSid      String   @unique @map("twilio_sid")
  direction      String   // 'inbound' or 'outbound'
  from           String
  to             String
  body           String?
  mediaUrl       String?  @map("media_url")
  mediaType      String?  @map("media_type")

  status         String   // 'sent', 'delivered', 'read', 'failed'
  errorCode      String?  @map("error_code")
  errorMessage   String?  @map("error_message")

  sentBy         String?  @map("sent_by")

  createdAt      DateTime @default(now()) @map("created_at")

  practice     Practice              @relation(fields: [practiceId], references: [id])
  conversation WhatsAppConversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User?                 @relation("WhatsAppSender", fields: [sentBy], references: [id])

  @@index([conversationId, createdAt])
  @@map("whatsapp_messages")
}

// ============================================================
// PATIENT CATEGORIES
// ============================================================

model PatientCategory {
  id         String   @id @default(uuid())
  patientId  String   @map("patient_id")
  category   String
  assignedAt DateTime @default(now()) @map("assigned_at")

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@unique([patientId, category])
  @@map("patient_categories")
}

// ============================================================
// CUSTOM CODE CATEGORIES
// ============================================================

model CustomCodeCategory {
  id          String   @id @default(uuid())
  name        String
  description String?
  practiceId  String   @map("practice_id")
  practice    Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  createdBy   String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  codes CustomCodeCategoryCode[]

  @@map("custom_code_categories")
}

model CustomCodeCategoryCode {
  id         String              @id @default(uuid())
  categoryId String              @map("category_id")
  category   CustomCodeCategory  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  nzaCodeId  String              @map("nza_code_id")
  nzaCode    NzaCode             @relation(fields: [nzaCodeId], references: [id], onDelete: Cascade)

  @@unique([categoryId, nzaCodeId])
  @@map("custom_code_category_codes")
}

// ============================================================
// DIGITAL SMILE DESIGN (DSD)
// ============================================================

enum DsdStatus {
  DRAFT
  IN_PROGRESS
  REVIEW
  APPROVED
  ARCHIVED
}

model DsdDesign {
  id         String    @id @default(uuid())
  practiceId String    @map("practice_id")
  patientId  String    @map("patient_id")
  createdBy  String    @map("created_by")
  title      String
  status     DsdStatus @default(DRAFT)
  imageId    String    @map("image_id")
  notes      String?   @db.Text
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  practice Practice           @relation(fields: [practiceId], references: [id])
  patient  Patient            @relation(fields: [patientId], references: [id])
  creator  User               @relation("DsdDesignCreator", fields: [createdBy], references: [id])
  image    PatientImage       @relation(fields: [imageId], references: [id])
  versions DsdDesignVersion[]

  @@index([patientId])
  @@map("dsd_designs")
}

model DsdDesignVersion {
  id              String   @id @default(uuid())
  designId        String   @map("design_id")
  versionNumber   Int      @map("version_number")
  createdBy       String   @map("created_by")
  notes           String?  @db.Text
  landmarkData    Json     @map("landmark_data")
  calibrationData Json?    @map("calibration_data")
  measurements    Json?
  derivedLines    Json?    @map("derived_lines")
  stlFileUrl      String?  @map("stl_file_url")
  stlFileName     String?  @map("stl_file_name")
  createdAt       DateTime @default(now()) @map("created_at")

  design DsdDesign @relation(fields: [designId], references: [id], onDelete: Cascade)

  @@unique([designId, versionNumber])
  @@map("dsd_design_versions")
}

// ============================================================
// CONVERSATIONS (Threaded Patient-Staff Messaging)
// ============================================================

enum DocumentApprovalStatus {
  PENDING_REVIEW
  APPROVED
  REJECTED
}

enum ConversationStatus {
  OPEN
  CLOSED
}

model Conversation {
  id             String             @id @default(uuid())
  practiceId     String             @map("practice_id")
  patientId      String             @map("patient_id")
  practitionerId String             @map("practitioner_id")
  subject        String
  status         ConversationStatus @default(OPEN)
  createdAt      DateTime           @default(now()) @map("created_at")
  updatedAt      DateTime           @updatedAt @map("updated_at")

  practice     Practice              @relation(fields: [practiceId], references: [id])
  patient      Patient               @relation(fields: [patientId], references: [id])
  practitioner User                  @relation("ConversationPractitioner", fields: [practitionerId], references: [id])
  messages     ConversationMessage[]

  @@index([patientId, updatedAt])
  @@index([practitionerId, status])
  @@map("conversations")
}

model ConversationMessage {
  id             String     @id @default(uuid())
  conversationId String     @map("conversation_id")
  senderType     SenderType @map("sender_type")
  senderId       String?    @map("sender_id")
  content        String
  isRead         Boolean    @default(false) @map("is_read")
  createdAt      DateTime   @default(now()) @map("created_at")

  conversation Conversation        @relation(fields: [conversationId], references: [id])
  sender       User?               @relation("ConversationMessageSender", fields: [senderId], references: [id])
  attachments  MessageAttachment[]

  @@index([conversationId, createdAt])
  @@map("conversation_messages")
}

model MessageAttachment {
  id        String   @id @default(uuid())
  messageId String   @map("message_id")
  fileName  String   @map("file_name")
  fileUrl   String   @map("file_url")
  fileSize  Int      @map("file_size")
  mimeType  String   @map("mime_type")
  createdAt DateTime @default(now()) @map("created_at")

  message ConversationMessage @relation(fields: [messageId], references: [id])

  @@map("message_attachments")
}

// ============================================================
// DENTIST TASKS
// ============================================================

enum TaskCategory {
  CLINICAL_NOTE
  INVOICE
  PRESCRIPTION
  TREATMENT
  CUSTOM
}

enum TaskPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum TaskStatus {
  NOT_DONE
  IN_PROGRESS
  DONE
}

model DentistTask {
  id          String       @id @default(uuid())
  practiceId  String       @map("practice_id")
  userId      String       @map("user_id")
  patientId   String?      @map("patient_id")
  title       String
  description String?
  category    TaskCategory
  targetType  String?      @map("target_type")
  targetId    String?      @map("target_id")
  dueDate     DateTime?    @map("due_date")
  priority    TaskPriority @default(NORMAL)
  status      TaskStatus   @default(NOT_DONE)
  completedAt DateTime?    @map("completed_at")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  practice Practice  @relation(fields: [practiceId], references: [id])
  user     User      @relation("AssignedTasks", fields: [userId], references: [id])
  patient  Patient?  @relation(fields: [patientId], references: [id])

  @@unique([userId, targetType, targetId])
  @@index([userId, status])
  @@index([userId, dueDate])
  @@map("dentist_tasks")
}

// ============================================================
// AI CHAT & PATIENT NUDGES
// ============================================================

model AiChatSession {
  id         String   @id @default(uuid())
  practiceId String   @map("practice_id")
  patientId  String   @map("patient_id")
  title      String?
  metadata   Json?    @default("{}")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  practice Practice        @relation(fields: [practiceId], references: [id])
  patient  Patient         @relation(fields: [patientId], references: [id])
  messages AiChatMessage[]

  @@index([patientId, updatedAt])
  @@map("ai_chat_sessions")
}

model AiChatMessage {
  id        String   @id @default(uuid())
  sessionId String   @map("session_id")
  role      String
  content   String   @db.Text
  richCards Json?    @map("rich_cards")
  feedback  String?
  createdAt DateTime @default(now()) @map("created_at")

  session AiChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@map("ai_chat_messages")
}

model PatientNudge {
  id         String    @id @default(uuid())
  practiceId String    @map("practice_id")
  patientId  String    @map("patient_id")
  nudgeType  String    @map("nudge_type")
  channel    String
  message    String    @db.Text
  sentAt     DateTime  @default(now()) @map("sent_at")
  clickedAt  DateTime? @map("clicked_at")
  bookedAt   DateTime? @map("booked_at")
  metadata   Json?     @default("{}")

  practice Practice @relation(fields: [practiceId], references: [id])
  patient  Patient  @relation(fields: [patientId], references: [id])

  @@index([patientId, nudgeType, sentAt])
  @@map("patient_nudges")
}

// ============================================================
// STAFF CHAT (Internal Team Messaging)
// ============================================================

model StaffChat {
  id         String   @id @default(uuid())
  practiceId String   @map("practice_id")
  name       String?
  isGroup    Boolean  @default(false) @map("is_group")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  practice Practice           @relation(fields: [practiceId], references: [id])
  members  StaffChatMember[]
  messages StaffChatMessage[]

  @@map("staff_chats")
}

model StaffChatMember {
  id       String   @id @default(uuid())
  chatId   String   @map("chat_id")
  userId   String   @map("user_id")
  joinedAt DateTime @default(now()) @map("joined_at")

  chat StaffChat @relation(fields: [chatId], references: [id])
  user User      @relation(fields: [userId], references: [id])

  @@unique([chatId, userId])
  @@map("staff_chat_members")
}

model StaffChatMessage {
  id        String   @id @default(uuid())
  chatId    String   @map("chat_id")
  senderId  String   @map("sender_id")
  content   String
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  chat   StaffChat @relation(fields: [chatId], references: [id])
  sender User      @relation(fields: [senderId], references: [id])

  @@index([chatId, createdAt])
  @@map("staff_chat_messages")
}

// ============================================================
// PERIODONTAL (Relational â€” replaces JSON chartData approach)
// ============================================================

enum PerioSessionType {
  FULL
  PARTIAL
  RE_EVALUATION
}

enum PerioProtocolStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

enum RecallStatus {
  DUE
  OVERDUE
  COMPLETED
  CANCELLED
}

model PerioSession {
  id          String           @id @default(uuid())
  practiceId  String           @map("practice_id")
  patientId   String           @map("patient_id")
  appointmentId String?        @map("appointment_id")
  authorId    String           @map("author_id")
  sessionType PerioSessionType @map("session_type")
  sessionNote String?          @map("session_note")
  protocolId  String?          @map("protocol_id")
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  practice    Practice         @relation(fields: [practiceId], references: [id])
  patient     Patient          @relation(fields: [patientId], references: [id])
  appointment Appointment?     @relation(fields: [appointmentId], references: [id])
  author      User             @relation("PerioSessionAuthor", fields: [authorId], references: [id])
  protocol    PerioProtocol?   @relation(fields: [protocolId], references: [id])
  sites       PerioSite[]

  @@map("perio_sessions")
}

model PerioSite {
  id              String  @id @default(uuid())
  sessionId       String  @map("session_id")
  toothNumber     Int     @map("tooth_number")
  surface         String  // buccal or lingual
  sitePosition    String  @map("site_position") // mesial, mid, distal
  probingDepth    Int     @map("probing_depth")
  gingivalMargin  Int     @map("gingival_margin") // negative = recession
  bleeding        Boolean @default(false)
  plaque          Boolean @default(false)
  suppuration     Boolean @default(false)
  mobility        Int?
  furcationGrade  Int?    @map("furcation_grade") // 0-3
  isImplant       Boolean @default(false) @map("is_implant")
  toothNote       String? @map("tooth_note")
  keratinizedWidth Int?   @map("keratinized_width")

  session PerioSession @relation(fields: [sessionId], references: [id])

  @@index([sessionId, toothNumber])
  @@map("perio_sites")
}

model PerioProtocol {
  id         String              @id @default(uuid())
  practiceId String              @map("practice_id")
  patientId  String              @map("patient_id")
  status     PerioProtocolStatus @default(ACTIVE)
  steps      Json                @default("[]")
  createdAt  DateTime            @default(now()) @map("created_at")
  updatedAt  DateTime            @updatedAt @map("updated_at")

  practice Practice       @relation(fields: [practiceId], references: [id])
  patient  Patient        @relation(fields: [patientId], references: [id])
  sessions PerioSession[]

  @@map("perio_protocols")
}

model RecallSchedule {
  id              String       @id @default(uuid())
  practiceId      String       @map("practice_id")
  patientId       String       @map("patient_id")
  intervalMonths  Int          @map("interval_months")
  nextDueDate     DateTime     @map("next_due_date")
  status          RecallStatus @default(DUE)
  lastCompletedAt DateTime?    @map("last_completed_at")
  reminderSentAt  DateTime?    @map("reminder_sent_at")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  practice Practice @relation(fields: [practiceId], references: [id])
  patient  Patient  @relation(fields: [patientId], references: [id])

  @@unique([practiceId, patientId])
  @@map("recall_schedules")
}
