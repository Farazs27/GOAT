---
phase: 10-hygienist-portal-periodontogram
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/prisma/schema.prisma
  - packages/database/prisma/seed.ts
  - packages/shared-types/src/odontogram.ts
  - apps/web/src/app/(dashboard)/layout.tsx
autonomous: true
requirements: [HYG-01, HYG-04]

must_haves:
  truths:
    - "HYGIENIST role user sees filtered sidebar without Smile Design, Settings, AI Logs"
    - "Dentist/admin sidebar remains unchanged"
    - "StaffChat, StaffChatMember, StaffChatMessage, NoteFlag models exist in DB"
    - "HYGIENE added to NoteType enum"
    - "PerioToothData extended with suppuration, mucogingivalJunction, keratinizedTissueWidth, implant, missing"
    - "Seed includes a test hygienist user"
  artifacts:
    - path: "packages/database/prisma/schema.prisma"
      provides: "StaffChat models, NoteFlag model, HYGIENE noteType"
      contains: "model StaffChat"
    - path: "apps/web/src/app/(dashboard)/layout.tsx"
      provides: "Role-based nav filtering"
      contains: "HYGIENIST"
    - path: "packages/shared-types/src/odontogram.ts"
      provides: "Extended PerioToothData"
      contains: "suppuration"
  key_links:
    - from: "apps/web/src/app/(dashboard)/layout.tsx"
      to: "JWT token role"
      via: "decode token from localStorage to get userRole"
      pattern: "userRole.*HYGIENIST"
---

<objective>
Schema extensions for hygienist portal (StaffChat models, NoteFlag, HYGIENE noteType, extended PerioToothData) + role-based sidebar nav filtering + seed hygienist account.

Purpose: Foundation for all hygienist features — models, types, nav, and test data.
Output: Updated schema, extended types, role-filtered sidebar, seeded hygienist.
</objective>

<execution_context>
@/Users/farazsharifi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/farazsharifi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-hygienist-portal-periodontogram/10-CONTEXT.md
@.planning/phases/10-hygienist-portal-periodontogram/10-RESEARCH.md
@packages/database/prisma/schema.prisma
@packages/shared-types/src/odontogram.ts
@apps/web/src/app/(dashboard)/layout.tsx
@packages/database/prisma/seed.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema extensions + seed hygienist</name>
  <files>packages/database/prisma/schema.prisma, packages/database/prisma/seed.ts, packages/database/prisma/seed.sql</files>
  <action>
1. Add to schema.prisma:
   - Add `HYGIENE` to `NoteType` enum
   - Add `NoteFlag` model: id, noteId (FK to ClinicalNote), flagType (String — 'Needs follow-up', 'Noted', 'Urgent', 'Discuss at next visit'), comment (String?), createdById (FK to User), createdAt. Map to "note_flags". Add relation on ClinicalNote: `flags NoteFlag[]`. Add relation on User: `noteFlags NoteFlag[]`.
   - Add `StaffChat` model: id, practiceId (FK to Practice), name (String?), isGroup (Boolean default false), createdAt, updatedAt. Map to "staff_chats". Add relation on Practice: `staffChats StaffChat[]`.
   - Add `StaffChatMember` model: id, chatId (FK to StaffChat), userId (FK to User), joinedAt. @@unique([chatId, userId]). Map to "staff_chat_members". Add relation on User: `staffChatMembers StaffChatMember[]`.
   - Add `StaffChatMessage` model: id, chatId (FK to StaffChat), senderId (FK to User), content (String), isRead (Boolean default false), createdAt. @@index([chatId, createdAt]). Map to "staff_chat_messages". Add relation on User: `staffChatMessages StaffChatMessage[]`.
   - Add `sessionNote` (String?) field to PeriodontalChart model for per-session free-text note.

2. In seed.ts, add a hygienist user:
   - Email: `hygienist@tandarts-amsterdam.nl`, password: `Welcome123`, name: `Lisa de Vries`, role: `HYGIENIST`
   - Attach to same practice as existing dentist user
   - Add to seed.sql cleanup: DELETE FROM staff_chat_messages, staff_chat_members, staff_chats, note_flags

3. Run `pnpm db:generate && pnpm db:push` then `pnpm db:seed`.
  </action>
  <verify>Run `pnpm db:generate && pnpm db:push` — no errors. Run `pnpm db:seed` — hygienist created. Check `pnpm --filter @dentflow/web build` passes.</verify>
  <done>All new models exist in DB, HYGIENE noteType available, hygienist user seeded.</done>
</task>

<task type="auto">
  <name>Task 2: Extend PerioToothData + role-based sidebar nav</name>
  <files>packages/shared-types/src/odontogram.ts, apps/web/src/app/(dashboard)/layout.tsx</files>
  <action>
1. In `packages/shared-types/src/odontogram.ts`, extend `PerioToothData`:
   - Add to each side (buccal/palatal): `suppuration: [boolean, boolean, boolean]`, `mucogingivalJunction: [number, number, number]`, `keratinizedTissueWidth: [number, number, number]`
   - Add top-level: `implant?: boolean`, `missing?: boolean`
   - All new fields optional (backward compatible with existing JSON data)
   - Export a helper: `calculateCAL(probingDepth: number, gingivalMargin: number): number` returning `probingDepth + Math.abs(gingivalMargin)`

2. In `apps/web/src/app/(dashboard)/layout.tsx`:
   - The layout is a Server Component currently. Convert the sidebar nav section to use a Client Component `SidebarNav` that reads the user's role from localStorage (decode JWT `access_token` to get role, or store role separately during login).
   - Actually — check how login stores the role. The simplest approach: on login, store `userRole` in localStorage alongside tokens. Then in layout, use a client component wrapper that reads `localStorage.getItem('userRole')`.
   - Create an inline or co-located client component `RoleNav` that:
     - Reads userRole from localStorage
     - Defines `HYGIENIST_HIDDEN = ['/smile-design', '/settings', '/dashboard/ai-logs']`
     - Filters navItems: if role === 'HYGIENIST', exclude items whose href matches HYGIENIST_HIDDEN
     - Renders the filtered nav items (same markup as current)
   - Keep the layout as server component, just extract the nav rendering to a client component
   - In the login API route (`apps/web/src/app/api/auth/login/route.ts`), ensure the response includes `role` so the login page can store it in localStorage. Check if it already does — if yes, just use it.
   - Dentist and admin must see ALL nav items unchanged (default behavior).
  </action>
  <verify>Run `pnpm --filter @dentflow/web build` — no errors. Log in as hygienist (hygienist@tandarts-amsterdam.nl / Welcome123) — sidebar should NOT show Smile Design, Settings, or AI Logs. Log in as dentist — all items visible.</verify>
  <done>PerioToothData has new fields with backward compatibility. Hygienist sees filtered sidebar. Dentist sidebar unchanged.</done>
</task>

</tasks>

<verification>
- `pnpm --filter @dentflow/web build` passes
- `pnpm db:generate` succeeds
- Hygienist login shows filtered nav (no Smile Design, no Settings, no AI Logs)
- Dentist login shows full nav (all items)
- PerioToothData type includes suppuration, mucogingivalJunction, keratinizedTissueWidth, implant, missing
</verification>

<success_criteria>
All new schema models created, PerioToothData extended with backward compatibility, role-based sidebar filtering works for HYGIENIST vs DENTIST, hygienist test account seeded.
</success_criteria>

<output>
After completion, create `.planning/phases/10-hygienist-portal-periodontogram/10-01-SUMMARY.md`
</output>
